// t3d-3dtiles
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("t3d")):"function"==typeof define&&define.amd?define(["exports","t3d"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).t3d=e.t3d||{},e.t3d)}(this,(function(e,t){"use strict";const s=e=>{let t;try{t=new URL(e,"http://fakehost.com/")}catch(e){return null}const s=t.pathname.split("/").pop(),r=s.lastIndexOf(".");if(-1===r||r===s.length-1)return null;return s.substring(r+1)},r=(e,t=null,s=null,n=null,i=0)=>{if(t&&t(e,n,i))return void(s&&s(e,n,i));const o=e.children;for(let n=0,a=o.length;n<a;n++)r(o[n],t,s,e,i+1);s&&s(e,n,i)},n=(e,t,s,r,i=null)=>{const{activeTiles:o}=t,u=e.cached.boundingVolume;if(null===i&&(i=c,l.copy(t.worldMatrix).inverse(),i.copy(s).applyMatrix4(l)),!e.__used||!u.intersectsRay(i))return;o.has(e)&&a(e,s,r);const d=e.children;for(let e=0,o=d.length;e<o;e++)n(d[e],t,s,r,i)},i=(e,t,s,r=null)=>{const{activeTiles:n}=t;null===r&&(r=c,l.copy(t.worldMatrix).inverse(),r.copy(s).applyMatrix4(l));const h=[],p=e.children;for(let e=0,n=p.length;e<n;e++){const n=p[e];if(!n.__used)continue;n.cached.boundingVolume.intersectRay(r,u)&&(u.applyMatrix4(t.worldMatrix),h.push({distance:u.distanceToSquared(s.origin),tile:n}))}h.sort(o);let m=null,f=1/0;if(n.has(e)&&(a(e,s,d),d.length>0)){d.length>1&&d.sort(o);const e=d[0];d.length=0,m=e,f=e.distance*e.distance}for(let e=0,n=h.length;e<n;e++){const n=h[e],o=n.distance,a=n.tile;if(o>f)break;const l=i(a,t,s,r);if(l){const e=l.distance*l.distance;e<f&&(m=l,f=e)}}return m},o=(e,t)=>e.distance-t.distance,a=(e,t,s)=>{const r=e.cached.scene,n=s.length;r.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,s)}));const i=s.length;if(i>n)for(let t=n;t<i;t++)s[t].tile=e},l=new t.Matrix4,c=new t.Ray,u=new t.Vector3,d=[];var h=Object.freeze({UNLOADED:0,LOADING:1,PARSING:2,LOADED:3,FAILED:4});class p extends t.Frustum{constructor(){super(),this.points=new Array(8).fill().map((()=>new t.Vector3))}updateCache(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach(((e,s)=>{!function(e,t,s,r){const n=m.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,s.normal.x,s.normal.y,s.normal.z);r.set(-e.constant,-t.constant,-s.constant),r.applyMatrix3(n.inverse())}(e[0],e[1],e[2],t[s])}))}}const m=new t.Matrix3;class f{constructor(){this._cameras=[],this._resolution=new t.Vector2,this._infos=[]}add(e){const t=this._cameras;return-1===t.indexOf(e)&&(t.push(e),!0)}remove(e){const t=this._cameras,s=t.indexOf(e);return-1!==s&&(t.splice(s,1),!0)}setResolution(e,t){this._resolution.set(e,t)}updateInfos(e){const s=this._cameras,r=s.length,n=this._infos,i=this._resolution;if(0===r)return void console.warn("CameraList.updateInfos(): No camera added.");for(;n.length>s.length;)n.pop();for(;n.length<s.length;)n.push({frustum:new p,isOrthographic:!1,sseDenominator:-1,position:new t.Vector3,invScale:-1,pixelSize:0});g.copy(e).inverse();const o=b.setFromMatrixColumn(g,0).getLength(),a=b.setFromMatrixColumn(g,1).getLength(),l=b.setFromMatrixColumn(g,2).getLength();Math.abs(Math.max(o-a,o-l))>1e-6&&console.warn("CameraList.updateInfos(): Non uniform scale used for tile which may cause issues when calculating screen space error.");const c=o,u=g;for(let t=0,r=n.length;t<r;t++){const r=s[t],o=n[t],a=i.x*(r.rect.z-r.rect.x),l=i.y*(r.rect.w-r.rect.y);0!==a&&0!==l||console.warn("CameraList.updateInfos(): Resolution for camera error calculation is not set.");const d=r.projectionMatrix.elements;if(o.isOrthographic=1===d[15],o.isOrthographic){const e=2/d[0],t=2/d[5];o.pixelSize=Math.max(t/l,e/a)}else o.sseDenominator=2/d[5]/l;o.invScale=c,_.copy(e).premultiply(r.projectionViewMatrix),o.frustum.setFromMatrix(_),o.frustum.updateCache(),o.position.setFromMatrixPosition(r.worldMatrix).applyMatrix4(u)}}getInfos(){return this._infos}}const g=new t.Matrix4,_=new t.Matrix4,b=new t.Vector3;class A{constructor(e=new t.Box3,s=new t.Matrix3){this.box=e,this.rotation=s}setFromCenterAndAxes(e,t,s,r){y.copy(t),T.copy(s),w.copy(r);const n=y.getLength(),i=T.getLength(),o=w.getLength();y.normalize(),T.normalize(),w.normalize(),0===n&&y.crossVectors(T,w),0===i&&T.crossVectors(y,w),0===o&&w.crossVectors(y,T),this.rotation.set(y.x,T.x,w.x,y.y,T.y,w.y,y.z,T.z,w.z);const a=y.set(n,i,o);return this.box.min.copy(e).sub(a),this.box.max.copy(e).add(a),this}applyMatrix4(e){const t=e.elements;let s=y.set(t[0],t[1],t[2]).getLength();const r=y.set(t[4],t[5],t[6]).getLength(),n=y.set(t[8],t[9],t[10]).getLength();e.determinant()<0&&(s=-s),M.setFromMatrix4(e);const i=1/s,o=1/r,a=1/n;M.elements[0]*=i,M.elements[1]*=i,M.elements[2]*=i,M.elements[3]*=o,M.elements[4]*=o,M.elements[5]*=o,M.elements[6]*=a,M.elements[7]*=a,M.elements[8]*=a,this.rotation.multiply(M);const l=this.box.getCenter(y),c=this.box.getSize(T).multiplyScalar(.5);return c.x*=s,c.y*=r,c.z*=n,l.applyMatrix4(e),this.box.min.copy(l).sub(c),this.box.max.copy(l).add(c),this}getPoints(e){const t=this.box.getCenter(y),s=T.subVectors(this.box.min,t),r=w.subVectors(this.box.max,t);let n=0;for(let i=-1;i<=1;i+=2)for(let o=-1;o<=1;o+=2)for(let a=-1;a<=1;a+=2)e[n].set(i<0?s.x:r.x,o<0?s.y:r.y,a<0?s.z:r.z).applyMatrix3(this.rotation).add(t),n++;return e}getPlanes(e){const t=this.box.getCenter(y),s=T.subVectors(this.box.min,t).applyMatrix3(this.rotation).add(t),r=w.subVectors(this.box.max,t).applyMatrix3(this.rotation).add(t);return y.set(0,0,1).applyMatrix3(this.rotation).normalize(),e[0].setFromNormalAndCoplanarPoint(y,s),e[1].setFromNormalAndCoplanarPoint(y,r),e[1].normal.negate(),e[1].constant*=-1,y.set(0,1,0).applyMatrix3(this.rotation).normalize(),e[2].setFromNormalAndCoplanarPoint(y,s),e[3].setFromNormalAndCoplanarPoint(y,r),e[3].normal.negate(),e[3].constant*=-1,y.set(1,0,0).applyMatrix3(this.rotation).normalize(),e[4].setFromNormalAndCoplanarPoint(y,s),e[5].setFromNormalAndCoplanarPoint(y,r),e[5].normal.negate(),e[5].constant*=-1,e}containsPoint(e){const t=O(this,S),s=y.subVectors(e,t.c);return Math.abs(s.dot(t.u[0]))<=t.e[0]&&Math.abs(s.dot(t.u[1]))<=t.e[1]&&Math.abs(s.dot(t.u[2]))<=t.e[2]}clampPoint(e,t){const s=O(this,S),r=y.subVectors(e,s.c);t.copy(s.c);const n=Math.max(Math.min(r.dot(s.u[0]),s.e[0]),-s.e[0]);t.add(s.u[0].multiplyScalar(n));const i=Math.max(Math.min(r.dot(s.u[1]),s.e[1]),-s.e[1]);t.add(s.u[1].multiplyScalar(i));const o=Math.max(Math.min(r.dot(s.u[2]),s.e[2]),-s.e[2]);return t.add(s.u[2].multiplyScalar(o)),t}intersectsSphere(e){return this.clampPoint(e.center,x),x.distanceToSquared(e.center)<=e.radius*e.radius}intersectsOBB(e,t=Number.EPSILON){O(this,S),O(e,C);for(let e=0;e<3;e++)for(let t=0;t<3;t++)R[e][t]=S.u[e].dot(C.u[t]);const s=y.subVectors(C.c,S.c);E[0]=s.dot(S.u[0]),E[1]=s.dot(S.u[1]),E[2]=s.dot(S.u[2]);for(let e=0;e<3;e++)for(let s=0;s<3;s++)L[e][s]=Math.abs(R[e][s])+t;let r,n;for(let e=0;e<3;e++)if(r=S.e[e],n=C.e[0]*L[e][0]+C.e[1]*L[e][1]+C.e[2]*L[e][2],Math.abs(E[e])>r+n)return!1;for(let e=0;e<3;e++)if(r=S.e[0]*L[0][e]+S.e[1]*L[1][e]+S.e[2]*L[2][e],n=C.e[e],Math.abs(E[0]*R[0][e]+E[1]*R[1][e]+E[2]*R[2][e])>r+n)return!1;return r=S.e[1]*L[2][0]+S.e[2]*L[1][0],n=C.e[1]*L[0][2]+C.e[2]*L[0][1],!(Math.abs(E[2]*R[1][0]-E[1]*R[2][0])>r+n)&&(r=S.e[1]*L[2][1]+S.e[2]*L[1][1],n=C.e[0]*L[0][2]+C.e[2]*L[0][0],!(Math.abs(E[2]*R[1][1]-E[1]*R[2][1])>r+n)&&(r=S.e[1]*L[2][2]+S.e[2]*L[1][2],n=C.e[0]*L[0][1]+C.e[1]*L[0][0],!(Math.abs(E[2]*R[1][2]-E[1]*R[2][2])>r+n)&&(r=S.e[0]*L[2][0]+S.e[2]*L[0][0],n=C.e[1]*L[1][2]+C.e[2]*L[1][1],!(Math.abs(E[0]*R[2][0]-E[2]*R[0][0])>r+n)&&(r=S.e[0]*L[2][1]+S.e[2]*L[0][1],n=C.e[0]*L[1][2]+C.e[2]*L[1][0],!(Math.abs(E[0]*R[2][1]-E[2]*R[0][1])>r+n)&&(r=S.e[0]*L[2][2]+S.e[2]*L[0][2],n=C.e[0]*L[1][1]+C.e[1]*L[1][0],!(Math.abs(E[0]*R[2][2]-E[2]*R[0][2])>r+n)&&(r=S.e[0]*L[1][0]+S.e[1]*L[0][0],n=C.e[1]*L[2][2]+C.e[2]*L[2][1],!(Math.abs(E[1]*R[0][0]-E[0]*R[1][0])>r+n)&&(r=S.e[0]*L[1][1]+S.e[1]*L[0][1],n=C.e[0]*L[2][2]+C.e[2]*L[2][0],!(Math.abs(E[1]*R[0][1]-E[0]*R[1][1])>r+n)&&(r=S.e[0]*L[1][2]+S.e[1]*L[0][2],n=C.e[0]*L[2][1]+C.e[1]*L[2][0],!(Math.abs(E[1]*R[0][2]-E[0]*R[1][2])>r+n)))))))))}toBoundingBoxWithTransform(e,t){const s=this.box.getCenter(y);e.min.copy(this.box.min).sub(s),e.max.copy(this.box.max).sub(s);const r=this.rotation.elements;t.set(r[0],r[3],r[6],s.x,r[1],r[4],r[7],s.y,r[2],r[5],r[8],s.z,0,0,0,1)}}const x=new t.Vector3,y=new t.Vector3,T=new t.Vector3,w=new t.Vector3,M=new t.Matrix3,R=[[],[],[]],L=[[],[],[]],E=[],v=new t.Vector3,S={c:new t.Vector3,u:[new t.Vector3,new t.Vector3,new t.Vector3],e:[]},C={c:new t.Vector3,u:[new t.Vector3,new t.Vector3,new t.Vector3],e:[]};function O(e,t){e.box.getCenter(t.c);const s=e.rotation.elements;return t.u[0].fromArray(s,0),t.u[1].fromArray(s,3),t.u[2].fromArray(s,6),e.box.getSize(v).multiplyScalar(.5).toArray(t.e),t}class I extends A{constructor(){super(),this._points=new Array(8).fill().map((()=>new t.Vector3)),this._planes=new Array(6).fill().map((()=>new t.Plane)),this._originBox=new t.Box3,this._originBoxTransform=new t.Matrix4,this._originBoxTransformInverse=new t.Matrix4}updateCache(){this.getPoints(this._points),this.getPlanes(this._planes),this.toBoundingBoxWithTransform(this._originBox,this._originBoxTransform),this._originBoxTransformInverse.copy(this._originBoxTransform).inverse()}containsPoint(e){return N.copy(e).applyMatrix4(this._originBoxTransformInverse),this.box.containsPoint(N)}intersectsRay(e){return P.copy(e).applyMatrix4(this._originBoxTransformInverse),P.intersectsBox(this._originBox)}intersectRay(e,t){return P.copy(e).applyMatrix4(this._originBoxTransformInverse),P.intersectBox(this._originBox,t)?t.applyMatrix4(this._originBoxTransform):null}intersectsFrustum(e){for(let t=0;t<6;t++){const s=e.planes[t];let r=-1/0;for(let e=0;e<8;e++){const t=this._points[e],n=s.distanceToPoint(t);r=r<n?n:r}if(r<0)return!1}for(let t=0;t<6;t++){const s=this._planes[t];let r=-1/0;for(let t=0;t<8;t++){const n=e.points[t],i=s.distanceToPoint(n);r=r<i?i:r}if(r<0)return!1}return!0}distanceToPoint(e){return N.copy(e).applyMatrix4(this._originBoxTransformInverse),this._originBox.distanceToPoint(N)}getBoundingSphere(e){return this.box.getBoundingSphere(e)}getBoundingBox(e){return e.setFromPoints(this._points)}}const P=new t.Ray,N=new t.Vector3;class B{constructor(e=new t.Vector3(1,1,1)){this.name="",this.radius=e}getEastNorthUpFrame(e,t,s){return this.getEastNorthUpAxes(e,t,H,$,K,X),s.makeBasis(H,$,K).setPosition(X)}getEastNorthUpAxes(e,t,s,r,n,i=X){this.getCartographicToPosition(e,t,0,i),this.getCartographicToNormal(e,t,n),s.set(-i.y,i.x,0).normalize(),r.crossVectors(n,s).normalize()}getRotationMatrixFromAzElRoll(e,t,s,r,n,i,o=Y){return this.getEastNorthUpFrame(e,t,k),G.set(r,n,-s,"ZXY"),i.makeRotationFromEuler(G).premultiply(k).setPosition(0,0,0),console.log(i.elements[0]),o===q?(G.set(Math.PI/2,0,0,"XYZ"),z.makeRotationFromEuler(G),i.multiply(z)):o===Q&&(G.set(-Math.PI/2,0,Math.PI,"XYZ"),z.makeRotationFromEuler(G),i.multiply(z)),i}getCartographicToPosition(e,t,s,r){this.getCartographicToNormal(e,t,D);const n=this.radius;F.copy(D),F.x*=n.x**2,F.y*=n.y**2,F.z*=n.z**2;const i=Math.sqrt(D.dot(F));return F.multiplyScalar(1/i),r.copy(F).addScaledVector(D,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,F),this.getPositionToNormal(e,D);const s=V.subVectors(e,F);return t.lon=Math.atan2(D.y,D.x),t.lat=Math.asin(D.z),t.height=Math.sign(s.dot(e))*s.getLength(),t}getCartographicToNormal(e,t,s){return U.set(1,-e+Math.PI/2,t),s.setFromSpherical(U).normalize(),function(e){const{x:t,y:s,z:r}=e;e.x=r,e.y=t,e.z=s}(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,r=1/s.x**2,n=1/s.y**2,i=1/s.z**2,o=e.x*e.x*r,a=e.y*e.y*n,l=e.z*e.z*i,c=o+a+l,u=Math.sqrt(1/c),d=F.copy(e).multiplyScalar(u);if(c<W)return isFinite(u)?t.copy(d):null;const h=V.set(d.x*r*2,d.y*n*2,d.z*i*2);let p,m,f,g,_,b,A,x,y,T,w,M=(1-u)*e.getLength()/(.5*h.getLength()),R=0;do{M-=R,f=1/(1+M*r),g=1/(1+M*n),_=1/(1+M*i),b=f*f,A=g*g,x=_*_,y=b*f,T=A*g,w=x*_,p=o*b+a*A+l*x-1,m=o*y*r+a*T*n+l*w*i;R=p/(-2*m)}while(Math.abs(p)>j);return t.set(e.x*f,e.y*g,e.z*_)}copy(e){return this.radius.copy(e.radius),this}clone(){return(new this.constructor).copy(this)}}const U=new t.Spherical,D=new t.Vector3,F=new t.Vector3,V=new t.Vector3,k=new t.Matrix4,z=new t.Matrix4,G=new t.Euler,H=new t.Vector3,$=new t.Vector3,K=new t.Vector3,X=new t.Vector3,j=1e-12,W=.1,Y=0,q=1,Q=2;class J extends B{constructor(e=new t.Vector3(1,1,1),s=new t.Vector2(-ie,ie),r=new t.Vector2(0,2*ne),n=new t.Vector2(0,1)){super(e),this.latRange=s,this.lonRange=r,this.heightRange=n}getOrientedBoundingBox(e){ue();const{latRange:t,lonRange:s}=this;if(t.y-t.x<ne/2){const e=oe(.5,0,1,t.x,t.y),r=oe(.5,0,1,s.x,s.y);this.getCartographicToNormal(e,r,te),ee.set(0,0,1),Z.crossVectors(ee,te),ee.crossVectors(Z,te)}else Z.set(1,0,0),ee.set(0,1,0),te.set(0,0,1);e.rotation.set(Z.x,ee.x,te.x,Z.y,ee.y,te.y,Z.z,ee.z,te.z),re.setFromMatrix3(e.rotation).inverse();const r=this._getPoints(!0);se.set(0,0,0);for(let e=0,t=r.length;e<t;e++)se.add(r[e]);se.multiplyScalar(1/r.length);for(let e=0,t=r.length;e<t;e++)r[e].sub(se).applyMatrix4(re).add(se);e.box.makeEmpty(),e.box.setFromPoints(r)}getBoundingSphere(e){ue();const t=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(t)}_getPoints(e=!1){const{latRange:t,lonRange:s,heightRange:r}=this,n=oe(.5,0,1,t.x,t.y),i=oe(.5,0,1,s.x,s.y),o=Math.floor(s.x/ie)*ie,a=[[-ne/2,0],[ne/2,0],[0,o],[0,o+ne/2],[0,o+ne],[0,o+3*ne/2],[t.x,s.y],[t.y,s.y],[t.x,s.x],[t.y,s.x],[0,s.x],[0,s.y],[n,i],[t.x,i],[t.y,i],[n,s.x],[n,s.y]],l=[],c=a.length;for(let n=0;n<=1;n++){const i=oe(n,0,1,r.x,r.y);for(let r=0,n=c;r<n;r++){const[n,o]=a[r];if(n>=t.x&&n<=t.y&&o>=s.x&&o<=s.y){const t=ce(e);l.push(t),this.getCartographicToPosition(n,o,i,t)}}}return l}}const Z=new t.Vector3,ee=new t.Vector3,te=new t.Vector3,se=new t.Vector3,re=new t.Matrix4,ne=Math.PI,ie=ne/2;function oe(e,t,s,r,n){return r+(e-t)*(n-r)/(s-t)}let ae=0;const le=[];function ce(e=!1){return e?(le[ae]||(le[ae]=new t.Vector3),ae++,le[ae-1]):new t.Vector3}function ue(){ae=0}class de{constructor(){this.sphere=null,this.obb=null,this.region=null}setOBBData(e,t){const s=new I;s.setFromCenterAndAxes(ge.set(e[0],e[1],e[2]),pe.set(e[3],e[4],e[5]),me.set(e[6],e[7],e[8]),fe.set(e[9],e[10],e[11])).applyMatrix4(t),s.updateCache(),this.obb=s}setSphereData(e,s){const r=new t.Sphere;r.center.set(e[0],e[1],e[2]),r.radius=e[3],r.applyMatrix4(s),this.sphere=r}setRegionData(e,s,r,n,i,o){const a=new J(he.clone(),new t.Vector2(s,n),new t.Vector2(e,r),new t.Vector2(i,o));this.region=a;const l=new I;a.getOrientedBoundingBox(l),l.updateCache(),this.obb=l}intersectsRay(e){const t=this.sphere,s=this.obb;return!(t&&!e.intersectsSphere(t))&&!(s&&!s.intersectsRay(e))}intersectRay(e,t){const s=this.sphere,r=this.obb;let n=-1/0,i=-1/0;s&&e.intersectSphere(s,pe)&&(n=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(pe)),r&&r.intersectRay(e,pe)&&(i=r.containsPoint(e.origin)?0:e.origin.distanceToSquared(pe));const o=Math.max(n,i);return o===-1/0?null:e.at(Math.sqrt(o),t)}distanceToPoint(e){const t=this.sphere,s=this.obb;let r=-1/0,n=-1/0;return t&&(r=Math.max(t.distanceToPoint(e),0)),s&&(n=s.distanceToPoint(e)),r>n?r:n}intersectsFrustum(e){const t=this.sphere;if(t&&!e.intersectsSphere(t))return!1;const s=this.obb;return!(s&&!s.intersectsFrustum(e))&&Boolean(t||s)}getOrientedBoundingBox(e,t){this.obb?(e.copy(this.obb._originBox),t.copy(this.obb._originBoxTransform)):(this.getBoundingBox(e),t.identity())}getBoundingBox(e){return this.sphere?this.sphere.getBoundingBox(e):this.obb.getBoundingBox(e)}getBoundingSphere(e){return this.sphere?e.copy(this.sphere):this.obb.getBoundingSphere(e)}}const he=new t.Vector3(6378137,6378137,6356752.314245179),pe=new t.Vector3,me=new t.Vector3,fe=new t.Vector3,ge=new t.Vector3;class _e{constructor({maxSize:e=800,minSize:t=600,unloadPercent:s=.05,unloadPriorityCallback:r=be}){this.maxSize=e,this.minSize=t,this.unloadPercent=s,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.scheduled=!1,this.unloadPriorityCallback=r}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const s=this.itemSet;if(s.has(e))return!1;if(this.isFull())return!1;const r=this.usedSet,n=this.itemList,i=this.callbacks;return n.push(e),r.add(e),s.set(e,Date.now()),i.set(e,t),!0}remove(e){const t=this.usedSet,s=this.itemSet,r=this.itemList,n=this.callbacks;if(s.has(e)){n.get(e)(e);const i=r.indexOf(e);return r.splice(i,1),t.delete(e),s.delete(e),n.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,s=this.usedSet;return!(!t.has(e)||s.has(e))&&(t.set(e,Date.now()),s.add(e),!0)}markAllUnused(){this.usedSet.clear()}unloadToMinSize(){const e=this.unloadPercent,t=this.minSize,s=this.itemList,r=this.itemSet,n=this.usedSet,i=this.callbacks,o=s.length-n.size,a=s.length-t,l=this.unloadPriorityCallback;if(a<=0||o<=0)return!1;s.sort(((e,t)=>{const s=n.has(e),i=n.has(t);return s&&i?0:s||i?s?1:-1:l(r,t)-l(r,e)}));const c=Math.min(a,o),u=Math.max(t*e,c*e);let d=Math.min(u,o);d=Math.ceil(d);const h=s.splice(0,d);for(let e=0,t=h.length;e<t;e++){const t=h[e];i.get(t)(t),r.delete(t),i.delete(t)}return!0}scheduleUnload(e=!0){if(this.scheduled)return!1;this.scheduled=!0,Ae((()=>{this.scheduled=!1,this.unloadToMinSize(),e&&this.markAllUnused()}))}}const be=(e,t)=>e.get(t),Ae=e=>{Promise.resolve().then(e)};class xe{constructor({maxJobs:e=6,autoUpdate:t=!0,priorityCallback:s=ye}){this.maxJobs=e,this.autoUpdate=t,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.priorityCallback=s,this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}schedulingCallback(e){requestAnimationFrame(e)}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((s,r)=>{const n=this.items,i=this.callbacks;n.push(e),i.set(e,((...e)=>t(...e).then(s).catch(r))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,s=this.callbacks,r=t.indexOf(e);-1!==r&&(t.splice(r,1),s.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let r=this.currJobs;for(;s>r&&e.length>0;){r++;const s=e.pop(),n=t.get(s);t.delete(s),n(s).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=r}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs.bind(this)),this.scheduled=!0)}}const ye=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")};class Te{constructor(){this.lruCache=new _e({unloadPriorityCallback:we}),this.downloadQueue=new xe({maxJobs:4,priorityCallback:Me}),this.parseQueue=new xe({maxJobs:1,priorityCallback:Me})}preprocessTileSet(e,t,s=null){const n=e.asset.version,[i,o]=n.split(".").map((e=>parseInt(e)));console.assert(i<=1,"TilesLoader: asset.version is expected to be a 1.x or a compatible version."),1===i&&o>0&&console.warn("TilesLoader: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=t.replace(/\/[^/]*$/,"");a=new URL(a,window.location.href).toString(),r(e.root,((e,t)=>Re(e,t,a)),null,s,s?s.__depth:0)}requestTileContents(e,t){if(e.__loadingState!==h.UNLOADED)return;const r=t.stats,n=this.lruCache,i=this.downloadQueue,o=this.parseQueue,a=e.__externalTileSet;n.add(e,(e=>{e.__loadingState===h.LOADING?(e.__loadAbort.abort(),e.__loadAbort=null):a?e.children.length=0:t.$disposeTile(e),e.__loadingState===h.LOADING?r.downloading--:e.__loadingState===h.PARSING&&r.parsing--,e.__loadingState=h.UNLOADED,e.__loadIndex++,i.remove(e),o.remove(e)})),e.__loadIndex++;const l=e.__loadIndex,c=new AbortController,u=c.signal;r.downloading++,e.__loadAbort=c,e.__loadingState=h.LOADING;const d=t=>{e.__loadIndex===l&&("AbortError"!==t.name?(i.remove(e),o.remove(e),e.__loadingState===h.PARSING?r.parsing--:e.__loadingState===h.LOADING&&r.downloading--,r.failed++,e.__loadingState=h.FAILED,"Failed to fetch"!==t.message&&(console.error(`TilesLoader: Failed to load tile at url "${e.content.uri}".`),console.error(t))):n.remove(e))};let p=e.content.uri;t.invokeAllPlugins((t=>p=t.preprocessURL?t.preprocessURL(p,e):p)),a?i.add(e,(e=>e.__loadIndex!==l?Promise.resolve():t.invokeOnePlugin((e=>e.fetchData&&e.fetchData(p,{...t.fetchOptions,signal:u}))))).then((e=>{if(e.ok)return e.json();throw new Error(`TilesLoader: Failed to load tileset "${p}" with status ${e.status} : ${e.statusText}`)})).then((t=>(this.preprocessTileSet(t,p,e),t))).then((s=>{e.__loadIndex===l&&(r.downloading--,e.__loadAbort=null,e.__loadingState=h.LOADED,e.children.push(s.root),t.dispatchEvent({type:"load-tile-set",tileSet:s,url:p}))})).catch(d):i.add(e,(e=>e.__loadIndex!==l?Promise.resolve():t.invokeOnePlugin((e=>e.fetchData&&e.fetchData(p,{...t.fetchOptions,signal:u}))))).then((t=>{if(e.__loadIndex===l){if(t.ok){return"gltf"===s(t.url)?t.json():t.arrayBuffer()}throw new Error(`Failed to load model with error code ${t.status}`)}})).then((n=>{if(e.__loadIndex===l)return r.downloading--,r.parsing++,e.__loadAbort=null,e.__loadingState=h.PARSING,o.add(e,(e=>{if(e.__loadIndex!==l)return Promise.resolve();const r=e.content.uri,i=s(r);return t.$parseTile(n,e,i)}))})).then((()=>{e.__loadIndex===l&&(r.parsing--,e.__loadingState=h.LOADED,e.__wasSetVisible&&t.$setTileVisible(e,!0),e.__wasSetActive&&t.$setTileActive(e,!0))})).catch(d)}}const we=(e,t)=>1/(t.__depthFromRenderedParent+1),Me=(e,t)=>e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,Re=(e,r,n)=>{e.contents&&(e.content=e.contents[0]),e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.uri&&(e.content.uri=`${n}/${e.content.uri}`),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=r,e.children=e.children||[];if(e.content&&e.content.uri){const t=s(e.content.uri),r=Boolean(t&&"json"===t.toLowerCase());e.__externalTileSet=r,e.__contentEmpty=r}else e.__externalTileSet=!1,e.__contentEmpty=!0;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=h.UNLOADED,e.__loadIndex=0,e.__loadAbort=null,e.__depthFromRenderedParent=-1,null===r?(e.__depth=0,e.refine=e.refine||"REPLACE"):(e.__depth=r.__depth+1,e.refine=e.refine||r.refine);const i=new t.Matrix4;e.transform&&i.fromArray(e.transform),r&&i.premultiply(r.cached.transform);const o=(new t.Matrix4).copy(i).inverse(),a=Le.setFromMatrixScale(i),l=Math.max(a.x,a.y,a.z);let c=e.geometricError*l;const u=new de;"box"in e.boundingVolume&&u.setOBBData(e.boundingVolume.box,i),"sphere"in e.boundingVolume&&u.setSphereData(e.boundingVolume.sphere,i),"region"in e.boundingVolume&&(u.setRegionData(...e.boundingVolume.region),c=e.geometricError),e.cached={loadIndex:0,transform:i,transformInverse:o,geometricError:c,boundingVolume:u,active:!1,inFrustum:[],scene:null,geometry:null,material:null,featureTable:null,batchTable:null}},Le=new t.Vector3;class Ee extends t.Loader{constructor(e){super(e),"undefined"==typeof createImageBitmap&&console.warn("ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,t,s,r){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const n=this,i={};i.credentials="anonymous"===this.crossOrigin?"same-origin":"include",i.headers=this.requestHeader,fetch(e,i).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,Object.assign(n.options,{colorSpaceConversion:"none"}))})).then((function(s){t&&t(s),n.manager.itemEnd(e)})).catch((function(t){r&&r(t),n.manager.itemError(e),n.manager.itemEnd(e)})),n.manager.itemStart(e)}}const ve=new t.Vector4;class Se{constructor(){}static extractUrlBase(e){const t=e.split("/");return t.pop(),(t.length<1?".":t.join("/"))+"/"}static resolveURL(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)||/^data:/i.test(e)||/^blob:/i.test(e)?e:t+e}static decodeText(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let s=0,r=e.length;s<r;s++)t+=String.fromCharCode(e[s]);try{return decodeURIComponent(escape(t))}catch(e){return t}}static parseGLB(e){const t=1313821514,s=5130562,r=new DataView(e),n={magic:r.getUint32(0,!0),version:r.getUint32(4,!0),length:r.getUint32(8,!0)};if(1179937895!==n.magic)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+n.magic.toString(16)),null;n.version<2&&console.error("GLTFLoader: Legacy binary file detected.");let i=r.getUint32(12,!0),o=r.getUint32(16,!0);if(o!==t)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+o.toString(16)),null;const a=new Uint8Array(e,20,i),l=JSON.parse(Se.decodeText(a)),c=[];let u=20+i;for(;u<n.length;){if(i=r.getUint32(u,!0),o=r.getUint32(u+4,!0),o!==s)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;const t=u+8,n=e.slice(t,t+i);c.push(n),u+=i+8}return{gltf:l,buffers:c}}static getNormalizedComponentScale(e){if(e===Int8Array)return 1/127;if(e===Uint8Array)return 1/255;if(e===Int16Array)return 1/32767;if(e===Uint16Array)return 1/65535;throw new Error("Unsupported normalized accessor component type.")}static normalizeSkinWeights(e){const t=e.offset,s=e.buffer,r=s.stride;for(let e=0,n=s.count;e<n;e++){ve.fromArray(s.array,e*r+t);const n=1/ve.getManhattanLength();n!==1/0?ve.multiplyScalar(n):ve.set(1,0,0,0),ve.toArray(s.array,e*r+t)}}}class Ce{static parse(e,t){const{gltf:s,path:r}=e,{nodes:n=[],skins:i=[],meshes:o=[],buffers:a,images:l}=s;if(i.forEach((e=>{const{joints:t=[]}=e;t.forEach((e=>{n[e].isBone=!0}))})),n.forEach((e=>{void 0!==e.mesh&&void 0!==e.skin&&(o[e.mesh].isSkinned=!0)})),t.detailLoadProgress){const s=new Set;a&&a.forEach((e=>{if(!e.uri)return;const t=Se.resolveURL(e.uri,r);s.add(t)})),l&&l.forEach(((e,t)=>{const{uri:n,bufferView:i}=e;let o=n;void 0!==i&&(o="blob<"+t+">"),o=Se.resolveURL(o,r),s.add(o)})),s.forEach((e=>t.manager.itemStart(e))),e.loadItems=s}}}class Oe{static parse(e){const{gltf:{asset:{version:t}}}=e,s=Number(t);if(!(s>=2&&s<3))throw"Only support gltf 2.x."}}class Ie{static parse(e,t){const{gltf:s,loadItems:r}=e;return null!==e.buffers?null:Promise.all(s.buffers.map((s=>{const n=Se.resolveURL(s.uri,e.path);t.detailLoadProgress&&r.delete(n);const i=t.loadFile(n,"arraybuffer").then((e=>(t.detailLoadProgress&&t.manager.itemEnd(n),e)));return t.detailLoadProgress&&i.catch((()=>t.manager.itemEnd(n))),i}))).then((t=>{e.buffers=t}))}}class Pe{static parse(e,t){const{buffers:s,gltf:r}=e;if(!r.bufferViews)return;const n=t.extensions.get("EXT_meshopt_compression");return Promise.all(r.bufferViews.map((e=>{const{buffer:r,byteOffset:i=0,byteLength:o=0}=e;if(e.extensions){const{EXT_meshopt_compression:r}=e.extensions;if(r&&n)return n.loadBufferView(r,s,t.getMeshoptDecoder())}return s[r].slice(i,i+o)}))).then((t=>{e.bufferViews=t}))}}class Ne{static parse(e,t){const{gltf:s,bufferViews:r,path:n,loadItems:i}=e;if(!s.images)return;const o=t.extensions.get("KHR_texture_basisu");return Promise.all(s.images.map(((e,s)=>{const{uri:a,bufferView:l,mimeType:c,name:u}=e;let d=!1,h=a||"";if(void 0!==l){const e=r[l],t=new Blob([e],{type:c});h=URL.createObjectURL(t),d=!0}const p=Se.resolveURL(h,n);let m;if(t.detailLoadProgress&&i.delete(p),c&&c.includes("ktx2")&&o)m=o.loadTextureData(p,t.getKTX2Loader()).then((e=>(t.detailLoadProgress&&(d?t.manager.itemEnd(Se.resolveURL("blob<"+s+">",n)):t.manager.itemEnd(p)),e)));else{const e={loader:t,imageUrl:p,imageName:u,isObjectURL:d,sourceUrl:h,index:s,path:n};if(!c||!c.includes("avif")&&!c.includes("webp"))return Be(e);m=function(e){const t=new Promise((t=>{const s=new Image;e.includes("avif")?s.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=":s.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",s.onload=()=>{t(1===s.height)}}));return t}(c).then((t=>{if(t)return Be(e);throw new Error("GLTFLoader: WebP or AVIF required by asset but unsupported.")}))}return t.detailLoadProgress&&m.catch((()=>t.manager.itemEnd(p))),m}))).then((t=>{e.images=t}))}}function Be(e){const{loader:t,imageUrl:s,imageName:r,isObjectURL:n,sourceUrl:i,index:o,path:a}=e;return t.loadImage(s).then((e=>(e.__name=r,!0===n&&URL.revokeObjectURL(i),t.detailLoadProgress&&(n?t.manager.itemEnd(Se.resolveURL("blob<"+o+">",a)):t.manager.itemEnd(s)),e)))}const Ue={POSITION:"a_Position",NORMAL:"a_Normal",TANGENT:"a_Tangent",TEXCOORD_0:"a_Uv",TEXCOORD_1:"a_Uv2",TEXCOORD_2:"a_Uv3",TEXCOORD_3:"a_Uv4",TEXCOORD_4:"a_Uv5",TEXCOORD_5:"a_Uv6",TEXCOORD_6:"a_Uv7",TEXCOORD_7:"a_Uv8",COLOR_0:"a_Color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex",TEXCOORD0:"a_Uv",TEXCOORD:"a_Uv",COLOR0:"a_Color",COLOR:"a_Color",WEIGHT:"skinWeight",JOINT:"skinIndex"},De="MASK",Fe="BLEND",Ve={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ke={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ze={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ge={9728:t.TEXTURE_FILTER.NEAREST,9729:t.TEXTURE_FILTER.LINEAR,9984:t.TEXTURE_FILTER.NEAREST_MIPMAP_NEAREST,9985:t.TEXTURE_FILTER.LINEAR_MIPMAP_NEAREST,9986:t.TEXTURE_FILTER.NEAREST_MIPMAP_LINEAR,9987:t.TEXTURE_FILTER.LINEAR_MIPMAP_LINEAR},He={33071:t.TEXTURE_WRAP.CLAMP_TO_EDGE,33648:t.TEXTURE_WRAP.MIRRORED_REPEAT,10497:t.TEXTURE_WRAP.REPEAT},$e=0,Ke=1,Xe=2,je=3,We=5,Ye=6;class qe{static parse(e){const{gltf:s,images:r}=e;if(!s.textures)return;const n=new Map;return Promise.all(s.textures.map(((e,i)=>{const{sampler:o,source:a=0,name:l}=e;let c=a,u=!1;if(e.extensions){const{KHR_texture_basisu:t}=e.extensions;t?(c=t.source,u=!0):Object.values(e.extensions).length&&Object.values(e.extensions)[0].hasOwnProperty("source")?c=Object.values(e.extensions)[0].source:console.warn("GLTFLoader: unknown texture extension")}const d=c+":"+o;if(n.has(d))return n.get(d);const h=new t.Texture2D;if(u){const{image:e,mipmaps:t,type:s,format:n,minFilter:i,magFilter:o,generateMipmaps:a,encoding:l,premultiplyAlpha:u}=r[c];h.image=e,h.mipmaps=t,h.type=s,h.format=n,h.minFilter=i,h.magFilter=o,h.generateMipmaps=a,h.encoding=l,h.premultiplyAlpha=u}else h.image=r[c];h.version++,h.name=l||h.image.__name||`texture_${i}`,h.flipY=!1;return function(e,s={}){const{magFilter:r,minFilter:n,wrapS:i,wrapT:o}=s;e.magFilter=Ge[r]||t.TEXTURE_FILTER.LINEAR,e.minFilter=Ge[n]||t.TEXTURE_FILTER.LINEAR_MIPMAP_LINEAR,e.wrapS=He[i]||t.TEXTURE_WRAP.REPEAT,e.wrapT=He[o]||t.TEXTURE_WRAP.REPEAT}(h,(s.samplers||{})[o]),n.set(d,h),h}))).then((t=>{e.textures=t,n.clear()}))}}class Qe{static parse(e){const{bufferViews:s,gltf:r}=e;if(!r.accessors)return;const n=new Map,i=r.accessors.map((e=>{const{bufferView:i,type:o,componentType:a,count:l,byteOffset:c=0,normalized:u=!1,sparse:d}=e;if(void 0===i&&void 0===d)return null;const h=void 0!==i?s[i]:null,p=void 0!==i?r.bufferViews[i].byteStride:void 0,m=ke[o],f=ze[a],g=f.BYTES_PER_ELEMENT;let _,b;if(p&&p!==g*m){const e=Math.floor(c/p),s="Buffer:"+i+":"+a+":"+e+":"+l;let r=n.get(s);r||(_=new f(h,e*p,l*p/g),r=new t.Buffer(_,p/g),n.set(s,r)),b=new t.Attribute(r,m,c%p/g,u)}else _=null===h?new f(l*m):new f(h,c,l*m),b=new t.Attribute(new t.Buffer(_,m),m,0,u);if(d){const e=ke.SCALAR,r=ze[d.indices.componentType],n=d.indices.byteOffset||0,i=d.values.byteOffset||0,o=new r(s[d.indices.bufferView],n,d.count*e),a=new f(s[d.values.bufferView],i,d.count*m);null!==h&&(b=new t.Attribute(b.buffer.clone(),b.size,b.offset,b.normalized));const l=b.buffer;for(let e=0,t=o.length;e<t;e++){const t=o[e];if(l.array[t*b.size]=a[e*m],m>=2&&(l.array[t*b.size+1]=a[e*m+1]),m>=3&&(l.array[t*b.size+2]=a[e*m+2]),m>=4&&(l.array[t*b.size+3]=a[e*m+3]),m>=5)throw new Error("Unsupported itemSize in sparse Attribute.")}}return b}));n.clear(),e.accessors=i}}let Je=class{static parse(e,s){const{gltf:r,accessors:n,materials:i,bufferViews:o}=e;if(!r.meshes)return;const a=s.extensions.get("KHR_draco_mesh_compression"),l=new Map,c=new Map,u=[];for(let e=0;e<r.meshes.length;e++){const d=r.meshes[e],h=[];for(let e=0;e<d.primitives.length;e++){const u=d.primitives[e],{extensions:p={},mode:m,material:f}=u,{KHR_draco_mesh_compression:g}=p;let _;const b=tt(u);c.has(b)?_=c.get(b):(_=g&&a?a.getGeometry(g,o,u.attributes,r.accessors,s.getDRACOLoader()):Promise.resolve(new t.Geometry),_=_.then((e=>(Ze(e,u,r,n),e))),c.set(b,_));const A=_.then((e=>{const s={mode:m,geometry:e,material:void 0===f?new t.PBRMaterial:i[f],weights:Object.keys(e.morphAttributes).length>0&&d.weights?d.weights.slice(0):void 0,skinned:d.isSkinned};return et(s,l),s}));h.push(A)}u.push(Promise.all(h))}return l.clear(),c.clear(),Promise.all(u).then((t=>{e.primitives=t}))}};function Ze(e,t,s,r){const{attributes:n,indices:i,targets:o}=t;for(const t in n){const s=n[t],i=void 0===Ue[t]?t:Ue[t];i in e.attributes||e.addAttribute(i,r[s])}void 0===i||e.index||e.setIndex(r[i]);const{boundingBox:a,boundingSphere:l}=e;if(void 0!==n.POSITION){const t=n.POSITION,r=s.accessors[t];if(r.min&&r.max){if(a.min.fromArray(r.min),a.max.fromArray(r.max),r.normalized){const e=Se.getNormalizedComponentScale(ze[r.componentType]);a.min.multiplyScalar(e),a.max.multiplyScalar(e)}}else e.computeBoundingBox()}else e.computeBoundingBox();if(a.getCenter(l.center),l.radius=a.min.distanceTo(a.max)/2,o){let t=!1,s=!1;for(let e=0,r=o.length;e<r;e++){const r=o[e];if(void 0!==r.POSITION&&(t=!0),void 0!==r.NORMAL&&(s=!0),t&&s)break}if(t||s){const n=[],i=[];for(let a=0,l=o.length;a<l;a++){const l=o[a];t&&n.push(void 0!==l.POSITION?r[l.POSITION]:e.attributes[Ue.POSITION]),s&&i.push(void 0!==l.NORMAL?r[l.NORMAL]:e.attributes[Ue.NORMAL])}t&&(e.morphAttributes.position=n),s&&(e.morphAttributes.normal=i)}}return e}function et(e,s){let{geometry:r,material:n,skinned:i,mode:o}=e;const a=void 0!==r.attributes[Ue.TANGENT],l=void 0!==r.attributes[Ue.COLOR_0],c=void 0===r.attributes[Ue.NORMAL],u=i;if(o===$e){const e="PointsMaterial:"+n.id;let r=s.get(e);r||(r=new t.PointsMaterial,t.Material.prototype.copy.call(r,n),r.diffuse.copy(n.diffuse),r.diffuseMap=n.map,r.drawMode=o,r.acceptLight=!1,s.set(e,r)),n=r}else if(o===Ke||o===je||o===Xe){const e="BasicMaterial:"+n.id;let r=s.get(e);r||(r=new t.BasicMaterial,r.envMap=void 0,r.diffuse.copy(n.diffuse),r.diffuseMap=n.diffuseMap,r.drawMode=o,s.set(e,r)),n=r}else o===We?(console.warn("TRIANGLE_STRIP will be removed later."),n.drawMode=We):o===Ye&&(console.warn("TRIANGLE_FAN will be removed later."),n.drawMode=Ye);if(a||l||c||u){let e="ClonedMaterial:"+n.id+":";a&&(e+="vertex-tangents:"),l&&(3===r.attributes[Ue.COLOR_0].size?e+="vertex-colors-rgb:":4===r.attributes[Ue.COLOR_0].size&&(e+="vertex-colors-rgba:")),c&&(e+="flat-shading:");let i=s.get(e);i||(i=n.clone(),a&&(i.vertexTangents=!0,i.normalMap&&(i.normalScale.y*=-1)),l&&(3===r.attributes[Ue.COLOR_0].size?i.vertexColors=t.VERTEX_COLOR.RGB:4===r.attributes[Ue.COLOR_0].size?i.vertexColors=t.VERTEX_COLOR.RGBA:console.warn("Illegal vertex color size: "+r.attributes[Ue.COLOR_0].size)),c&&(i.shading=t.SHADING_TYPE.FLAT_SHADING)),n=i}e.material=n}function tt(e){const t=e.extensions&&e.extensions.KHR_draco_mesh_compression;let s;if(s=t?"draco:"+t.bufferView+":"+t.indices+":"+st(t.attributes):e.indices+":"+st(e.attributes)+":"+e.mode,e.targets)for(let t=0,r=e.targets.length;t<r;t++)s+=":"+st(e.targets[t]);return s}function st(e){let t="";const s=Object.keys(e).sort();for(let r=0,n=s.length;r<n;r++)t+=s[r]+":"+e[s[r]]+";";return t}class rt{static parse(e,s){const{gltf:{nodes:r,cameras:n,extensions:i}}=e;if(!r)return;const o=s.extensions.get("KHR_lights_punctual"),a=s.extensions.get("EXT_mesh_gpu_instancing"),l=[],c=[],u=r.map((s=>{const{matrix:r,translation:u,rotation:d,scale:h,camera:p,mesh:m,extensions:f={}}=s,{KHR_lights_punctual:g,EXT_mesh_gpu_instancing:_}=f;let b=null;if(s.isBone)b=new t.Bone;else if(void 0!==m)b=_&&a?a.getInstancedMesh(e,s):function(e,s){const{primitives:r}=e,{mesh:n,skin:i}=s,o=r[n].map((e=>{const{geometry:s,material:r,weights:n}=e;let o;return void 0!==i?(o=new t.SkinnedMesh(s,r),s.attributes.skinWeight&&!s.attributes.skinWeight.normalized&&Se.normalizeSkinWeights(s.attributes.skinWeight)):(o=new t.Mesh(s,r),n&&(o.morphTargetInfluences=n.slice())),o}));if(o.length>1){const e=new t.Object3D;return o.forEach((t=>e.add(t))),e}return o[0]}(e,s);else if(void 0!==p)b=function(e){const{orthographic:s,perspective:r,type:n}=e,i=new t.Camera;if("perspective"==n){const{aspectRatio:e,yfov:t,zfar:s,znear:n}=r;i.setPerspective(t,e||1,n||1,s||2e6)}else if("orthographic"==n){const{xmag:e,ymag:t,zfar:r,znear:n}=s;i.setOrtho(-e,e,-t,t,n||1,r||2e6)}return i}(n[p]),l.push(b);else if(g&&o){const e=g.light,t=i.KHR_lights_punctual.lights;b=o.getLight(t[e]),c.push(b)}else b=new t.Object3D;if(b.name=s.name||"",b.name&&b.children.length>0)for(let e=0;e<b.children.length;e++)b.children[e].name=b.name+"_"+e;return void 0!==r?(b.matrix.fromArray(r),b.matrix.decompose(b.position,b.quaternion,b.scale)):(void 0!==u&&b.position.fromArray(u),void 0!==d&&b.quaternion.fromArray(d),void 0!==h&&b.scale.fromArray(h)),b}));e.nodes=u,e.cameras=l,e.lights=c}}class nt{static parse(e){const{gltf:s,accessors:r,nodes:n}=e,i=s.skins;if(!i)return;const o=i.map((e=>{const{inverseBindMatrices:s,joints:i}=e,o=r[s],a=[],l=[];return i.forEach(((e,s)=>{const r=n[e];if(r){a.push(r);const e=new t.Matrix4;o&&e.fromArray(o.buffer.array,16*s),l.push(e)}else console.warn("Joint "+e+" could not be found.")})),new t.Skeleton(a,l)}));e.skins=o,n.forEach(((e,t)=>{const{skin:r}=s.nodes[t];void 0!==r&&e.traverse((function(e){e.isSkinnedMesh&&e.bind(o[r],e.worldMatrix)}))}))}}class it{static parse(e){const{gltf:s,nodes:r}=e,n=s.scenes.map((e=>{const{name:n="",nodes:i=[]}=e,o=new t.Object3D;o.name=n;for(let e=0;e<i.length;e++)ot(i[e],o,s.nodes,r);return o}));e.roots=n,e.root=n[s.scene||0]}}function ot(e,t,s,r){const n=r[e],i=s[e];if(t.add(n),i.children){const e=i.children;for(let t=0,i=e.length;t<i;t++){ot(e[t],n,s,r)}}}class at{static parse(e){const{gltf:s,nodes:r,accessors:n}=e,{animations:i}=s;if(!i)return;const o=i.map(((e,s)=>{const{channels:i,samplers:o,name:a=`animation_${s}`}=e,l=[];let c=0;for(let e=0;e<i.length;e++){const s=i[e],a=o[s.sampler];if(a){const e=s.target,i=void 0!==e.node?e.node:e.id,o=n[a.input],u=n[a.output],d=r[i];if(!d)continue;let h;switch(d.updateMatrix(),d.matrixAutoUpdate=!0,Ve[e.path]){case Ve.rotation:h=t.QuaternionKeyframeTrack;break;case Ve.weights:h=t.NumberKeyframeTrack;break;default:h=t.VectorKeyframeTrack}if(!h)continue;const p=new o.buffer.array.constructor(o.buffer.array),m=new Float32Array(u.buffer.array);if(u.normalized){const e=Se.getNormalizedComponentScale(u.buffer.array.constructor);for(let t=0,s=m.length;t<s;t++)m[t]*=e}const f=[];Ve[e.path]===Ve.weights?d.traverse((function(e){e.isMesh&&e.morphTargetInfluences&&f.push(e)})):f.push(d);for(let s=0,r=f.length;s<r;s++){const r=lt(a.interpolation,h===t.QuaternionKeyframeTrack),n=new h(f[s],Ve[e.path],p,m,r);l.push(n)}const g=p[p.length-1];c<g&&(c=g)}}return new t.KeyframeClip(a,l,c)}));e.animations=o}}function lt(e,s){switch(e){case"STEP":return t.StepInterpolant;case"CUBICSPLINE":return s?t.QuaternionCubicSplineInterpolant:t.CubicSplineInterpolant;default:return s?t.QuaternionLinearInterpolant:t.LinearInterpolant}}let ct=0;class ut{constructor(){this.id=++ct,this.url="",this.path="",this.options=null,this.gltf=null,this.loadItems=null,this.buffers=null,this.bufferViews=null,this.images=null,this.textures=null,this.materials=null,this.accessors=null,this.primitives=null,this.nodes=null,this.cameras=null,this.lights=null,this.skins=null,this.root=null,this.roots=null,this.animations=null}}class dt{static getMaterial(){return new t.PBRMaterial}static parseParams(e,s,r){const{clearcoatFactor:n,clearcoatTexture:i,clearcoatRoughnessFactor:o,clearcoatRoughnessTexture:a,clearcoatNormalTexture:l}=s;if(n&&(e.clearcoat=n),i&&(e.clearcoatMap=r[i.index]),o&&(e.clearcoatRoughness=o),a&&(e.clearcoatRoughnessMap=r[a.index]),l&&(e.clearcoatNormalMap=r[l.index],l.scale)){const s=l.scale;e.clearcoatNormalScale=new t.Vector2(s,s)}}}class ht{static getMaterial(){return new t.PBR2Material}static parseParams(e,s,r,n){const{diffuseFactor:i,diffuseTexture:o,specularFactor:a,glossinessFactor:l,specularGlossinessTexture:c}=s;Array.isArray(i)&&(e.diffuse.fromArray(i),e.opacity=i[3]||1),o&&(e.diffuseMap=r[o.index],e.diffuseMapCoord=o.texCoord||0,e.diffuseMap&&(e.diffuseMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,n&&n.handleMaterialMap(e,"diffuseMap",o))),e.glossiness=void 0!==l?l:1,Array.isArray(a)&&e.specular.fromArray(a),c&&(e.glossinessMap=r[c.index],e.specularMap=r[c.index])}}const pt=[class{static parse(e,t){const{url:s}=e;return t.loadFile(s,"arraybuffer").then((t=>{if("glTF"===Se.decodeText(new Uint8Array(t,0,4))){const s=Se.parseGLB(t);e.gltf=s.gltf,e.buffers=s.buffers}else{const s=Se.decodeText(new Uint8Array(t));e.gltf=JSON.parse(s)}}))}},Ce,Oe,Ie,Pe,Ne,qe,class{static parse(e,s){const{gltf:r,textures:n}=e;if(!r.materials)return;const i=s.extensions.get("KHR_texture_transform"),o=s.extensions.get("KHR_materials_unlit"),a=s.extensions.get("KHR_materials_pbrSpecularGlossiness"),l=s.extensions.get("KHR_materials_clearcoat"),c=[];for(let e=0;e<r.materials.length;e++){const{extensions:s={},pbrMetallicRoughness:u,normalTexture:d,occlusionTexture:h,emissiveTexture:p,emissiveFactor:m,alphaMode:f,alphaCutoff:g,doubleSided:_,name:b=""}=r.materials[e],{KHR_materials_unlit:A,KHR_materials_pbrSpecularGlossiness:x,KHR_materials_clearcoat:y}=s;let T=null;if(A&&o?T=o.getMaterial():x&&a?(T=a.getMaterial(),a.parseParams(T,x,n,i)):y&&l?(T=l.getMaterial(),l.parseParams(T,y,n)):T=new t.PBRMaterial,T.name=b,u){const{baseColorFactor:e,baseColorTexture:s,metallicFactor:r,roughnessFactor:o,metallicRoughnessTexture:a}=u;Array.isArray(e)&&(T.diffuse.fromArray(e),T.opacity=void 0!==e[3]?e[3]:1),s&&(T.diffuseMap=n[s.index],T.diffuseMapCoord=s.texCoord||0,T.diffuseMap&&(T.diffuseMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,i&&i.handleMaterialMap(T,"diffuseMap",s))),A||x||(T.metalness=void 0!==r?r:1,T.roughness=void 0!==o?o:1,a&&(T.metalnessMap=n[a.index],T.roughnessMap=n[a.index]))}m&&T.emissive.fromArray(m),p&&(T.emissiveMap=n[p.index],T.emissiveMapCoord=p.texCoord||0,T.emissiveMap&&(T.emissiveMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,i&&i.handleMaterialMap(T,"emissiveMap",p))),h&&(T.aoMap=n[h.index],T.aoMapCoord=h.texCoord||0,void 0!==h.strength&&(T.aoMapIntensity=h.strength),T.aoMap&&i&&i.handleMaterialMap(T,"aoMap",h)),A||d&&(T.normalMap=n[d.index],T.normalScale.set(1,-1),void 0!==d.scale&&T.normalScale.set(d.scale,-d.scale)),T.side=!0===_?t.DRAW_SIDE.DOUBLE:t.DRAW_SIDE.FRONT,f===Fe?T.transparent=!0:(T.transparent=!1,f===De&&(T.alphaTest=void 0!==g?g:.5)),c[e]=T}e.materials=c}},Qe,Je,rt,nt,it,at],mt=new Map([["EXT_meshopt_compression",class{static loadBufferView(e,t,s){const r=t[e.buffer];if(!s||!s.supported)throw new Error("GLTFLoader: setMeshoptDecoder must be called before loading compressed files.");const n=e.byteOffset||0,i=e.byteLength||0,o=e.count,a=e.byteStride,l=new Uint8Array(r,n,i);return s.decodeGltfBufferAsync?s.decodeGltfBufferAsync(o,a,l,e.mode,e.filter).then((e=>e.buffer)):s.ready.then((()=>{const t=new ArrayBuffer(o*a);return s.decodeGltfBuffer(new Uint8Array(t),o,a,l,e.mode,e.filter),t}))}}],["KHR_draco_mesh_compression",class{static getGeometry(e,t,s,r,n){const{bufferView:i,attributes:o}=e;if(!n)throw new Error("GLTFLoader: No DRACOLoader instance provided.");const a={};for(const e in o){a[void 0===Ue[e]?e:Ue[e]]=o[e]}const l={},c={};for(const e in s){const t=Ue[e]||e.toLowerCase();if(void 0!==o[e]){const n=r[s[e]],i=ze[n.componentType];c[t]=i.name,l[t]=!0===n.normalized}}const u=t[i];return new Promise((function(e){n.decodeDracoFile(u,(function(t){for(const e in t.attributes){const s=t.attributes[e],r=l[e];void 0!==r&&(s.normalized=r)}e(t)}),a,c)}))}}],["KHR_lights_punctual",class{static getLight(e){const{color:s,intensity:r=1,type:n,range:i,spot:o}=e;let a;if("directional"===n)a=new t.DirectionalLight;else if("point"===n)a=new t.PointLight,void 0!==i&&(a.distance=i);else{if("spot"!==n)throw new Error("Unexpected light type: "+n);if(a=new t.SpotLight,void 0!==i&&(a.distance=i),o){const{innerConeAngle:e=0,outerConeAngle:t=Math.PI/4}=o;a.angle=t,a.penumbra=1-e/t}}return s&&a.color.fromArray(s),a.intensity=r,a}}],["KHR_materials_clearcoat",dt],["KHR_materials_pbrSpecularGlossiness",ht],["KHR_materials_unlit",class{static getMaterial(){return new t.BasicMaterial}}],["KHR_mesh_quantization",{}],["KHR_texture_basisu",class{static loadTextureData(e,t){return new Promise(((s,r)=>{t.load(e,s,void 0,r)}))}}],["KHR_texture_transform",class{static handleMaterialMap(e,t,s){if(!s.extensions)return;const r=s.extensions.KHR_texture_transform;if(!r)return;let n=0,i=0,o=1,a=1,l=0;void 0!==r.offset&&(n=r.offset[0],i=r.offset[1]),void 0!==r.rotation&&(l=r.rotation),void 0!==r.scale&&(o=r.scale[0],a=r.scale[1]);const c=e[t+"Transform"];c&&c.setUvTransform(n,i,o,a,l,0,0),void 0!==r.texCoord&&(e[t+"Coord"]=r.texCoord)}}]]);class ft{constructor(e=t.DefaultLoadingManager,s=pt,r=mt){this.manager=e,this.detailLoadProgress=!0,this.autoLogError=!0,this.extensions=new Map(r),this._parsers=s.slice(0),this._dracoLoader=null,this._meshoptDecoder=null,this._ktx2Loader=null,this._fileLoader=new t.FileLoader;const n=navigator.userAgent,i=!0===/^((?!chrome|android).)*safari/i.test(n),o=n.match(/Version\/(\d+)/),a=i&&o?parseInt(o[1],10):-1,l=n.indexOf("Firefox")>-1,c=l?n.match(/Firefox\/([0-9]+)\./)[1]:-1;"undefined"==typeof createImageBitmap||i&&a<17||l&&c<98?this._imageLoader=new t.ImageLoader:this._imageLoader=new Ee}load(e,t={}){return this.manager.itemStart(e),new Promise(((s,r)=>{const n=new ut;n.url=e,n.path=Se.extractUrlBase(e),n.options=t,this._parse(n).then(s).then((()=>this.manager.itemEnd(e))).catch((t=>{this.autoLogError&&console.error(t),this.detailLoadProgress&&n.loadItems&&n.loadItems.forEach((e=>{this.manager.itemEnd(e)})),this.manager.itemError(e),this.manager.itemEnd(e),r(`Error loading glTF model from ${e} .`)}))}))}_parse(e){let t;return new Promise(((s,r)=>{this._parsers.forEach((s=>{t=t?t.then((()=>s.parse(e,this))):s.parse(e,this)})),t?t.then((()=>s(e))).catch(r):s(e)}))}setDRACOLoader(e){return this._dracoLoader=e,this}getDRACOLoader(){return this._dracoLoader}setMeshoptDecoder(e){return this._meshoptDecoder=e,this}getMeshoptDecoder(){return this._meshoptDecoder}setKTX2Loader(e){return this._ktx2Loader=e,this}getKTX2Loader(){return this._ktx2Loader}loadFile(e,t="json"){return this._fileLoader.setResponseType(t),new Promise(((t,s)=>{e=this.manager.resolveURL(e),this._fileLoader.load(e,t,void 0,s)}))}loadImage(e){return new Promise(((t,s)=>{e=this.manager.resolveURL(e),this._imageLoader.load(e,t,void 0,s)}))}insertParser(e,t){this._parsers.splice(t,0,e)}replaceParser(e,t){this._parsers.splice(t,1,e)}}class gt{static parse(e,t){const r=e.options.buffer,n=new DataView(r),i=String.fromCharCode(n.getUint8(0))+String.fromCharCode(n.getUint8(1))+String.fromCharCode(n.getUint8(2))+String.fromCharCode(n.getUint8(3)),o=s(e.url);if(i!==o)throw`Not a ${o} type resource, with url ${e.url}!`;const a=n.getUint32(4,!0);if(1!==a)throw`${o} version must be 1, with url ${e.url}!`;const l=n.getUint32(8,!0);if(l!==r.byteLength)throw`${o} data byte length check failed, with url ${e.url}!`;if("cmpt"===o){const t=n.getUint32(12,!0);return void(e.header={magic:i,version:a,byteLength:l,tilesLength:t})}const c=n.getUint32(12,!0),u=n.getUint32(16,!0),d=n.getUint32(20,!0),h=n.getUint32(24,!0);let p=null;"i3dm"===o&&(p=n.getUint32(28,!0)),e.header={magic:i,version:a,byteLength:l,featureTableJSONByteLength:c,featureTableBinaryByteLength:u,batchTableJSONByteLength:d,batchTableBinaryByteLength:h,gltfFormat:p}}}class _t{constructor(e,t,s,r){this.buffer=e,this.binOffset=t+s,this.binLength=r;let n=null;if(0!==s){const r=new Uint8Array(e,t,s);n=JSON.parse(Se.decodeText(r))}else n={};this.header=n}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,r=null){const n=this.header;if(!(e in n))return null;const i=n[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:n,binOffset:o,binLength:a}=this,l=i.byteOffset||0,c=i.type||r,u=i.componentType||s;if("type"in i&&r&&i.type!==r)throw new Error("FeatureTable: Specified type does not match expected type.");let d,h;switch(c){case"SCALAR":d=1;break;case"VEC2":d=2;break;case"VEC3":d=3;break;case"VEC4":d=4;break;default:throw new Error(`FeatureTable: Feature type not provided for "${e}".`)}const p=o+l,m=t*d;switch(u){case"BYTE":h=new Int8Array(n,p,m);break;case"UNSIGNED_BYTE":h=new Uint8Array(n,p,m);break;case"SHORT":h=new Int16Array(n,p,m);break;case"UNSIGNED_SHORT":h=new Uint16Array(n,p,m);break;case"INT":h=new Int32Array(n,p,m);break;case"UNSIGNED_INT":h=new Uint32Array(n,p,m);break;case"FLOAT":h=new Float32Array(n,p,m);break;case"DOUBLE":h=new Float64Array(n,p,m);break;default:throw new Error(`FeatureTable: Feature component type not provided for "${e}".`)}if(p+m*h.BYTES_PER_ELEMENT>o+a)throw new Error("FeatureTable: Feature data read outside binary body length.");return h}}return i}}class bt extends _t{constructor(e,t,s,r,n){super(e,s,r,n),this.batchSize=t}getData(e,t=null,s=null){return super.getData(e,this.batchSize,t,s)}}class At{static parse(e,t){const{header:s,options:r}=e,n=r.buffer,i="i3dm"===s.magic?32:28,o=i+s.featureTableJSONByteLength+s.featureTableBinaryByteLength,a=o,l=a+s.batchTableJSONByteLength+s.batchTableBinaryByteLength,c=n.slice(i,o),u=new _t(c,0,s.featureTableJSONByteLength,s.featureTableBinaryByteLength);let d;if("b3dm"===s.magic)d=u.getData("BATCH_LENGTH");else if("i3dm"===s.magic)d=u.getData("INSTANCES_LENGTH");else{if("pnts"!==s.magic)throw`Unrecognized magic: ${s.magic}!`;d=u.getData("BATCH_LENGTH")||u.getData("POINTS_LENGTH")}const h=n.slice(a,l),p=new bt(h,d,0,s.batchTableJSONByteLength,s.batchTableBinaryByteLength);e.featureTable=u,e.batchTable=p,e.batchTableEnd=l}}class xt{static parse(e,t){const s=new Uint8Array(e.options.buffer,e.batchTableEnd,e.header.byteLength-e.batchTableEnd),r=Se.parseGLB(s.slice().buffer);e.gltf=r.gltf,e.buffers=r.buffers}}let yt=class{static parse(e,s){const{gltf:r,textures:n}=e;if(!r.materials)return;const i=s.extensions.get("KHR_texture_transform"),o=s.extensions.get("KHR_materials_unlit"),a=s.extensions.get("KHR_materials_pbrSpecularGlossiness"),l=s.extensions.get("KHR_materials_clearcoat"),c=s.extensions.get("KHR_techniques_webgl"),u=[];for(let e=0;e<r.materials.length;e++){const{extensions:s={},pbrMetallicRoughness:d,normalTexture:h,occlusionTexture:p,emissiveTexture:m,emissiveFactor:f,alphaMode:g,alphaCutoff:_,doubleSided:b,name:A=""}=r.materials[e],{KHR_materials_unlit:x,KHR_materials_pbrSpecularGlossiness:y,KHR_materials_clearcoat:T,KHR_techniques_webgl:w}=s;let M=null;if(x&&o?M=o.getMaterial():y&&a?(M=a.getMaterial(),a.parseParams(M,y,n,i)):T&&l?(M=l.getMaterial(),l.parseParams(M,T,n)):w&&c?(M=c.getMaterial(),c.parseParams(M,w,n)):M=new t.PBRMaterial,M.name=A,d){const{baseColorFactor:e,baseColorTexture:s,metallicFactor:r,roughnessFactor:o,metallicRoughnessTexture:a}=d;Array.isArray(e)&&(M.diffuse.fromArray(e),M.opacity=void 0!==e[3]?e[3]:1),s&&(M.diffuseMap=n[s.index],M.diffuseMapCoord=s.texCoord||0,M.diffuseMap&&(M.diffuseMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,i&&i.handleMaterialMap(M,"diffuseMap",s))),x||y||(M.metalness=void 0!==r?r:1,M.roughness=void 0!==o?o:1,a&&(M.metalnessMap=n[a.index],M.roughnessMap=n[a.index]))}f&&M.emissive.fromArray(f),m&&(M.emissiveMap=n[m.index],M.emissiveMapCoord=m.texCoord||0,M.emissiveMap&&(M.emissiveMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,i&&i.handleMaterialMap(M,"emissiveMap",m))),p&&(M.aoMap=n[p.index],M.aoMapCoord=p.texCoord||0,void 0!==p.strength&&(M.aoMapIntensity=p.strength),M.aoMap&&i&&i.handleMaterialMap(M,"aoMap",p)),x||h&&(M.normalMap=n[h.index],M.normalScale.set(1,-1),void 0!==h.scale&&M.normalScale.set(h.scale,-h.scale)),M.side=!0===b?t.DRAW_SIDE.DOUBLE:t.DRAW_SIDE.FRONT,g===Fe?M.transparent=!0:(M.transparent=!1,g===De&&(M.alphaTest=void 0!==_?_:.5)),u[e]=M}e.materials=u}};class Tt{static parse(e,t){const{root:s,featureTable:r,options:n}=e,i=r.getData("RTC_CENTER");i&&(s.position.x+=i[0],s.position.y+=i[1],s.position.z+=i[2]),n.adjustmentTransform&&(s.matrix.transform(s.position,s.scale,s.quaternion),s.matrix.multiply(n.adjustmentTransform),s.matrix.decompose(s.position,s.quaternion,s.scale))}}class wt{static getMaterial(){return new t.PBRMaterial}static parseParams(e,t,s){const{values:r}=t,{u_diffuse:n}=r;n&&(e.diffuseMap=s[n.index],e.diffuseMapCoord=n.texCoord||0)}}class Mt extends ft{constructor(e){super(e,[gt,At,xt,Ce,Oe,Ie,Pe,Ne,qe,yt,Qe,Je,rt,nt,it,at,Tt]),this.extensions.set("KHR_techniques_webgl",wt)}}class Rt{static parse(e,t){const s=new Uint8Array(e.options.buffer,e.batchTableEnd,e.header.byteLength-e.batchTableEnd);let r=null;if(1===e.header.gltfFormat)r=Promise.resolve(s);else{const n=Se.resolveURL(Se.decodeText(s),e.path);r=t.loadFile(n,"arraybuffer").then((e=>new Uint8Array(e)))}return r.then((t=>{const s=Se.parseGLB(t.slice().buffer);e.gltf=s.gltf,e.buffers=s.buffers}))}}const Lt="\n\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 instanceMatrix;\n\t\t#endif\n",Et="\n\t\t#ifdef USE_INSTANCING\n\t\t\t\ttransformed = (instanceMatrix * vec4(transformed, 1.0)).xyz;\n\t\t#endif\n",vt="\n\t\t#ifdef USE_INSTANCING\n\t\t\t\t#ifdef USE_INSTANCING\n\t\t\t\t\t\tobjectNormal = (transposeMat4(inverseMat4(instanceMatrix)) * vec4(objectNormal, 0.0)).xyz;\n\t\t\t\t#endif\n\n\t\t\t\t#ifdef USE_TANGENT\n\t\t\t\t\t\tobjectTangent = (transposeMat4(inverseMat4(instanceMatrix)) * vec4(objectTangent, 0.0)).xyz;\n\t\t\t\t#endif\n\t\t#endif\n";class St extends t.PBRMaterial{constructor(){super(),this.type=t.MATERIAL_TYPE.SHADER,this.shaderName="TILE_I_PBR",this.vertexShader=Ct,this.fragmentShader=t.ShaderLib.pbr_frag,this.defines.USE_INSTANCING=!0}}St.prototype.isInstancedPBRMaterial=!0;let Ct=t.ShaderLib.pbr_vert;Ct=Ct.replace("#include <logdepthbuf_pars_vert>",`\n\t\t#include <logdepthbuf_pars_vert>\n\t\t${Lt}\n`),Ct=Ct.replace("#include <pvm_vert>",`\n\t\t${Et}\n\t\t#include <pvm_vert>\n`),Ct=Ct.replace("#include <normal_vert>",`\n\t\t${vt}\n\t\t#include <normal_vert>\n`);class Ot{static parse(e,s){const{gltf:r,textures:n}=e;if(!r.materials)return;const i=s.extensions.get("KHR_texture_transform"),o=s.extensions.get("KHR_materials_unlit"),a=s.extensions.get("KHR_materials_pbrSpecularGlossiness"),l=s.extensions.get("KHR_materials_clearcoat"),c=s.extensions.get("KHR_techniques_webgl"),u=[];for(let e=0;e<r.materials.length;e++){const{extensions:s={},pbrMetallicRoughness:d,normalTexture:h,occlusionTexture:p,emissiveTexture:m,emissiveFactor:f,alphaMode:g,alphaCutoff:_,doubleSided:b,name:A=""}=r.materials[e],{KHR_materials_unlit:x,KHR_materials_pbrSpecularGlossiness:y,KHR_materials_clearcoat:T,KHR_techniques_webgl:w}=s;let M=null;if(x&&o?M=o.getMaterial():y&&a?(M=a.getMaterial(),a.parseParams(M,y,n,i)):T&&l?(M=l.getMaterial(),l.parseParams(M,T,n)):w&&c?(M=c.getMaterial(),c.parseParams(M,w,n)):M=new St,M.name=A,d){const{baseColorFactor:e,baseColorTexture:s,metallicFactor:r,roughnessFactor:o,metallicRoughnessTexture:a}=d;Array.isArray(e)&&(M.diffuse.fromArray(e),M.opacity=void 0!==e[3]?e[3]:1),s&&(M.diffuseMap=n[s.index],M.diffuseMapCoord=s.texCoord||0,M.diffuseMap&&(M.diffuseMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,i&&i.handleMaterialMap(M,"diffuseMap",s))),x||y||(M.metalness=void 0!==r?r:1,M.roughness=void 0!==o?o:1,a&&(M.metalnessMap=n[a.index],M.roughnessMap=n[a.index]))}f&&M.emissive.fromArray(f),m&&(M.emissiveMap=n[m.index],M.emissiveMapCoord=m.texCoord||0,M.emissiveMap&&(M.emissiveMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,i&&i.handleMaterialMap(M,"emissiveMap",m))),p&&(M.aoMap=n[p.index],M.aoMapCoord=p.texCoord||0,void 0!==p.strength&&(M.aoMapIntensity=p.strength),M.aoMap&&i&&i.handleMaterialMap(M,"aoMap",p)),x||h&&(M.normalMap=n[h.index],M.normalScale.set(1,-1),void 0!==h.scale&&M.normalScale.set(h.scale,-h.scale)),M.side=!0===b?t.DRAW_SIDE.DOUBLE:t.DRAW_SIDE.FRONT,g===Fe?M.transparent=!0:(M.transparent=!1,g===De&&(M.alphaTest=void 0!==_?_:.5)),u[e]=M}e.materials=u}}class It{static parse(e,s){const{gltf:r,accessors:n,materials:i,bufferViews:o}=e;if(!r.meshes)return;const a=s.extensions.get("KHR_draco_mesh_compression"),l=new Map,c=new Map,u=[];for(let e=0;e<r.meshes.length;e++){const d=r.meshes[e],h=[];for(let e=0;e<d.primitives.length;e++){const u=d.primitives[e],{extensions:p={},mode:m,material:f}=u,{KHR_draco_mesh_compression:g}=p;let _;const b=Bt(u);c.has(b)?_=c.get(b):(_=g&&a?a.getGeometry(g,o,u.attributes,r.accessors,s.getDRACOLoader()):Promise.resolve(new t.Geometry),_=_.then((e=>(Pt(e,u,r,n),e))),c.set(b,_));const A=_.then((e=>{const t={mode:m,geometry:e,material:void 0===f?new St:i[f],weights:Object.keys(e.morphAttributes).length>0&&d.weights?d.weights.slice(0):void 0,skinned:d.isSkinned};return Nt(t,l),t}));h.push(A)}u.push(Promise.all(h))}return l.clear(),c.clear(),Promise.all(u).then((t=>{e.primitives=t}))}}function Pt(e,t,s,r){const{attributes:n,indices:i,targets:o}=t;for(const t in n){const s=n[t],i=void 0===Ue[t]?t:Ue[t];i in e.attributes||e.addAttribute(i,r[s])}void 0===i||e.index||e.setIndex(r[i]);const{boundingBox:a,boundingSphere:l}=e;if(void 0!==n.POSITION){const t=n.POSITION,r=s.accessors[t];if(r.min&&r.max){if(a.min.fromArray(r.min),a.max.fromArray(r.max),r.normalized){const e=Se.getNormalizedComponentScale(ze[r.componentType]);a.min.multiplyScalar(e),a.max.multiplyScalar(e)}}else e.computeBoundingBox()}else e.computeBoundingBox();if(a.getCenter(l.center),l.radius=a.min.distanceTo(a.max)/2,o){let t=!1,s=!1;for(let e=0,r=o.length;e<r;e++){const r=o[e];if(void 0!==r.POSITION&&(t=!0),void 0!==r.NORMAL&&(s=!0),t&&s)break}if(t||s){const n=[],i=[];for(let a=0,l=o.length;a<l;a++){const l=o[a];t&&n.push(void 0!==l.POSITION?r[l.POSITION]:e.attributes[Ue.POSITION]),s&&i.push(void 0!==l.NORMAL?r[l.NORMAL]:e.attributes[Ue.NORMAL])}t&&(e.morphAttributes.position=n),s&&(e.morphAttributes.normal=i)}}return e}function Nt(e,s){let{geometry:r,material:n,skinned:i,mode:o}=e;const a=void 0!==r.attributes[Ue.TANGENT],l=void 0!==r.attributes[Ue.COLOR_0],c=void 0===r.attributes[Ue.NORMAL],u=i;if(o===$e){const e="PointsMaterial:"+n.id;let r=s.get(e);r||(r=new t.PointsMaterial,t.Material.prototype.copy.call(r,n),r.diffuse.copy(n.diffuse),r.diffuseMap=n.map,r.drawMode=o,r.acceptLight=!1,s.set(e,r)),n=r}else if(o===Ke||o===je||o===Xe){const e="BasicMaterial:"+n.id;let r=s.get(e);r||(r=new t.BasicMaterial,r.envMap=void 0,r.diffuse.copy(n.diffuse),r.diffuseMap=n.diffuseMap,r.drawMode=o,s.set(e,r)),n=r}else o===We?(console.warn("TRIANGLE_STRIP will be removed later."),n.drawMode=We):o===Ye&&(console.warn("TRIANGLE_FAN will be removed later."),n.drawMode=Ye);if(a||l||c||u){let e="ClonedMaterial:"+n.id+":";a&&(e+="vertex-tangents:"),l&&(3===r.attributes[Ue.COLOR_0].size?e+="vertex-colors-rgb:":4===r.attributes[Ue.COLOR_0].size&&(e+="vertex-colors-rgba:")),c&&(e+="flat-shading:");let i=s.get(e);i||(i=n.clone(),a&&(i.vertexTangents=!0,i.normalMap&&(i.normalScale.y*=-1)),l&&(3===r.attributes[Ue.COLOR_0].size?i.vertexColors=t.VERTEX_COLOR.RGB:4===r.attributes[Ue.COLOR_0].size?i.vertexColors=t.VERTEX_COLOR.RGBA:console.warn("Illegal vertex color size: "+r.attributes[Ue.COLOR_0].size)),c&&(i.shading=t.SHADING_TYPE.FLAT_SHADING)),n=i}e.material=n}function Bt(e){const t=e.extensions&&e.extensions.KHR_draco_mesh_compression;let s;if(s=t?"draco:"+t.bufferView+":"+t.indices+":"+Ut(t.attributes):e.indices+":"+Ut(e.attributes)+":"+e.mode,e.targets)for(let t=0,r=e.targets.length;t<r;t++)s+=":"+Ut(e.targets[t]);return s}function Ut(e){let t="";const s=Object.keys(e).sort();for(let r=0,n=s.length;r<n;r++)t+=s[r]+":"+e[s[r]]+";";return t}class Dt{static parse(e,s){const{featureTable:r,root:n,options:i}=e,o=r.getData("INSTANCES_LENGTH"),a=r.getData("POSITION",o,"FLOAT","VEC3"),l=r.getData("NORMAL_UP",o,"FLOAT","VEC3"),c=r.getData("NORMAL_RIGHT",o,"FLOAT","VEC3"),u=r.getData("SCALE",o,"FLOAT","SCALAR"),d=r.getData("SCALE_NON_UNIFORM",o,"FLOAT","VEC3");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in r.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const h=new t.Vector3;for(let e=0;e<o;e++)h.x+=a[3*e+0]/o,h.y+=a[3*e+1]/o,h.z+=a[3*e+2]/o;const p=[];n.traverse((e=>{if(e.isMesh){const{geometry:s}=e;s.instanceCount=o;const r=new t.Attribute(new t.Buffer(new Float32Array(16*o),16),16);r.divisor=1,s.addAttribute("instanceMatrix",r),e.updateMatrix(!0),e.position.copy(h).applyMatrix4(e.worldMatrix),p.push(e)}}));for(let e=0;e<o;e++){zt.fromArray(a,3*e).sub(h),l?(Vt.fromArray(l,3*e),kt.fromArray(c,3*e),Ft.crossVectors(kt,Vt).normalize(),$t.set(kt.x,Vt.x,Ft.x,0,kt.y,Vt.y,Ft.y,0,kt.z,Vt.z,Ft.z,0,0,0,0,1),Gt.setFromRotationMatrix($t)):Gt.set(0,0,0,1),u?Ht.set(u[e],u[e],u[e]):d?Ht.fromArray(d,3*e):Ht.set(1,1,1),$t.transform(zt,Ht,Gt).multiply(i.adjustmentTransform);for(let t=0,s=p.length;t<s;t++){const{geometry:s}=p[t],r=s.getAttribute("instanceMatrix").buffer.array;$t.toArray(r,16*e),s.version++}}const m=r.getData("RTC_CENTER");m&&(n.position.x+=m[0],n.position.y+=m[1],n.position.z+=m[2])}}const Ft=new t.Vector3,Vt=new t.Vector3,kt=new t.Vector3,zt=new t.Vector3,Gt=new t.Quaternion,Ht=new t.Vector3,$t=new t.Matrix4;class Kt extends wt{static getMaterial(){return new St}}class Xt extends t.BasicMaterial{constructor(){super(),this.type=t.MATERIAL_TYPE.SHADER,this.shaderName="TILE_I_BASIC",this.vertexShader=jt,this.fragmentShader=t.ShaderLib.basic_frag,this.defines.USE_INSTANCING=!0}}Xt.prototype.isInstancedBasicMaterial=!0;let jt=t.ShaderLib.basic_vert;jt=jt.replace("#include <logdepthbuf_pars_vert>",`\n\t\t#include <logdepthbuf_pars_vert>\n\t\t${Lt}\n`),jt=jt.replace("#include <pvm_vert>",`\n\t\t${Et}\n\t\t#include <pvm_vert>\n`),jt=jt.replace("#include <normal_vert>",`\n\t\t${vt}\n\t\t#include <normal_vert>\n`);class Wt{static getMaterial(){return new Xt}}class Yt extends ht{static getMaterial(){const e=new St;return e.specular=new t.Color3(1118481),e}}class qt extends dt{static getMaterial(){return new St}}class Qt extends ft{constructor(e){super(e,[gt,At,Rt,Ce,Oe,Ie,Pe,Ne,qe,Ot,Qe,It,rt,nt,it,at,Dt]),this.extensions.set("KHR_techniques_webgl",Kt),this.extensions.set("KHR_materials_unlit",Wt),this.extensions.set("KHR_materials_pbrSpecularGlossiness",Yt),this.extensions.set("KHR_materials_clearcoat",qt)}}class Jt{static parse(e,s){const{featureTable:r}=e,n=r.getData("POINTS_LENGTH"),i=r.getData("POSITION",n,"FLOAT","VEC3"),o=r.getData("RGB",n,"UNSIGNED_BYTE","VEC3"),a=r.getData("RGBA",n,"UNSIGNED_BYTE","VEC4");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","CONSTANT_RGBA","BATCH_LENGTH","POSITION_QUANTIZED","RGB565","NORMAL","NORMAL_OCT16P","BATCH_ID"].forEach((e=>{e in r.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const l=new t.Geometry;l.addAttribute("a_Position",new t.Attribute(new t.Buffer(i,3),3,0,!0)),l.computeBoundingBox(),l.computeBoundingSphere();const c=new t.PointsMaterial;c.size=2,c.sizeAttenuation=!1,null!==o?(l.addAttribute("a_Color",new t.Attribute(new t.Buffer(o,3),3,0,!0)),c.vertexColors=t.VERTEX_COLOR.RGB):null!==a&&(l.addAttribute("a_Color",new t.Attribute(new t.Buffer(a,4),4,0,!0)),c.vertexColors=t.VERTEX_COLOR.RGBA);const u=new t.Mesh(l,c);e.root=u;const d=r.getData("RTC_CENTER");d&&(u.position.x+=d[0],u.position.y+=d[1],u.position.z+=d[2])}}class Zt extends ft{constructor(e){super(e,[gt,At,Jt])}}class es{static parse(e,t){const s=e.options.buffer,r=e.header.tilesLength,n=[];let i=16;for(let e=0;e<r;e++){const e=new DataView(s,i,12),t=String.fromCharCode(e.getUint8(0))+String.fromCharCode(e.getUint8(1))+String.fromCharCode(e.getUint8(2))+String.fromCharCode(e.getUint8(3)),r=e.getUint32(4,!0),o=e.getUint32(8,!0),a=new Uint8Array(s,i,o);n.push({type:t,buffer:a,version:r}),i+=o}e.tiles=n}}class ts{static parse(e,s){const{tiles:r,options:n,path:i}=e,o=n.adjustmentTransform,a=[];for(const e in r){const{type:t,buffer:l}=r[e],c={fetchOptions:n.fetchOptions,path:i,buffer:l.slice().buffer};"b3dm"!==t&&"i3dm"!==t||(c.adjustmentTransform=o);const u=s._loaders.get(t);u&&a.push(u.load(`${i}/temp.${t}`,c))}return Promise.all(a).then((e=>{const s=new t.Object3D;return e.forEach((e=>{s.add(e.root)})),{tiles:e,root:s}}))}}class ss extends ft{constructor(e){super(e,[gt,es,ts]);const t=new Mt(e),s=new Qt(e),r=new Zt(e);this._loaders=new Map([["b3dm",t],["i3dm",s],["pnts",r]])}setDRACOLoader(e){for(const t of this._loaders.values())t.setDRACOLoader(e);return super.setDRACOLoader(e)}setKTX2Loader(e){for(const t of this._loaders.values())t.setKTX2Loader(e);return super.setKTX2Loader(e)}}class rs{static parse(e,t){const{url:s,options:r}=e,n=r.buffer;if(ns(s)){const t=Se.parseGLB(n);e.gltf=t.gltf,e.buffers=t.buffers}else e.gltf=n}}const ns=e=>"glb"===e.substring(e.lastIndexOf(".")+1);class is extends ft{constructor(e){super(e),this.replaceParser(rs,0)}}class os{constructor(e){const t=new Mt(e),s=new Qt(e),r=new Zt(e),n=new ss(e),i=new is(e);this._loaders=new Map([["b3dm",t],["i3dm",s],["pnts",r],["cmpt",n],["gltf",i],["glb",i]])}setDRACOLoader(e){this._loaders.get("b3dm").setDRACOLoader(e),this._loaders.get("i3dm").setDRACOLoader(e),this._loaders.get("cmpt").setDRACOLoader(e),this._loaders.get("gltf").setDRACOLoader(e)}setKTX2Loader(e){this._loaders.get("b3dm").setKTX2Loader(e),this._loaders.get("i3dm").setKTX2Loader(e),this._loaders.get("cmpt").setKTX2Loader(e),this._loaders.get("gltf").setKTX2Loader(e)}loadTileContent(e,t,s,r){t._loadIndex=t._loadIndex||0,t._loadIndex++;const n=t.content.uri,i=n.split(/[\\\/]/g);i.pop();const o=i.join("/"),a=r.fetchOptions,l=t._loadIndex;let c=null;const u=r.rootTileSet.asset&&r.rootTileSet.asset.gltfUpAxis||"y",d=t.cached,h=d.transform;switch(u.toLowerCase()){case"x":as.makeRotationAxis(cs,-Math.PI/2);break;case"y":as.makeRotationAxis(ls,Math.PI/2);break;case"z":as.identity()}const p=this._loaders.get(s);if(p){const t={fetchOptions:a,path:o,buffer:e};"b3dm"!==s&&"i3dm"!==s&&"cmpt"!==s||(t.adjustmentTransform=as.clone()),c=p.load(n,t)}else console.warn(`TilesRenderer: Content type "${s}" not supported.`),c=Promise.resolve(null);return c.then((e=>{const r=e.root;if(t._loadIndex!==l||!r)return;r.updateMatrix(),"glb"!==s&&"gltf"!==s||r.matrix.multiply(as),r.matrix.premultiply(h),r.matrix.decompose(r.position,r.quaternion,r.scale),d.scene=r,d.featureTable=e.featureTable,d.batchTable=e.batchTable;const n=[],i=[],o=[];return r.traverse((e=>{if(e.geometry&&i.push(e.geometry),e.material){const t=e.material;n.push(e.material);for(const e in t){const s=t[e];s&&s.isTexture&&o.push(s)}}})),d.materials=n,d.geometry=i,d.textures=o,r}))}}const as=new t.Matrix4,ls=new t.Vector3(1,0,0),cs=new t.Vector3(0,1,0),us=(e,t)=>{const s=t.stats,r=t.frameCount,n=t.errorTarget,i=t.maxDepth,o=t.loadSiblings,a=t.$tilesLoader.lruCache,l=t.stopAtEmptyTiles;ms(e,r);if(!1===fs(e,t))return!1;if(e.__used=!0,a.markUsed(e),e.__inFrustum=!0,s.inFrustum++,(l||!e.__contentEmpty)&&!e.__externalTileSet){gs(e,t);if(e.__error<=n)return!0;if(i>0&&e.__depth+1>=i)return!0}let c=!1;const u=e.children;for(let e=0,s=u.length;e<s;e++){const s=u[e],r=us(s,t);c=c||r}if(c&&o)for(let e=0,t=u.length;e<t;e++){const t=u[e];_s(t,r,a)}return!0},ds=(e,t)=>{const s=t.stats,r=t.frameCount;if(!bs(e,r))return;s.used++;const n=e.children;let i=!1;for(let e=0,t=n.length;e<t;e++){const t=n[e];i=i||bs(t,r)}if(i){let s=!1,i=!0;for(let e=0,o=n.length;e<o;e++){const o=n[e];if(ds(o,t),s=s||o.__wasSetVisible||o.__childrenWereVisible,bs(o,r)){const e=o.__allChildrenLoaded||!o.__contentEmpty&&As(o.__loadingState)||o.__externalTileSet&&o.__loadingState===h.FAILED;i=i&&e}}e.__childrenWereVisible=s,e.__allChildrenLoaded=i}else e.__isLeaf=!0},hs=(e,t)=>{const s=t.stats,r=t.frameCount;if(!bs(e,r))return;const n=e.parent,i=n?n.__depthFromRenderedParent:-1;e.__depthFromRenderedParent=i;const o=t.$tilesLoader.lruCache;if(e.__isLeaf)return e.__depthFromRenderedParent++,void(e.__loadingState===h.LOADED?(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++):o.isFull()||e.__contentEmpty&&!e.__externalTileSet||t.$tilesLoader.requestTileContents(e,t));const a=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=a,c=l||"ADD"===e.refine,u=!e.__contentEmpty,d=u||e.__externalTileSet,p=As(e.__loadingState)&&d,m=e.__childrenWereVisible,f=e.children,g=e.__allChildrenLoaded;if(c&&u&&e.__depthFromRenderedParent++,c&&!p&&!o.isFull()&&d&&t.$tilesLoader.requestTileContents(e,t),(l&&!g&&!m&&p||"ADD"===e.refine&&p)&&(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++),"ADD"!==e.refine&&l&&!g&&p)for(let s=0,n=f.length;s<n;s++){const n=f[s];bs(n,r)&&!o.isFull()&&(n.__depthFromRenderedParent=e.__depthFromRenderedParent+1,xs(n,n.__depthFromRenderedParent,t))}else for(let e=0,s=f.length;e<s;e++){const s=f[e];bs(s,r)&&hs(s,t)}},ps=(e,t)=>{const s=t.frameCount,r=bs(e,s);if(r||e.__usedLastFrame){let s=!1,n=!1;r&&(s=e.__active,n=t.displayActiveTiles&&e.__active||e.__visible),e.__contentEmpty||e.__loadingState!==h.LOADED||(e.__wasSetActive!==s&&t.$setTileActive(e,s),e.__wasSetVisible!==n&&t.$setTileVisible(e,n)),e.__wasSetActive=s,e.__wasSetVisible=n,e.__usedLastFrame=r;const i=e.children;for(let e=0,s=i.length;e<s;e++){const s=i[e];ps(s,t)}}},ms=(e,t)=>{e.__lastFrameVisited!==t&&(e.__lastFrameVisited=t,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1)},fs=(e,t)=>{const s=t.$cameras.getInfos(),r=e.cached,n=r.boundingVolume,i=r.inFrustum;let o=!1;for(let e=0,t=s.length;e<t;e++){const t=s[e].frustum;n.intersectsFrustum(t)?(o=!0,i[e]=!0):i[e]=!1}return o},gs=(e,t)=>{const s=t.$cameras.getInfos(),r=e.cached,n=r.inFrustum,i=r.boundingVolume;let o=-1/0,a=1/0;for(let e=0,t=s.length;e<t;e++){if(!n[e])continue;const t=s[e],l=t.invScale;let c;if(t.isOrthographic){const e=t.pixelSize;c=r.geometricError/(e*l)}else{const e=i.distanceToPoint(t.position)*l,s=t.sseDenominator;c=r.geometricError/(e*s),a=Math.min(a,e)}o=Math.max(o,c)}e.__distanceFromCamera=a,e.__error=o},_s=(e,t,s)=>{if(ms(e,t),e.__used=!0,s.markUsed(e),e.__contentEmpty){const r=e.children;for(let e=0,n=r.length;e<n;e++)_s(r[e],t,s)}},bs=(e,t)=>e.__lastFrameVisited===t&&e.__used;function As(e){return e===h.LOADED||e===h.FAILED}const xs=(e,t,s)=>{if(e.__contentEmpty&&(!e.__externalTileSet||As(e.__loadingState))){const r=e.children;for(let e=0,n=r.length;e<n;e++){const n=r[e];n.__depthFromRenderedParent=t,xs(n,t,s)}}else s.$tilesLoader.requestTileContents(e,s)},ys=6378137,Ts=new B(new t.Vector3(ys,ys,6356752.314245179));Ts.name="WGS84 Earth";class ws extends t.Object3D{constructor(e,s=new t.LoadingManager){super(),this.ellipsoid=Ts.clone(),this.fetchOptions={},this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0,this.preprocessURL=null,s.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=s,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.activeTiles=new Set,this.visibleTiles=new Set,this.rootURL=e,this._rootTileSet=null,this._autoDisableRendererCulling=!0,this.plugins=[],this.$cameras=new f,this.$tilesLoader=new Te,this.$modelLoader=new os(s),this.$events=new t.EventDispatcher}loadRootTileSet(){let e=this.rootURL;this.invokeAllPlugins((t=>e=t.preprocessURL?t.preprocessURL(e,null):e));return this.invokeOnePlugin((t=>t.fetchData&&t.fetchData(e,this.fetchOptions))).then((t=>{if(t.ok)return t.json();throw new Error(`Tiles3D: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)})).then((t=>(this.$tilesLoader.preprocessTileSet(t,e),t)))}fetchData(e,t){return fetch(e,t)}get rootTileSet(){const e=this._rootTileSet;return e?e instanceof Promise||e instanceof Error?null:e:(this._rootTileSet=this.invokeOnePlugin((e=>e.loadRootTileSet&&e.loadRootTileSet())).then((e=>{let t=this.rootURL;null!==t&&this.invokeAllPlugins((e=>t=e.preprocessURL?e.preprocessURL(t,null):t)),this._rootTileSet=e,this.dispatchEvent({type:"load-tile-set",tileSet:e,url:t})})).catch((e=>{console.error(e),this._rootTileSet=e})),null)}get root(){const e=this.rootTileSet;return e?e.root:null}get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.traverse((t=>{const s=t.cached.scene;s&&s.traverse((t=>{t.frustumCulled=t[Rs]&&!e}))})))}registerPlugin(e){if(!0===e[Ms])throw new Error("Tiles3D: A plugin can only be registered to a single tile set");const t=this.plugins,s=e.priority||0;let r=t.length;for(let e=0;e<t.length;e++){if((t[e].priority||0)>s){r=e;break}}t.splice(r,0,e),e[Ms]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if("string"==typeof e&&(e=this.getPluginByName(name)),t.includes(e)){const s=t.indexOf(e);return t.splice(s,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find((t=>t.name===e))||null}setDRACOLoader(e){this.$modelLoader.setDRACOLoader(e)}setKTX2Loader(e){this.$modelLoader.setKTX2Loader(e)}addEventListener(e,t,s){this.$events.addEventListener(e,t,s)}removeEventListener(e,t,s){this.$events.removeEventListener(e,t,s)}dispatchEvent(e){this.$events.dispatchEvent(e)}update(){const e=this.root;if(!e)return;const{stats:t}=this;var s,r;t.inFrustum=0,t.used=0,t.active=0,t.visible=0,this.frameCount++,this.$cameras.updateInfos(this.worldMatrix),us(s=e,r=this),ds(s,r),hs(s,r),ps(s,r),r.$tilesLoader.lruCache.scheduleUnload()}addCamera(e){return this.$cameras.add(e)}removeCamera(e){return this.$cameras.remove(e)}resize(e,t){this.$cameras.setResolution(e,t)}raycast(e,t){if(!this.root)return null;n(this.root,this,e,t),t.sort(o)}raycastFirst(e){return this.root?i(this.root,this,e):null}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getBoundingBox(e),!0)}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return!!s&&(s.getOrientedBoundingBox(e,t),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getBoundingSphere(e),!0)}traverse(e,t){const s=this.root;s&&r(s,e,t)}resetFailedTiles(){const e=this.stats;0!==e.failed&&(this.traverse((e=>{e.__loadingState===h.FAILED&&(e.__loadingState=h.UNLOADED)})),e.failed=0)}dispose(){const e=this.$tilesLoader.lruCache;this.traverse((t=>{e.remove(t)})),this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}updateMatrix(e){if((this.matrixAutoUpdate||this.matrixNeedsUpdate)&&(this.matrix.transform(this.position,this.scale,this.quaternion),this.matrixNeedsUpdate=!1,this.worldMatrixNeedsUpdate=!0),(this.worldMatrixNeedsUpdate||e)&&(null===this.parent?Ss.copy(this.matrix):Ss.multiplyMatrices(this.parent.worldMatrix,this.matrix),this.worldMatrixNeedsUpdate=!1,!Cs(Ss,this.worldMatrix))){this.worldMatrix.copy(Ss);const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].updateMatrix()}}getAttributions(e=[]){return this.invokeAllPlugins((t=>t!==this&&t.getAttributions&&t.getAttributions(e))),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const r=e(t[s]);if(r)return r}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let r=0;r<t.length;r++){const n=e(t[r]);n&&s.push(n)}return 0===s.length?null:Promise.all(s)}$parseTile(e,t,s){return this.$modelLoader.loadTileContent(e,t,s,this).then((e=>{e.traverse((e=>{e[Rs]=e.frustumCulled,e.frustumCulled=e.frustumCulled&&!this._autoDisableRendererCulling})),Ls.scene=e,Ls.tile=t,this.$events.dispatchEvent(Ls)}))}$setTileVisible(e,t){const s=e.cached.scene;if(!s)return;const r=this.visibleTiles;t?(this.add(s),r.add(e),s.updateMatrix(!0)):(this.remove(s),r.delete(e)),vs.scene=s,vs.tile=e,vs.visible=t,this.$events.dispatchEvent(vs)}$setTileActive(e,t){const s=this.activeTiles;t?s.add(e):s.delete(e)}$disposeTile(e){const t=e.cached;if(t.scene){const s=t.materials,r=t.geometry,n=t.textures;for(let e=0,t=r.length;e<t;e++)r[e].dispose();for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=n.length;e<t;e++){n[e].dispose()}Es.scene=t.scene,Es.tile=e,this.$events.dispatchEvent(Es),t.scene=null,t.materials=null,t.textures=null,t.geometry=null}e._loadIndex++}}const Ms=Symbol("PLUGIN_REGISTERED"),Rs=Symbol("INITIAL_FRUSTUM_CULLED"),Ls={type:"TileLoaded",scene:null,tile:null},Es={type:"TileDisposed",scene:null,tile:null},vs={type:"TileVisibilityChanged",scene:null,tile:null,visible:!1},Ss=new t.Matrix4,Cs=(e,t,s=Number.EPSILON)=>{const r=e.elements,n=t.elements;for(let e=0;e<16;e++)if(Math.abs(r[e]-n[e])>s)return!1;return!0};const Os=new t.Sphere,Is=new t.Vector3;t.Matrix4.prototype.makeBasis=function(e,t,s){return this.set(e.x,t.x,s.x,0,e.y,t.y,s.y,0,e.z,t.z,s.z,0,0,0,0,1),this},t.Matrix4.prototype.setPosition=function(e,t,s){const r=this.elements;return e.isVector3?(r[12]=e.x,r[13]=e.y,r[14]=e.z):(r[12]=e,r[13]=t,r[14]=s),this},t.Matrix4.prototype.makeRotationFromEuler=function(e){const t=this.elements,s=e.x,r=e.y,n=e.z,i=Math.cos(s),o=Math.sin(s),a=Math.cos(r),l=Math.sin(r),c=Math.cos(n),u=Math.sin(n);if("XYZ"===e.order){const e=i*c,s=i*u,r=o*c,n=o*u;t[0]=a*c,t[4]=-a*u,t[8]=l,t[1]=s+r*l,t[5]=e-n*l,t[9]=-o*a,t[2]=n-e*l,t[6]=r+s*l,t[10]=i*a}else if("YXZ"===e.order){const e=a*c,s=a*u,r=l*c,n=l*u;t[0]=e+n*o,t[4]=r*o-s,t[8]=i*l,t[1]=i*u,t[5]=i*c,t[9]=-o,t[2]=s*o-r,t[6]=n+e*o,t[10]=i*a}else if("ZXY"===e.order){const e=a*c,s=a*u,r=l*c,n=l*u;t[0]=e-n*o,t[4]=-i*u,t[8]=r+s*o,t[1]=s+r*o,t[5]=i*c,t[9]=n-e*o,t[2]=-i*l,t[6]=o,t[10]=i*a}else if("ZYX"===e.order){const e=i*c,s=i*u,r=o*c,n=o*u;t[0]=a*c,t[4]=r*l-s,t[8]=e*l+n,t[1]=a*u,t[5]=n*l+e,t[9]=s*l-r,t[2]=-l,t[6]=o*a,t[10]=i*a}else if("YZX"===e.order){const e=i*a,s=i*l,r=o*a,n=o*l;t[0]=a*c,t[4]=n-e*u,t[8]=r*u+s,t[1]=u,t[5]=i*c,t[9]=-o*c,t[2]=-l*c,t[6]=s*u+r,t[10]=e-n*u}else if("XZY"===e.order){const e=i*a,s=i*l,r=o*a,n=o*l;t[0]=a*c,t[4]=-u,t[8]=l*c,t[1]=e*u+n,t[5]=i*c,t[9]=s*u-r,t[2]=r*u-s,t[6]=o*c,t[10]=n*u+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},t.Matrix4.prototype.invert=function(){return this.getInverse(this)};const Ps=new t.Quaternion;t.Vector3.prototype.applyEuler=function(e){return this.applyQuaternion(Ps.setFromEuler(e))},t.Vector3.prototype.isVector3=!0,e.B3DMLoader=Mt,e.CMPTLoader=ss,e.CesiumIonAuthPlugin=class{constructor({apiToken:e,assetId:t=null,autoRefreshToken:s=!1,useRecommendedSettings:r=!0}){this.name="CESIUM_ION_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=e,this.assetId=t,this.autoRefreshToken=s,this.useRecommendedSettings=r,this.tiles=null,this.endpointURL=null,this._bearerToken=null,this._tileSetVersion=-1,this._tokenRefreshPromise=null,this._attributions=[],this._disposed=!1}init(e){null!==this.assetId&&(e.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=e,this.endpointURL=e.rootURL,e.resetFailedTiles()}loadRootTileSet(){return this._refreshToken().then((()=>this.tiles.invokeOnePlugin((e=>e!==this&&e.loadRootTileSet&&e.loadRootTileSet()))))}preprocessURL(e){return e=new URL(e),/^http/.test(e.protocol)&&-1!=this._tileSetVersion&&e.searchParams.append("v",this._tileSetVersion),e.toString()}fetchData(e,t){return null!==this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")?null:Promise.resolve().then((async()=>{null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,e=this.preprocessURL(e));const s=await fetch(e,t);return s.status>=400&&s.status<=499&&this.autoRefreshToken?(await this._refreshToken(t),fetch(this.preprocessURL(e),t)):s}))}getAttributions(e){this.tiles.visibleTiles.size>0&&e.push(...this._attributions)}_refreshToken(e){if(null===this._tokenRefreshPromise){const t=new URL(this.endpointURL);t.searchParams.append("access_token",this.apiToken),this._tokenRefreshPromise=fetch(t,e).then((e=>{if(this._disposed)return null;if(!e.ok)throw new Error(`CesiumIonAuthPlugin: Failed to load data with error code ${e.status}`);return e.json()})).then((e=>{if(this._disposed)return null;const s=this.tiles;if("externalType"in e);else{if("TERRAIN"===e.type&&null===s.getPluginByName("QUANTIZED_MESH_PLUGIN")||"IMAGERY"===e.type&&s.getPluginByName("TMS_TILES_PLUGIN"),s.rootURL=e.url,s.fetchOptions.headers=s.fetchOptions.headers||{},s.fetchOptions.headers.Authorization=`Bearer ${e.accessToken}`,t.searchParams.has("v")&&-1===this._tileSetVersion){const t=new URL(e.url);this._tileSetVersion=t.searchParams.get("v")}this._bearerToken=e.accessToken,e.attributions&&(this._attributions=e.attributions.map((e=>({value:e.html,type:"html",collapsible:e.collapsible}))))}return this._tokenRefreshPromise=null,e})),this._tokenRefreshPromise.catch((e=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:e,url:t})}))}return this._tokenRefreshPromise}dispose(){this._disposed=!0}},e.DebugLoadParser=class{static parse(e,t){let r=null;return r="gltf"===s(e.url)?t.loadFile(e.url).then((t=>{e.options.buffer=t})):t.loadFile(e.url,"arraybuffer").then((t=>{e.options.buffer=t})),r}},e.I3DMLoader=Qt,e.InstancedBasicMaterial=Xt,e.InstancedPBRMaterial=St,e.OBB=A,e.PNTSLoader=Zt,e.ReorientationPlugin=class{constructor(e){e={up:"+z",recenter:!0,lat:null,lon:null,height:0,...e},this.tiles=null,this.up=e.up.toLowerCase().replace(/\s+/,""),this.lat=e.lat,this.lon=e.lon,this.height=e.height,this.recenter=e.recenter,this._callback=null}init(e){this.tiles=e,this._callback=()=>{const{up:t,lat:s,lon:r,height:n,recenter:i}=this;if(null!==s&&null!==r)this.transformLatLonHeightToOrigin(s,r,n);else{const{ellipsoid:s}=e,r=Math.min(s.radius.x,s.radius.y,s.radius.z);if(e.getBoundingSphere(Os),Os.center.getLength()>.5*r){const e={};s.getPositionToCartographic(Os.center,e),this.transformLatLonHeightToOrigin(e.lat,e.lon,e.height),console.log(e.lat,e.lon,e.height)}else{switch(e.euler.set(0,0,0),t){case"x":case"+x":e.euler.z=Math.PI/2;break;case"-x":e.euler.z=-Math.PI/2;break;case"y":case"+y":break;case"-y":e.euler.z=Math.PI;break;case"z":case"+z":e.euler.x=-Math.PI/2;break;case"-z":e.euler.x=Math.PI/2}e.position.copy(Os.center).applyEuler(e.euler).multiplyScalar(-1)}}i||e.position.setScalar(0),e.removeEventListener("load-tile-set",this._callback)},e.addEventListener("load-tile-set",this._callback)}transformLatLonHeightToOrigin(e,t,s=0){const r=this.tiles,{ellipsoid:n}=r;n.getRotationMatrixFromAzElRoll(e,t,0,0,0,r.matrix,Q),n.getCartographicToPosition(e,t,s,Is),r.matrix.setPosition(Is).invert().decompose(r.position,r.quaternion,r.scale),r.updateMatrix()}dispose(){const e=this.tiles;e.position.setScalar(0),e.quaternion.identity(),e.scale.set(1,1,1),e.addEventListener("load-tile-set",this._callback)}},e.TileGLTFLoader=is,e.Tiles3D=ws}));
