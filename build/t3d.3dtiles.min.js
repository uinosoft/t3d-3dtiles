// t3d-3dtiles
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("t3d")):"function"==typeof define&&define.amd?define(["exports","t3d"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).t3d=e.t3d||{},e.t3d)}(this,(function(e,t){"use strict";class i{constructor(e=new t.Box3,i=new t.Matrix3){this.box=e,this.rotation=i}setFromCenterAndAxes(e,t,i,s){r.copy(t),n.copy(i),o.copy(s);const a=r.getLength(),l=n.getLength(),c=o.getLength();r.normalize(),n.normalize(),o.normalize(),0===a&&r.crossVectors(n,o),0===l&&n.crossVectors(r,o),0===c&&o.crossVectors(r,n),this.rotation.set(r.x,n.x,o.x,r.y,n.y,o.y,r.z,n.z,o.z);const h=r.set(a,l,c);return this.box.min.copy(e).sub(h),this.box.max.copy(e).add(h),this}applyMatrix4(e){const t=e.elements;let i=r.set(t[0],t[1],t[2]).getLength();const s=r.set(t[4],t[5],t[6]).getLength(),o=r.set(t[8],t[9],t[10]).getLength();e.determinant()<0&&(i=-i),a.setFromMatrix4(e);const l=1/i,c=1/s,h=1/o;a.elements[0]*=l,a.elements[1]*=l,a.elements[2]*=l,a.elements[3]*=c,a.elements[4]*=c,a.elements[5]*=c,a.elements[6]*=h,a.elements[7]*=h,a.elements[8]*=h,this.rotation.multiply(a);const d=this.box.getCenter(r),u=this.box.getSize(n).multiplyScalar(.5);return u.x*=i,u.y*=s,u.z*=o,d.applyMatrix4(e),this.box.min.copy(d).sub(u),this.box.max.copy(d).add(u),this}getPoints(e){const t=this.box.getCenter(r),i=n.subVectors(this.box.min,t),s=o.subVectors(this.box.max,t);let a=0;for(let r=-1;r<=1;r+=2)for(let n=-1;n<=1;n+=2)for(let o=-1;o<=1;o+=2)e[a].set(r<0?i.x:s.x,n<0?i.y:s.y,o<0?i.z:s.z).applyMatrix3(this.rotation).add(t),a++;return e}getPlanes(e){const t=this.box.getCenter(r),i=n.subVectors(this.box.min,t).applyMatrix3(this.rotation).add(t),s=o.subVectors(this.box.max,t).applyMatrix3(this.rotation).add(t);return r.set(0,0,1).applyMatrix3(this.rotation).normalize(),e[0].setFromNormalAndCoplanarPoint(r,i),e[1].setFromNormalAndCoplanarPoint(r,s),e[1].normal.negate(),e[1].constant*=-1,r.set(0,1,0).applyMatrix3(this.rotation).normalize(),e[2].setFromNormalAndCoplanarPoint(r,i),e[3].setFromNormalAndCoplanarPoint(r,s),e[3].normal.negate(),e[3].constant*=-1,r.set(1,0,0).applyMatrix3(this.rotation).normalize(),e[4].setFromNormalAndCoplanarPoint(r,i),e[5].setFromNormalAndCoplanarPoint(r,s),e[5].normal.negate(),e[5].constant*=-1,e}containsPoint(e){const t=m(this,u),i=r.subVectors(e,t.c);return Math.abs(i.dot(t.u[0]))<=t.e[0]&&Math.abs(i.dot(t.u[1]))<=t.e[1]&&Math.abs(i.dot(t.u[2]))<=t.e[2]}clampPoint(e,t){const i=m(this,u),s=r.subVectors(e,i.c);t.copy(i.c);const n=Math.max(Math.min(s.dot(i.u[0]),i.e[0]),-i.e[0]);t.add(i.u[0].multiplyScalar(n));const o=Math.max(Math.min(s.dot(i.u[1]),i.e[1]),-i.e[1]);t.add(i.u[1].multiplyScalar(o));const a=Math.max(Math.min(s.dot(i.u[2]),i.e[2]),-i.e[2]);return t.add(i.u[2].multiplyScalar(a)),t}intersectsSphere(e){return this.clampPoint(e.center,s),s.distanceToSquared(e.center)<=e.radius*e.radius}intersectsOBB(e,t=Number.EPSILON){m(this,u),m(e,p);for(let e=0;e<3;e++)for(let t=0;t<3;t++)l[e][t]=u.u[e].dot(p.u[t]);const i=r.subVectors(p.c,u.c);h[0]=i.dot(u.u[0]),h[1]=i.dot(u.u[1]),h[2]=i.dot(u.u[2]);for(let e=0;e<3;e++)for(let i=0;i<3;i++)c[e][i]=Math.abs(l[e][i])+t;let s,n;for(let e=0;e<3;e++)if(s=u.e[e],n=p.e[0]*c[e][0]+p.e[1]*c[e][1]+p.e[2]*c[e][2],Math.abs(h[e])>s+n)return!1;for(let e=0;e<3;e++)if(s=u.e[0]*c[0][e]+u.e[1]*c[1][e]+u.e[2]*c[2][e],n=p.e[e],Math.abs(h[0]*l[0][e]+h[1]*l[1][e]+h[2]*l[2][e])>s+n)return!1;return s=u.e[1]*c[2][0]+u.e[2]*c[1][0],n=p.e[1]*c[0][2]+p.e[2]*c[0][1],!(Math.abs(h[2]*l[1][0]-h[1]*l[2][0])>s+n)&&(s=u.e[1]*c[2][1]+u.e[2]*c[1][1],n=p.e[0]*c[0][2]+p.e[2]*c[0][0],!(Math.abs(h[2]*l[1][1]-h[1]*l[2][1])>s+n)&&(s=u.e[1]*c[2][2]+u.e[2]*c[1][2],n=p.e[0]*c[0][1]+p.e[1]*c[0][0],!(Math.abs(h[2]*l[1][2]-h[1]*l[2][2])>s+n)&&(s=u.e[0]*c[2][0]+u.e[2]*c[0][0],n=p.e[1]*c[1][2]+p.e[2]*c[1][1],!(Math.abs(h[0]*l[2][0]-h[2]*l[0][0])>s+n)&&(s=u.e[0]*c[2][1]+u.e[2]*c[0][1],n=p.e[0]*c[1][2]+p.e[2]*c[1][0],!(Math.abs(h[0]*l[2][1]-h[2]*l[0][1])>s+n)&&(s=u.e[0]*c[2][2]+u.e[2]*c[0][2],n=p.e[0]*c[1][1]+p.e[1]*c[1][0],!(Math.abs(h[0]*l[2][2]-h[2]*l[0][2])>s+n)&&(s=u.e[0]*c[1][0]+u.e[1]*c[0][0],n=p.e[1]*c[2][2]+p.e[2]*c[2][1],!(Math.abs(h[1]*l[0][0]-h[0]*l[1][0])>s+n)&&(s=u.e[0]*c[1][1]+u.e[1]*c[0][1],n=p.e[0]*c[2][2]+p.e[2]*c[2][0],!(Math.abs(h[1]*l[0][1]-h[0]*l[1][1])>s+n)&&(s=u.e[0]*c[1][2]+u.e[1]*c[0][2],n=p.e[0]*c[2][1]+p.e[1]*c[2][0],!(Math.abs(h[1]*l[0][2]-h[0]*l[1][2])>s+n)))))))))}toBoundingBoxWithTransform(e,t){const i=this.box.getCenter(r);e.min.copy(this.box.min).sub(i),e.max.copy(this.box.max).sub(i);const s=this.rotation.elements;t.set(s[0],s[3],s[6],i.x,s[1],s[4],s[7],i.y,s[2],s[5],s[8],i.z,0,0,0,1)}}const s=new t.Vector3,r=new t.Vector3,n=new t.Vector3,o=new t.Vector3,a=new t.Matrix3,l=[[],[],[]],c=[[],[],[]],h=[],d=new t.Vector3,u={c:new t.Vector3,u:[new t.Vector3,new t.Vector3,new t.Vector3],e:[]},p={c:new t.Vector3,u:[new t.Vector3,new t.Vector3,new t.Vector3],e:[]};function m(e,t){e.box.getCenter(t.c);const i=e.rotation.elements;return t.u[0].fromArray(i,0),t.u[1].fromArray(i,3),t.u[2].fromArray(i,6),e.box.getSize(d).multiplyScalar(.5).toArray(t.e),t}class f extends i{constructor(){super(),this._points=new Array(8).fill().map((()=>new t.Vector3)),this._planes=new Array(6).fill().map((()=>new t.Plane)),this._originBox=new t.Box3,this._originBoxTransform=new t.Matrix4,this._originBoxTransformInverse=new t.Matrix4}updateCache(){this.getPoints(this._points),this.getPlanes(this._planes),this.toBoundingBoxWithTransform(this._originBox,this._originBoxTransform),this._originBoxTransformInverse.copy(this._originBoxTransform).inverse()}containsPoint(e){return _.copy(e).applyMatrix4(this._originBoxTransformInverse),this.box.containsPoint(_)}intersectsRay(e){return g.copy(e).applyMatrix4(this._originBoxTransformInverse),g.intersectsBox(this._originBox)}intersectRay(e,t){return g.copy(e).applyMatrix4(this._originBoxTransformInverse),g.intersectBox(this._originBox,t)?t.applyMatrix4(this._originBoxTransform):null}intersectsFrustum(e){for(let t=0;t<6;t++){const i=e.planes[t];let s=-1/0;for(let e=0;e<8;e++){const t=this._points[e],r=i.distanceToPoint(t);s=s<r?r:s}if(s<0)return!1}for(let t=0;t<6;t++){const i=this._planes[t];let s=-1/0;for(let t=0;t<8;t++){const r=e.points[t],n=i.distanceToPoint(r);s=s<n?n:s}if(s<0)return!1}return!0}distanceToPoint(e){return _.copy(e).applyMatrix4(this._originBoxTransformInverse),this._originBox.distanceToPoint(_)}getBoundingSphere(e){return this.box.getBoundingSphere(e)}getBoundingBox(e){return e.setFromPoints(this._points)}}const g=new t.Ray,_=new t.Vector3;class b{constructor(e=new t.Vector3(1,1,1)){this.name="",this.radius=e}intersectRay(e,t){return T.makeScale(...this.radius.toArray([])).invert(),w.center.set(0,0,0),w.radius=1,R.copy(e).applyMatrix4(T),R.intersectSphere(w,t)?(T.makeScale(...this.radius.toArray([])),t.applyMatrix4(T),t):null}getEastNorthUpFrame(e,t,i){return this.getEastNorthUpAxes(e,t,S,P,C,L),i.makeBasis(S,P,C).setPosition(L)}getEastNorthUpAxes(e,t,i,s,r,n=L){this.getCartographicToPosition(e,t,0,n),this.getCartographicToNormal(e,t,r),i.set(-n.y,n.x,0).normalize(),s.crossVectors(r,i).normalize()}getRotationMatrixFromAzElRoll(e,t,i,s,r,n,o=I){return this.getEastNorthUpFrame(e,t,T),E.set(s,r,-i,"ZXY"),n.makeRotationFromEuler(E).premultiply(T).setPosition(0,0,0),o===U?(E.set(Math.PI/2,0,0,"XYZ"),A.makeRotationFromEuler(E),n.multiply(A)):o===F&&(E.set(-Math.PI/2,0,Math.PI,"XYZ"),A.makeRotationFromEuler(E),n.multiply(A)),n}getCartographicToPosition(e,t,i,s){this.getCartographicToNormal(e,t,x);const r=this.radius;M.copy(x),M.x*=r.x**2,M.y*=r.y**2,M.z*=r.z**2;const n=Math.sqrt(x.dot(M));return M.multiplyScalar(1/n),s.copy(M).addScaledVector(x,i)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,M),this.getPositionToNormal(e,x);const i=v.subVectors(e,M);return t.lon=Math.atan2(x.y,x.x),t.lat=Math.asin(x.z),t.height=Math.sign(i.dot(e))*i.getLength(),t}getCartographicToNormal(e,t,i){return y.set(1,-e+Math.PI/2,t),i.setFromSpherical(y).normalize(),function(e){const{x:t,y:i,z:s}=e;e.x=s,e.y=t,e.z=i}(i),i}getPositionToNormal(e,t){const i=this.radius;return t.copy(e),t.x/=i.x**2,t.y/=i.y**2,t.z/=i.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const i=this.radius,s=1/i.x**2,r=1/i.y**2,n=1/i.z**2,o=e.x*e.x*s,a=e.y*e.y*r,l=e.z*e.z*n,c=o+a+l,h=Math.sqrt(1/c),d=M.copy(e).multiplyScalar(h);if(c<O)return isFinite(h)?t.copy(d):null;const u=v.set(d.x*s*2,d.y*r*2,d.z*n*2);let p,m,f,g,_,b,y,x,T,A,w,E=(1-h)*e.getLength()/(.5*u.getLength()),S=0;do{E-=S,f=1/(1+E*s),g=1/(1+E*r),_=1/(1+E*n),b=f*f,y=g*g,x=_*_,T=b*f,A=y*g,w=x*_,p=o*b+a*y+l*x-1,m=o*T*s+a*A*r+l*w*n;S=p/(-2*m)}while(Math.abs(p)>D);return t.set(e.x*f,e.y*g,e.z*_)}calculateHorizonDistance(e,t){const i=this.calculateEffectiveRadius(e);return Math.sqrt(2*i*t+t**2)}calculateEffectiveRadius(e){const i=this.radius.x,s=1-this.radius.z**2/i**2,r=e*t.MathUtils.DEG2RAD,n=Math.sin(r)**2;return i/Math.sqrt(1-s*n)}getPositionElevation(e){this.getPositionToSurfacePoint(e,M);const t=v.subVectors(e,M);return Math.sign(t.dot(e))*t.getLength()}copy(e){return this.radius.copy(e.radius),this}clone(){return(new this.constructor).copy(this)}}const y=new t.Spherical,x=new t.Vector3,M=new t.Vector3,v=new t.Vector3,T=new t.Matrix4,A=new t.Matrix4,w=new t.Sphere,E=new t.Euler,S=new t.Vector3,P=new t.Vector3,C=new t.Vector3,L=new t.Vector3,R=new t.Ray,D=1e-12,O=.1,I=0,U=1,F=2;class B extends b{constructor(e=new t.Vector3(1,1,1),i=new t.Vector2(-j,j),s=new t.Vector2(0,2*H),r=new t.Vector2(0,1)){super(e),this.latRange=i,this.lonRange=s,this.heightRange=r}getOrientedBoundingBox(e){Z();const{latRange:t,lonRange:i}=this;if(t.y-t.x<H/2){const e=K(.5,0,1,t.x,t.y),s=K(.5,0,1,i.x,i.y);this.getCartographicToNormal(e,s,k),N.set(0,0,1),V.crossVectors(N,k),N.crossVectors(V,k)}else V.set(1,0,0),N.set(0,1,0),k.set(0,0,1);e.rotation.set(V.x,N.x,k.x,V.y,N.y,k.y,V.z,N.z,k.z),G.setFromMatrix3(e.rotation).inverse();const s=this._getPoints(!0);z.set(0,0,0);for(let e=0,t=s.length;e<t;e++)z.add(s[e]);z.multiplyScalar(1/s.length);for(let e=0,t=s.length;e<t;e++)s[e].sub(z).applyMatrix4(G).add(z);e.box.makeEmpty(),e.box.setFromPoints(s)}getBoundingSphere(e){Z();const t=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(t)}_getPoints(e=!1){const{latRange:t,lonRange:i,heightRange:s}=this,r=K(.5,0,1,t.x,t.y),n=K(.5,0,1,i.x,i.y),o=Math.floor(i.x/j)*j,a=[[-H/2,0],[H/2,0],[0,o],[0,o+H/2],[0,o+H],[0,o+3*H/2],[t.x,i.y],[t.y,i.y],[t.x,i.x],[t.y,i.x],[0,i.x],[0,i.y],[r,n],[t.x,n],[t.y,n],[r,i.x],[r,i.y]],l=[],c=a.length;for(let r=0;r<=1;r++){const n=K(r,0,1,s.x,s.y);for(let s=0,r=c;s<r;s++){const[r,o]=a[s];if(r>=t.x&&r<=t.y&&o>=i.x&&o<=i.y){const t=q(e);l.push(t),this.getCartographicToPosition(r,o,n,t)}}}return l}}const V=new t.Vector3,N=new t.Vector3,k=new t.Vector3,z=new t.Vector3,G=new t.Matrix4,H=Math.PI,j=H/2;function K(e,t,i,s,r){return s+(e-t)*(r-s)/(i-t)}let $=0;const X=[];function q(e=!1){return e?(X[$]||(X[$]=new t.Vector3),$++,X[$-1]):new t.Vector3}function Z(){$=0}class Q{constructor(){this.sphere=null,this.obb=null,this.region=null}setOBBData(e,t){const i=new f;i.setFromCenterAndAxes(ee.set(e[0],e[1],e[2]),W.set(e[3],e[4],e[5]),Y.set(e[6],e[7],e[8]),J.set(e[9],e[10],e[11])).applyMatrix4(t),i.updateCache(),this.obb=i}setSphereData(e,i){const s=new t.Sphere;s.center.set(e[0],e[1],e[2]),s.radius=e[3],s.applyMatrix4(i),this.sphere=s}setRegionData(e,i,s,r,n,o,a){const l=new B(e.radius.clone(),new t.Vector2(s,n),new t.Vector2(i,r),new t.Vector2(o,a));this.region=l;const c=new f;l.getOrientedBoundingBox(c),c.updateCache(),this.obb=c}intersectsRay(e){const t=this.sphere,i=this.obb;return!(t&&!e.intersectsSphere(t))&&!(i&&!i.intersectsRay(e))}intersectRay(e,t){const i=this.sphere,s=this.obb;let r=-1/0,n=-1/0;i&&e.intersectSphere(i,W)&&(r=i.containsPoint(e.origin)?0:e.origin.distanceToSquared(W)),s&&s.intersectRay(e,W)&&(n=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(W));const o=Math.max(r,n);return o===-1/0?null:e.at(Math.sqrt(o),t)}distanceToPoint(e){const t=this.sphere,i=this.obb;let s=-1/0,r=-1/0;return t&&(s=Math.max(t.distanceToPoint(e),0)),i&&(r=i.distanceToPoint(e)),s>r?s:r}intersectsFrustum(e){const t=this.sphere;if(t&&!e.intersectsSphere(t))return!1;const i=this.obb;return!(i&&!i.intersectsFrustum(e))&&Boolean(t||i)}getOrientedBoundingBox(e,t){this.obb?(e.copy(this.obb._originBox),t.copy(this.obb._originBoxTransform)):(this.getBoundingBox(e),t.identity())}getBoundingBox(e){return this.sphere?this.sphere.getBoundingBox(e):this.obb.getBoundingBox(e)}getBoundingSphere(e){return this.sphere?e.copy(this.sphere):this.obb.getBoundingSphere(e)}}const W=new t.Vector3,Y=new t.Vector3,J=new t.Vector3,ee=new t.Vector3,te=e=>{let t;try{t=new URL(e,"http://fakehost.com/")}catch(e){return null}const i=t.pathname.split("/").pop(),s=i.lastIndexOf(".");if(-1===s||s===i.length-1)return null;return i.substring(s+1)},ie=(e,t=null,i=null,s=null,r=0)=>{if(t&&t(e,s,r))return void(i&&i(e,s,r));const n=e.children;for(let s=0,o=n.length;s<o;s++)ie(n[s],t,i,e,r+1);i&&i(e,s,r)};const se=(e,t,i,s,r=null)=>{const{activeTiles:n}=t,o=e.cached.boundingVolume;if(null===r&&(r=le,ae.copy(t.worldMatrix).inverse(),r.copy(i).applyMatrix4(ae)),!e.__used||!o.intersectsRay(r))return;n.has(e)&&oe(e,i,s);const a=e.children;for(let e=0,n=a.length;e<n;e++)se(a[e],t,i,s,r)},re=(e,t,i,s=null)=>{const{activeTiles:r}=t;null===s&&(s=le,ae.copy(t.worldMatrix).inverse(),s.copy(i).applyMatrix4(ae));const n=[],o=e.children;for(let e=0,r=o.length;e<r;e++){const r=o[e];if(!r.__used)continue;r.cached.boundingVolume.intersectRay(s,ce)&&(ce.applyMatrix4(t.worldMatrix),n.push({distance:ce.distanceToSquared(i.origin),tile:r}))}n.sort(ne);let a=null,l=1/0;if(r.has(e)&&(oe(e,i,he),he.length>0)){he.length>1&&he.sort(ne);const e=he[0];he.length=0,a=e,l=e.distance*e.distance}for(let e=0,r=n.length;e<r;e++){const r=n[e],o=r.distance,c=r.tile;if(o>l)break;const h=re(c,t,i,s);if(h){const e=h.distance*h.distance;e<l&&(a=h,l=e)}}return a},ne=(e,t)=>e.distance-t.distance,oe=(e,t,i)=>{const s=e.cached.scene,r=i.length;s.traverse((e=>{Object.getPrototypeOf(e).raycast.call(e,t,i)}));const n=i.length;if(n>r)for(let t=r;t<n;t++)i[t].tile=e},ae=new t.Matrix4,le=new t.Ray,ce=new t.Vector3,he=[];var de=Object.freeze({UNLOADED:0,LOADING:1,PARSING:2,LOADED:3,FAILED:4});class ue extends t.Frustum{constructor(){super(),this.points=new Array(8).fill().map((()=>new t.Vector3))}updateCache(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach(((e,i)=>{!function(e,t,i,s){const r=pe.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,i.normal.x,i.normal.y,i.normal.z);s.set(-e.constant,-t.constant,-i.constant),s.applyMatrix3(r.inverse())}(e[0],e[1],e[2],t[i])}))}}const pe=new t.Matrix3;class me{constructor(){this._cameras=[],this._resolution=new t.Vector2,this._infos=[]}add(e){const t=this._cameras;return-1===t.indexOf(e)&&(t.push(e),!0)}remove(e){const t=this._cameras,i=t.indexOf(e);return-1!==i&&(t.splice(i,1),!0)}setResolution(e,t){this._resolution.set(e,t)}updateInfos(e){const i=this._cameras,s=i.length,r=this._infos,n=this._resolution;if(0===s)return void console.warn("CameraList.updateInfos(): No camera added.");for(;r.length>i.length;)r.pop();for(;r.length<i.length;)r.push({frustum:new ue,isOrthographic:!1,sseDenominator:-1,position:new t.Vector3,invScale:-1,pixelSize:0});fe.copy(e).inverse();const o=_e.setFromMatrixColumn(fe,0).getLength(),a=_e.setFromMatrixColumn(fe,1).getLength(),l=_e.setFromMatrixColumn(fe,2).getLength();Math.abs(Math.max(o-a,o-l))>1e-6&&console.warn("CameraList.updateInfos(): Non uniform scale used for tile which may cause issues when calculating screen space error.");const c=o,h=fe;for(let t=0,s=r.length;t<s;t++){const s=i[t],o=r[t],a=n.x*(s.rect.z-s.rect.x),l=n.y*(s.rect.w-s.rect.y);0!==a&&0!==l||console.warn("CameraList.updateInfos(): Resolution for camera error calculation is not set.");const d=s.projectionMatrix.elements;if(o.isOrthographic=1===d[15],o.isOrthographic){const e=2/d[0],t=2/d[5];o.pixelSize=Math.max(t/l,e/a)}else o.sseDenominator=2/d[5]/l;o.invScale=c,ge.copy(e).premultiply(s.projectionViewMatrix),o.frustum.setFromMatrix(ge),o.frustum.updateCache(),o.position.setFromMatrixPosition(s.worldMatrix).applyMatrix4(h)}}getInfos(){return this._infos}}const fe=new t.Matrix4,ge=new t.Matrix4,_e=new t.Vector3;class be{constructor({maxSize:e=800,minSize:t=600,unloadPercent:i=.05,unloadPriorityCallback:s=ye}){this.maxSize=e,this.minSize=t,this.unloadPercent=i,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.scheduled=!1,this.unloadPriorityCallback=s}isFull(){return this.itemSet.size>=this.maxSize}add(e,t){const i=this.itemSet;if(i.has(e))return!1;if(this.isFull())return!1;const s=this.usedSet,r=this.itemList,n=this.callbacks;return r.push(e),s.add(e),i.set(e,Date.now()),n.set(e,t),!0}remove(e){const t=this.usedSet,i=this.itemSet,s=this.itemList,r=this.callbacks;if(i.has(e)){r.get(e)(e);const n=s.indexOf(e);return s.splice(n,1),t.delete(e),i.delete(e),r.delete(e),!0}return!1}markUsed(e){const t=this.itemSet,i=this.usedSet;return!(!t.has(e)||i.has(e))&&(t.set(e,Date.now()),i.add(e),!0)}markAllUnused(){this.usedSet.clear()}unloadToMinSize(){const e=this.unloadPercent,t=this.minSize,i=this.itemList,s=this.itemSet,r=this.usedSet,n=this.callbacks,o=i.length-r.size,a=i.length-t,l=this.unloadPriorityCallback;if(a<=0||o<=0)return!1;i.sort(((e,t)=>{const i=r.has(e),n=r.has(t);return i&&n?0:i||n?i?1:-1:l(s,t)-l(s,e)}));const c=Math.min(a,o),h=Math.max(t*e,c*e);let d=Math.min(h,o);d=Math.ceil(d);const u=i.splice(0,d);for(let e=0,t=u.length;e<t;e++){const t=u[e];n.get(t)(t),s.delete(t),n.delete(t)}return!0}scheduleUnload(e=!0){if(this.scheduled)return!1;this.scheduled=!0,xe((()=>{this.scheduled=!1,this.unloadToMinSize(),e&&this.markAllUnused()}))}}const ye=(e,t)=>e.get(t),xe=e=>{Promise.resolve().then(e)};class Me{constructor({maxJobs:e=6,autoUpdate:t=!0,priorityCallback:i=ve}){this.maxJobs=e,this.autoUpdate=t,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.priorityCallback=i,this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}schedulingCallback(e){requestAnimationFrame(e)}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((i,s)=>{const r=this.items,n=this.callbacks;r.push(e),n.set(e,((...e)=>t(...e).then(i).catch(s))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,i=this.callbacks,s=t.indexOf(e);-1!==s&&(t.splice(s,1),i.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,i=this.maxJobs;let s=this.currJobs;for(;i>s&&e.length>0;){s++;const i=e.pop(),r=t.get(i);t.delete(i),r(i).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=s}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs.bind(this)),this.scheduled=!0)}}const ve=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")};class Te{constructor(){this.lruCache=new be({unloadPriorityCallback:Ae}),this.downloadQueue=new Me({maxJobs:4,priorityCallback:we}),this.parseQueue=new Me({maxJobs:1,priorityCallback:we})}requestTileContents(e,t){if(e.__loadingState!==de.UNLOADED)return;const i=t.stats,s=this.lruCache,r=this.downloadQueue,n=this.parseQueue,o=e.__externalTileSet;s.add(e,(e=>{e.__loadingState===de.LOADING?(e.__loadAbort.abort(),e.__loadAbort=null):o?e.children.length=0:t.$disposeTile(e),e.__loadingState===de.LOADING?i.downloading--:e.__loadingState===de.PARSING&&i.parsing--,e.__loadingState=de.UNLOADED,e.__loadIndex++,r.remove(e),n.remove(e)})),e.__loadIndex++;const a=e.__loadIndex,l=new AbortController,c=l.signal;i.downloading++,e.__loadAbort=l,e.__loadingState=de.LOADING;const h=t=>{e.__loadIndex===a&&("AbortError"!==t.name?(r.remove(e),n.remove(e),e.__loadingState===de.PARSING?i.parsing--:e.__loadingState===de.LOADING&&i.downloading--,i.failed++,e.__loadingState=de.FAILED,"Failed to fetch"!==t.message&&(console.error(`TilesLoader: Failed to load tile at url "${e.content.uri}".`),console.error(t))):s.remove(e))};let d=e.content.uri;t.invokeAllPlugins((t=>d=t.preprocessURL?t.preprocessURL(d,e):d)),o?r.add(e,(e=>e.__loadIndex!==a?Promise.resolve():t.invokeOnePlugin((e=>e.fetchData&&e.fetchData(d,{...t.fetchOptions,signal:c}))))).then((e=>{if(e.ok)return e.json();throw new Error(`TilesLoader: Failed to load tileset "${d}" with status ${e.status} : ${e.statusText}`)})).then((i=>(t.preprocessTileSet(i,d,e),i))).then((s=>{e.__loadIndex===a&&(i.downloading--,e.__loadAbort=null,e.__loadingState=de.LOADED,e.children.push(s.root),t.dispatchEvent({type:"load-tile-set",tileSet:s,url:d}))})).catch(h):r.add(e,(e=>e.__loadIndex!==a?Promise.resolve():t.invokeOnePlugin((e=>e.fetchData&&e.fetchData(d,{...t.fetchOptions,signal:c}))))).then((t=>{if(e.__loadIndex===a){if(t.ok){return"gltf"===te(t.url)?t.json():t.arrayBuffer()}throw new Error(`Failed to load model with error code ${t.status}`)}})).then((s=>{if(e.__loadIndex===a)return i.downloading--,i.parsing++,e.__loadAbort=null,e.__loadingState=de.PARSING,n.add(e,(e=>{if(e.__loadIndex!==a)return Promise.resolve();const i=e.content.uri,r=te(i);return t.$parseTile(s,e,r)}))})).then((()=>{e.__loadIndex===a&&(i.parsing--,e.__loadingState=de.LOADED,e.__wasSetVisible&&t.invokeOnePlugin((t=>t.setTileVisible&&t.setTileVisible(e,!0))),e.__wasSetActive&&t.$setTileActive(e,!0))})).catch(h)}}const Ae=(e,t)=>1/(t.__depthFromRenderedParent+1),we=(e,t)=>e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0;class Ee extends t.Loader{constructor(e){super(e),"undefined"==typeof createImageBitmap&&console.warn("ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,t,i,s){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,n={};n.credentials="anonymous"===this.crossOrigin?"same-origin":"include",n.headers=this.requestHeader,fetch(e,n).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,Object.assign(r.options,{colorSpaceConversion:"none"}))})).then((function(i){t&&t(i),r.manager.itemEnd(e)})).catch((function(t){s&&s(t),r.manager.itemError(e),r.manager.itemEnd(e)})),r.manager.itemStart(e)}}const Se=new t.Vector4;class Pe{constructor(){}static extractUrlBase(e){const t=e.split("/");return t.pop(),(t.length<1?".":t.join("/"))+"/"}static resolveURL(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)||/^data:/i.test(e)||/^blob:/i.test(e)?e:t+e}static decodeText(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let i=0,s=e.length;i<s;i++)t+=String.fromCharCode(e[i]);try{return decodeURIComponent(escape(t))}catch(e){return t}}static parseGLB(e){const t=1313821514,i=5130562,s=new DataView(e),r={magic:s.getUint32(0,!0),version:s.getUint32(4,!0),length:s.getUint32(8,!0)};if(1179937895!==r.magic)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+r.magic.toString(16)),null;r.version<2&&console.error("GLTFLoader: Legacy binary file detected.");let n=s.getUint32(12,!0),o=s.getUint32(16,!0);if(o!==t)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+o.toString(16)),null;const a=new Uint8Array(e,20,n),l=JSON.parse(Pe.decodeText(a)),c=[];let h=20+n;for(;h<r.length;){if(n=s.getUint32(h,!0),o=s.getUint32(h+4,!0),o!==i)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+o.toString(16)),null;const t=h+8,r=e.slice(t,t+n);c.push(r),h+=n+8}return{gltf:l,buffers:c}}static getNormalizedComponentScale(e){if(e===Int8Array)return 1/127;if(e===Uint8Array)return 1/255;if(e===Int16Array)return 1/32767;if(e===Uint16Array)return 1/65535;throw new Error("Unsupported normalized accessor component type.")}static normalizeSkinWeights(e){const t=e.offset,i=e.buffer,s=i.stride;for(let e=0,r=i.count;e<r;e++){Se.fromArray(i.array,e*s+t);const r=1/Se.getManhattanLength();r!==1/0?Se.multiplyScalar(r):Se.set(1,0,0,0),Se.toArray(i.array,e*s+t)}}}class Ce{static parse(e,t){const{gltf:i,path:s}=e,{nodes:r=[],skins:n=[],meshes:o=[],buffers:a,images:l}=i;if(n.forEach((e=>{const{joints:t=[]}=e;t.forEach((e=>{r[e].isBone=!0}))})),r.forEach((e=>{void 0!==e.mesh&&void 0!==e.skin&&(o[e.mesh].isSkinned=!0)})),t.detailLoadProgress){const i=new Set;a&&a.forEach((e=>{if(!e.uri)return;const t=Pe.resolveURL(e.uri,s);i.add(t)})),l&&l.forEach(((e,t)=>{const{uri:r,bufferView:n}=e;let o=r;void 0!==n&&(o="blob<"+t+">"),o=Pe.resolveURL(o,s),i.add(o)})),i.forEach((e=>t.manager.itemStart(e))),e.loadItems=i}}}class Le{static parse(e){const{gltf:{asset:{version:t}}}=e,i=Number(t);if(!(i>=2&&i<3))throw"Only support gltf 2.x."}}class Re{static parse(e,t){const{gltf:i,loadItems:s}=e;return null!==e.buffers?null:Promise.all(i.buffers.map((i=>{const r=Pe.resolveURL(i.uri,e.path);t.detailLoadProgress&&s.delete(r);const n=t.loadFile(r,"arraybuffer").then((e=>(t.detailLoadProgress&&t.manager.itemEnd(r),e)));return t.detailLoadProgress&&n.catch((()=>t.manager.itemEnd(r))),n}))).then((t=>{e.buffers=t}))}}class De{static parse(e,t){const{buffers:i,gltf:s}=e;if(!s.bufferViews)return;const r=t.extensions.get("EXT_meshopt_compression");return Promise.all(s.bufferViews.map((e=>{const{buffer:s,byteOffset:n=0,byteLength:o=0}=e;if(e.extensions){const{EXT_meshopt_compression:s}=e.extensions;if(s&&r)return r.loadBufferView(s,i,t.getMeshoptDecoder())}return i[s].slice(n,n+o)}))).then((t=>{e.bufferViews=t}))}}class Oe{static parse(e,t){const{gltf:i,bufferViews:s,path:r,loadItems:n}=e;if(!i.images)return;const o=t.extensions.get("KHR_texture_basisu");return Promise.all(i.images.map(((e,i)=>{const{uri:a,bufferView:l,mimeType:c,name:h}=e;let d=!1,u=a||"";if(void 0!==l){const e=s[l],t=new Blob([e],{type:c});u=URL.createObjectURL(t),d=!0}const p=Pe.resolveURL(u,r);let m;if(t.detailLoadProgress&&n.delete(p),c&&c.includes("ktx2")&&o)m=o.loadTextureData(p,t.getKTX2Loader()).then((e=>(t.detailLoadProgress&&(d?t.manager.itemEnd(Pe.resolveURL("blob<"+i+">",r)):t.manager.itemEnd(p)),e)));else{const e={loader:t,imageUrl:p,imageName:h,isObjectURL:d,sourceUrl:u,index:i,path:r};if(!c||!c.includes("avif")&&!c.includes("webp"))return Ie(e);m=function(e){const t=new Promise((t=>{const i=new Image;e.includes("avif")?i.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=":i.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",i.onload=()=>{t(1===i.height)}}));return t}(c).then((t=>{if(t)return Ie(e);throw new Error("GLTFLoader: WebP or AVIF required by asset but unsupported.")}))}return t.detailLoadProgress&&m.catch((()=>t.manager.itemEnd(p))),m}))).then((t=>{e.images=t}))}}function Ie(e){const{loader:t,imageUrl:i,imageName:s,isObjectURL:r,sourceUrl:n,index:o,path:a}=e;return t.loadImage(i).then((e=>(e.__name=s,!0===r&&URL.revokeObjectURL(n),t.detailLoadProgress&&(r?t.manager.itemEnd(Pe.resolveURL("blob<"+o+">",a)):t.manager.itemEnd(i)),e)))}const Ue={POSITION:"a_Position",NORMAL:"a_Normal",TANGENT:"a_Tangent",TEXCOORD_0:"a_Uv",TEXCOORD_1:"a_Uv2",TEXCOORD_2:"a_Uv3",TEXCOORD_3:"a_Uv4",TEXCOORD_4:"a_Uv5",TEXCOORD_5:"a_Uv6",TEXCOORD_6:"a_Uv7",TEXCOORD_7:"a_Uv8",COLOR_0:"a_Color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex",TEXCOORD0:"a_Uv",TEXCOORD:"a_Uv",COLOR0:"a_Color",COLOR:"a_Color",WEIGHT:"skinWeight",JOINT:"skinIndex"},Fe="MASK",Be="BLEND",Ve={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Ne={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ke={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ze={9728:t.TEXTURE_FILTER.NEAREST,9729:t.TEXTURE_FILTER.LINEAR,9984:t.TEXTURE_FILTER.NEAREST_MIPMAP_NEAREST,9985:t.TEXTURE_FILTER.LINEAR_MIPMAP_NEAREST,9986:t.TEXTURE_FILTER.NEAREST_MIPMAP_LINEAR,9987:t.TEXTURE_FILTER.LINEAR_MIPMAP_LINEAR},Ge={33071:t.TEXTURE_WRAP.CLAMP_TO_EDGE,33648:t.TEXTURE_WRAP.MIRRORED_REPEAT,10497:t.TEXTURE_WRAP.REPEAT},He=0,je=1,Ke=2,$e=3,Xe=5,qe=6;class Ze{static parse(e){const{gltf:i,images:s}=e;if(!i.textures)return;const r=new Map;return Promise.all(i.textures.map(((e,n)=>{const{sampler:o,source:a=0,name:l}=e;let c=a,h=!1;if(e.extensions){const{KHR_texture_basisu:t}=e.extensions;t?(c=t.source,h=!0):Object.values(e.extensions).length&&Object.values(e.extensions)[0].hasOwnProperty("source")?c=Object.values(e.extensions)[0].source:console.warn("GLTFLoader: unknown texture extension")}const d=c+":"+o;if(r.has(d))return r.get(d);const u=new t.Texture2D;if(h){const{image:e,mipmaps:t,type:i,format:r,minFilter:n,magFilter:o,generateMipmaps:a,encoding:l,premultiplyAlpha:h}=s[c];u.image=e,u.mipmaps=t,u.type=i,u.format=r,u.minFilter=n,u.magFilter=o,u.generateMipmaps=a,u.encoding=l,u.premultiplyAlpha=h}else u.image=s[c];u.version++,u.name=l||u.image.__name||`texture_${n}`,u.flipY=!1;return function(e,i={}){const{magFilter:s,minFilter:r,wrapS:n,wrapT:o}=i;e.magFilter=ze[s]||t.TEXTURE_FILTER.LINEAR,e.minFilter=ze[r]||t.TEXTURE_FILTER.LINEAR_MIPMAP_LINEAR,e.wrapS=Ge[n]||t.TEXTURE_WRAP.REPEAT,e.wrapT=Ge[o]||t.TEXTURE_WRAP.REPEAT}(u,(i.samplers||{})[o]),r.set(d,u),u}))).then((t=>{e.textures=t,r.clear()}))}}class Qe{static parse(e){const{bufferViews:i,gltf:s}=e;if(!s.accessors)return;const r=new Map,n=s.accessors.map((e=>{const{bufferView:n,type:o,componentType:a,count:l,byteOffset:c=0,normalized:h=!1,sparse:d}=e;if(void 0===n&&void 0===d)return null;const u=void 0!==n?i[n]:null,p=void 0!==n?s.bufferViews[n].byteStride:void 0,m=Ne[o],f=ke[a],g=f.BYTES_PER_ELEMENT;let _,b;if(p&&p!==g*m){const e=Math.floor(c/p),i="Buffer:"+n+":"+a+":"+e+":"+l;let s=r.get(i);s||(_=new f(u,e*p,l*p/g),s=new t.Buffer(_,p/g),r.set(i,s)),b=new t.Attribute(s,m,c%p/g,h)}else _=null===u?new f(l*m):new f(u,c,l*m),b=new t.Attribute(new t.Buffer(_,m),m,0,h);if(d){const e=Ne.SCALAR,s=ke[d.indices.componentType],r=d.indices.byteOffset||0,n=d.values.byteOffset||0,o=new s(i[d.indices.bufferView],r,d.count*e),a=new f(i[d.values.bufferView],n,d.count*m);null!==u&&(b=new t.Attribute(b.buffer.clone(),b.size,b.offset,b.normalized));const l=b.buffer;for(let e=0,t=o.length;e<t;e++){const t=o[e];if(l.array[t*b.size]=a[e*m],m>=2&&(l.array[t*b.size+1]=a[e*m+1]),m>=3&&(l.array[t*b.size+2]=a[e*m+2]),m>=4&&(l.array[t*b.size+3]=a[e*m+3]),m>=5)throw new Error("Unsupported itemSize in sparse Attribute.")}}return b}));r.clear(),e.accessors=n}}let We=class{static parse(e,i){const{gltf:s,accessors:r,materials:n,bufferViews:o}=e;if(!s.meshes)return;const a=i.extensions.get("KHR_draco_mesh_compression"),l=new Map,c=new Map,h=[];for(let e=0;e<s.meshes.length;e++){const d=s.meshes[e],u=[];for(let e=0;e<d.primitives.length;e++){const h=d.primitives[e],{extensions:p={},mode:m,material:f}=h,{KHR_draco_mesh_compression:g}=p;let _;const b=et(h);c.has(b)?_=c.get(b):(_=g&&a?a.getGeometry(g,o,h.attributes,s.accessors,i.getDRACOLoader()):Promise.resolve(new t.Geometry),_=_.then((e=>(Ye(e,h,s,r),e))),c.set(b,_));const y=_.then((e=>{const i={mode:m,geometry:e,material:void 0===f?new t.PBRMaterial:n[f],weights:Object.keys(e.morphAttributes).length>0&&d.weights?d.weights.slice(0):void 0,skinned:d.isSkinned};return Je(i,l),i}));u.push(y)}h.push(Promise.all(u))}return l.clear(),c.clear(),Promise.all(h).then((t=>{e.primitives=t}))}};function Ye(e,t,i,s){const{attributes:r,indices:n,targets:o}=t;for(const t in r){const i=r[t],n=void 0===Ue[t]?t:Ue[t];n in e.attributes||e.addAttribute(n,s[i])}void 0===n||e.index||e.setIndex(s[n]);const{boundingBox:a,boundingSphere:l}=e;if(void 0!==r.POSITION){const t=r.POSITION,s=i.accessors[t];if(s.min&&s.max){if(a.min.fromArray(s.min),a.max.fromArray(s.max),s.normalized){const e=Pe.getNormalizedComponentScale(ke[s.componentType]);a.min.multiplyScalar(e),a.max.multiplyScalar(e)}}else e.computeBoundingBox()}else e.computeBoundingBox();if(a.getCenter(l.center),l.radius=a.min.distanceTo(a.max)/2,o){let t=!1,i=!1;for(let e=0,s=o.length;e<s;e++){const s=o[e];if(void 0!==s.POSITION&&(t=!0),void 0!==s.NORMAL&&(i=!0),t&&i)break}if(t||i){const r=[],n=[];for(let a=0,l=o.length;a<l;a++){const l=o[a];t&&r.push(void 0!==l.POSITION?s[l.POSITION]:e.attributes[Ue.POSITION]),i&&n.push(void 0!==l.NORMAL?s[l.NORMAL]:e.attributes[Ue.NORMAL])}t&&(e.morphAttributes.position=r),i&&(e.morphAttributes.normal=n)}}return e}function Je(e,i){let{geometry:s,material:r,skinned:n,mode:o}=e;const a=void 0!==s.attributes[Ue.TANGENT],l=void 0!==s.attributes[Ue.COLOR_0],c=void 0===s.attributes[Ue.NORMAL],h=n;if(o===He){const e="PointsMaterial:"+r.id;let s=i.get(e);s||(s=new t.PointsMaterial,t.Material.prototype.copy.call(s,r),s.diffuse.copy(r.diffuse),s.diffuseMap=r.map,s.drawMode=o,s.acceptLight=!1,i.set(e,s)),r=s}else if(o===je||o===$e||o===Ke){const e="BasicMaterial:"+r.id;let s=i.get(e);s||(s=new t.BasicMaterial,s.envMap=void 0,s.diffuse.copy(r.diffuse),s.diffuseMap=r.diffuseMap,s.drawMode=o,i.set(e,s)),r=s}else o===Xe?(console.warn("TRIANGLE_STRIP will be removed later."),r.drawMode=Xe):o===qe&&(console.warn("TRIANGLE_FAN will be removed later."),r.drawMode=qe);if(a||l||c||h){let e="ClonedMaterial:"+r.id+":";a&&(e+="vertex-tangents:"),l&&(3===s.attributes[Ue.COLOR_0].size?e+="vertex-colors-rgb:":4===s.attributes[Ue.COLOR_0].size&&(e+="vertex-colors-rgba:")),c&&(e+="flat-shading:");let n=i.get(e);n||(n=r.clone(),a&&(n.vertexTangents=!0,n.normalMap&&(n.normalScale.y*=-1)),l&&(3===s.attributes[Ue.COLOR_0].size?n.vertexColors=t.VERTEX_COLOR.RGB:4===s.attributes[Ue.COLOR_0].size?n.vertexColors=t.VERTEX_COLOR.RGBA:console.warn("Illegal vertex color size: "+s.attributes[Ue.COLOR_0].size)),c&&(n.shading=t.SHADING_TYPE.FLAT_SHADING)),r=n}e.material=r}function et(e){const t=e.extensions&&e.extensions.KHR_draco_mesh_compression;let i;if(i=t?"draco:"+t.bufferView+":"+t.indices+":"+tt(t.attributes):e.indices+":"+tt(e.attributes)+":"+e.mode,e.targets)for(let t=0,s=e.targets.length;t<s;t++)i+=":"+tt(e.targets[t]);return i}function tt(e){let t="";const i=Object.keys(e).sort();for(let s=0,r=i.length;s<r;s++)t+=i[s]+":"+e[i[s]]+";";return t}class it{static parse(e,i){const{gltf:{nodes:s,cameras:r,extensions:n}}=e;if(!s)return;const o=i.extensions.get("KHR_lights_punctual"),a=i.extensions.get("EXT_mesh_gpu_instancing"),l=[],c=[],h=s.map((i=>{const{matrix:s,translation:h,rotation:d,scale:u,camera:p,mesh:m,extensions:f={}}=i,{KHR_lights_punctual:g,EXT_mesh_gpu_instancing:_}=f;let b=null;if(i.isBone)b=new t.Bone;else if(void 0!==m)b=_&&a?a.getInstancedMesh(e,i):function(e,i){const{primitives:s}=e,{mesh:r,skin:n}=i,o=s[r].map((e=>{const{geometry:i,material:s,weights:r}=e;let o;return void 0!==n?(o=new t.SkinnedMesh(i,s),i.attributes.skinWeight&&!i.attributes.skinWeight.normalized&&Pe.normalizeSkinWeights(i.attributes.skinWeight)):(o=new t.Mesh(i,s),r&&(o.morphTargetInfluences=r.slice())),o}));if(o.length>1){const e=new t.Object3D;return o.forEach((t=>e.add(t))),e}return o[0]}(e,i);else if(void 0!==p)b=function(e){const{orthographic:i,perspective:s,type:r}=e,n=new t.Camera;if("perspective"==r){const{aspectRatio:e,yfov:t,zfar:i,znear:r}=s;n.setPerspective(t,e||1,r||1,i||2e6)}else if("orthographic"==r){const{xmag:e,ymag:t,zfar:s,znear:r}=i;n.setOrtho(-e,e,-t,t,r||1,s||2e6)}return n}(r[p]),l.push(b);else if(g&&o){const e=g.light,t=n.KHR_lights_punctual.lights;b=o.getLight(t[e]),c.push(b)}else b=new t.Object3D;if(b.name=i.name||"",b.name&&b.children.length>0)for(let e=0;e<b.children.length;e++)b.children[e].name=b.name+"_"+e;return void 0!==s?(b.matrix.fromArray(s),b.matrix.decompose(b.position,b.quaternion,b.scale)):(void 0!==h&&b.position.fromArray(h),void 0!==d&&b.quaternion.fromArray(d),void 0!==u&&b.scale.fromArray(u)),b}));e.nodes=h,e.cameras=l,e.lights=c}}class st{static parse(e){const{gltf:i,accessors:s,nodes:r}=e,n=i.skins;if(!n)return;const o=n.map((e=>{const{inverseBindMatrices:i,joints:n}=e,o=s[i],a=[],l=[];return n.forEach(((e,i)=>{const s=r[e];if(s){a.push(s);const e=new t.Matrix4;o&&e.fromArray(o.buffer.array,16*i),l.push(e)}else console.warn("Joint "+e+" could not be found.")})),new t.Skeleton(a,l)}));e.skins=o,r.forEach(((e,t)=>{const{skin:s}=i.nodes[t];void 0!==s&&e.traverse((function(e){e.isSkinnedMesh&&e.bind(o[s],e.worldMatrix)}))}))}}class rt{static parse(e){const{gltf:i,nodes:s}=e,r=i.scenes.map((e=>{const{name:r="",nodes:n=[]}=e,o=new t.Object3D;o.name=r;for(let e=0;e<n.length;e++)nt(n[e],o,i.nodes,s);return o}));e.roots=r,e.root=r[i.scene||0]}}function nt(e,t,i,s){const r=s[e],n=i[e];if(t.add(r),n.children){const e=n.children;for(let t=0,n=e.length;t<n;t++){nt(e[t],r,i,s)}}}class ot{static parse(e){const{gltf:i,nodes:s,accessors:r}=e,{animations:n}=i;if(!n)return;const o=n.map(((e,i)=>{const{channels:n,samplers:o,name:a=`animation_${i}`}=e,l=[];let c=0;for(let e=0;e<n.length;e++){const i=n[e],a=o[i.sampler];if(a){const e=i.target,n=void 0!==e.node?e.node:e.id,o=r[a.input],h=r[a.output],d=s[n];if(!d)continue;let u;switch(d.updateMatrix(),d.matrixAutoUpdate=!0,Ve[e.path]){case Ve.rotation:u=t.QuaternionKeyframeTrack;break;case Ve.weights:u=t.NumberKeyframeTrack;break;default:u=t.VectorKeyframeTrack}if(!u)continue;const p=new o.buffer.array.constructor(o.buffer.array),m=new Float32Array(h.buffer.array);if(h.normalized){const e=Pe.getNormalizedComponentScale(h.buffer.array.constructor);for(let t=0,i=m.length;t<i;t++)m[t]*=e}const f=[];Ve[e.path]===Ve.weights?d.traverse((function(e){e.isMesh&&e.morphTargetInfluences&&f.push(e)})):f.push(d);for(let i=0,s=f.length;i<s;i++){const s=at(a.interpolation,u===t.QuaternionKeyframeTrack),r=new u(f[i],Ve[e.path],p,m,s);l.push(r)}const g=p[p.length-1];c<g&&(c=g)}}return new t.KeyframeClip(a,l,c)}));e.animations=o}}function at(e,i){switch(e){case"STEP":return t.StepInterpolant;case"CUBICSPLINE":return i?t.QuaternionCubicSplineInterpolant:t.CubicSplineInterpolant;default:return i?t.QuaternionLinearInterpolant:t.LinearInterpolant}}let lt=0;class ct{constructor(){this.id=++lt,this.url="",this.path="",this.options=null,this.gltf=null,this.loadItems=null,this.buffers=null,this.bufferViews=null,this.images=null,this.textures=null,this.materials=null,this.accessors=null,this.primitives=null,this.nodes=null,this.cameras=null,this.lights=null,this.skins=null,this.root=null,this.roots=null,this.animations=null}}class ht{static getMaterial(){return new t.PBRMaterial}static parseParams(e,i,s){const{clearcoatFactor:r,clearcoatTexture:n,clearcoatRoughnessFactor:o,clearcoatRoughnessTexture:a,clearcoatNormalTexture:l}=i;if(r&&(e.clearcoat=r),n&&(e.clearcoatMap=s[n.index]),o&&(e.clearcoatRoughness=o),a&&(e.clearcoatRoughnessMap=s[a.index]),l&&(e.clearcoatNormalMap=s[l.index],l.scale)){const i=l.scale;e.clearcoatNormalScale=new t.Vector2(i,i)}}}class dt{static getMaterial(){return new t.PBR2Material}static parseParams(e,i,s,r){const{diffuseFactor:n,diffuseTexture:o,specularFactor:a,glossinessFactor:l,specularGlossinessTexture:c}=i;Array.isArray(n)&&(e.diffuse.fromArray(n),e.opacity=n[3]||1),o&&(e.diffuseMap=s[o.index],e.diffuseMapCoord=o.texCoord||0,e.diffuseMap&&(e.diffuseMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,r&&r.handleMaterialMap(e,"diffuseMap",o))),e.glossiness=void 0!==l?l:1,Array.isArray(a)&&e.specular.fromArray(a),c&&(e.glossinessMap=s[c.index],e.specularMap=s[c.index])}}const ut=[class{static parse(e,t){const{url:i}=e;return t.loadFile(i,"arraybuffer").then((t=>{if("glTF"===Pe.decodeText(new Uint8Array(t,0,4))){const i=Pe.parseGLB(t);e.gltf=i.gltf,e.buffers=i.buffers}else{const i=Pe.decodeText(new Uint8Array(t));e.gltf=JSON.parse(i)}}))}},Ce,Le,Re,De,Oe,Ze,class{static parse(e,i){const{gltf:s,textures:r}=e;if(!s.materials)return;const n=i.extensions.get("KHR_texture_transform"),o=i.extensions.get("KHR_materials_unlit"),a=i.extensions.get("KHR_materials_pbrSpecularGlossiness"),l=i.extensions.get("KHR_materials_clearcoat"),c=[];for(let e=0;e<s.materials.length;e++){const{extensions:i={},pbrMetallicRoughness:h,normalTexture:d,occlusionTexture:u,emissiveTexture:p,emissiveFactor:m,alphaMode:f,alphaCutoff:g,doubleSided:_,name:b=""}=s.materials[e],{KHR_materials_unlit:y,KHR_materials_pbrSpecularGlossiness:x,KHR_materials_clearcoat:M}=i;let v=null;if(y&&o?v=o.getMaterial():x&&a?(v=a.getMaterial(),a.parseParams(v,x,r,n)):M&&l?(v=l.getMaterial(),l.parseParams(v,M,r)):v=new t.PBRMaterial,v.name=b,h){const{baseColorFactor:e,baseColorTexture:i,metallicFactor:s,roughnessFactor:o,metallicRoughnessTexture:a}=h;Array.isArray(e)&&(v.diffuse.fromArray(e),v.opacity=void 0!==e[3]?e[3]:1),i&&(v.diffuseMap=r[i.index],v.diffuseMapCoord=i.texCoord||0,v.diffuseMap&&(v.diffuseMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,n&&n.handleMaterialMap(v,"diffuseMap",i))),y||x||(v.metalness=void 0!==s?s:1,v.roughness=void 0!==o?o:1,a&&(v.metalnessMap=r[a.index],v.roughnessMap=r[a.index]))}m&&v.emissive.fromArray(m),p&&(v.emissiveMap=r[p.index],v.emissiveMapCoord=p.texCoord||0,v.emissiveMap&&(v.emissiveMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,n&&n.handleMaterialMap(v,"emissiveMap",p))),u&&(v.aoMap=r[u.index],v.aoMapCoord=u.texCoord||0,void 0!==u.strength&&(v.aoMapIntensity=u.strength),v.aoMap&&n&&n.handleMaterialMap(v,"aoMap",u)),y||d&&(v.normalMap=r[d.index],v.normalScale.set(1,-1),void 0!==d.scale&&v.normalScale.set(d.scale,-d.scale)),v.side=!0===_?t.DRAW_SIDE.DOUBLE:t.DRAW_SIDE.FRONT,f===Be?v.transparent=!0:(v.transparent=!1,f===Fe&&(v.alphaTest=void 0!==g?g:.5)),c[e]=v}e.materials=c}},Qe,We,it,st,rt,ot],pt=new Map([["EXT_meshopt_compression",class{static loadBufferView(e,t,i){const s=t[e.buffer];if(!i||!i.supported)throw new Error("GLTFLoader: setMeshoptDecoder must be called before loading compressed files.");const r=e.byteOffset||0,n=e.byteLength||0,o=e.count,a=e.byteStride,l=new Uint8Array(s,r,n);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,a,l,e.mode,e.filter).then((e=>e.buffer)):i.ready.then((()=>{const t=new ArrayBuffer(o*a);return i.decodeGltfBuffer(new Uint8Array(t),o,a,l,e.mode,e.filter),t}))}}],["KHR_draco_mesh_compression",class{static getGeometry(e,t,i,s,r){const{bufferView:n,attributes:o}=e;if(!r)throw new Error("GLTFLoader: No DRACOLoader instance provided.");const a={};for(const e in o){a[void 0===Ue[e]?e:Ue[e]]=o[e]}const l={},c={};for(const e in i){const t=Ue[e]||e.toLowerCase();if(void 0!==o[e]){const r=s[i[e]],n=ke[r.componentType];c[t]=n.name,l[t]=!0===r.normalized}}const h=t[n];return new Promise((function(e){r.decodeDracoFile(h,(function(t){for(const e in t.attributes){const i=t.attributes[e],s=l[e];void 0!==s&&(i.normalized=s)}e(t)}),a,c)}))}}],["KHR_lights_punctual",class{static getLight(e){const{color:i,intensity:s=1,type:r,range:n,spot:o}=e;let a;if("directional"===r)a=new t.DirectionalLight;else if("point"===r)a=new t.PointLight,void 0!==n&&(a.distance=n);else{if("spot"!==r)throw new Error("Unexpected light type: "+r);if(a=new t.SpotLight,void 0!==n&&(a.distance=n),o){const{innerConeAngle:e=0,outerConeAngle:t=Math.PI/4}=o;a.angle=t,a.penumbra=1-e/t}}return i&&a.color.fromArray(i),a.intensity=s,a}}],["KHR_materials_clearcoat",ht],["KHR_materials_pbrSpecularGlossiness",dt],["KHR_materials_unlit",class{static getMaterial(){return new t.BasicMaterial}}],["KHR_mesh_quantization",{}],["KHR_texture_basisu",class{static loadTextureData(e,t){return new Promise(((i,s)=>{t.load(e,i,void 0,s)}))}}],["KHR_texture_transform",class{static handleMaterialMap(e,t,i){if(!i.extensions)return;const s=i.extensions.KHR_texture_transform;if(!s)return;let r=0,n=0,o=1,a=1,l=0;void 0!==s.offset&&(r=s.offset[0],n=s.offset[1]),void 0!==s.rotation&&(l=s.rotation),void 0!==s.scale&&(o=s.scale[0],a=s.scale[1]);const c=e[t+"Transform"];c&&c.setUvTransform(r,n,o,a,l,0,0),void 0!==s.texCoord&&(e[t+"Coord"]=s.texCoord)}}]]);class mt{constructor(e=t.DefaultLoadingManager,i=ut,s=pt){this.manager=e,this.detailLoadProgress=!0,this.autoLogError=!0,this.extensions=new Map(s),this._parsers=i.slice(0),this._dracoLoader=null,this._meshoptDecoder=null,this._ktx2Loader=null,this._fileLoader=new t.FileLoader;const r=navigator.userAgent,n=!0===/^((?!chrome|android).)*safari/i.test(r),o=r.match(/Version\/(\d+)/),a=n&&o?parseInt(o[1],10):-1,l=r.indexOf("Firefox")>-1,c=l?r.match(/Firefox\/([0-9]+)\./)[1]:-1;"undefined"==typeof createImageBitmap||n&&a<17||l&&c<98?this._imageLoader=new t.ImageLoader:this._imageLoader=new Ee}load(e,t={}){return this.manager.itemStart(e),new Promise(((i,s)=>{const r=new ct;r.url=e,r.path=Pe.extractUrlBase(e),r.options=t,this._parse(r).then(i).then((()=>this.manager.itemEnd(e))).catch((t=>{this.autoLogError&&console.error(t),this.detailLoadProgress&&r.loadItems&&r.loadItems.forEach((e=>{this.manager.itemEnd(e)})),this.manager.itemError(e),this.manager.itemEnd(e),s(`Error loading glTF model from ${e} .`)}))}))}_parse(e){let t;return new Promise(((i,s)=>{this._parsers.forEach((i=>{t=t?t.then((()=>i.parse(e,this))):i.parse(e,this)})),t?t.then((()=>i(e))).catch(s):i(e)}))}setDRACOLoader(e){return this._dracoLoader=e,this}getDRACOLoader(){return this._dracoLoader}setMeshoptDecoder(e){return this._meshoptDecoder=e,this}getMeshoptDecoder(){return this._meshoptDecoder}setKTX2Loader(e){return this._ktx2Loader=e,this}getKTX2Loader(){return this._ktx2Loader}loadFile(e,t="json"){return this._fileLoader.setResponseType(t),new Promise(((t,i)=>{e=this.manager.resolveURL(e),this._fileLoader.load(e,t,void 0,i)}))}loadImage(e){return new Promise(((t,i)=>{e=this.manager.resolveURL(e),this._imageLoader.load(e,t,void 0,i)}))}insertParser(e,t){this._parsers.splice(t,0,e)}replaceParser(e,t){this._parsers.splice(t,1,e)}}class ft{static parse(e,t){const i=e.options.buffer,s=new DataView(i),r=String.fromCharCode(s.getUint8(0))+String.fromCharCode(s.getUint8(1))+String.fromCharCode(s.getUint8(2))+String.fromCharCode(s.getUint8(3)),n=te(e.url);if(r!==n)throw`Not a ${n} type resource, with url ${e.url}!`;const o=s.getUint32(4,!0);if(1!==o)throw`${n} version must be 1, with url ${e.url}!`;const a=s.getUint32(8,!0);if(a!==i.byteLength)throw`${n} data byte length check failed, with url ${e.url}!`;if("cmpt"===n){const t=s.getUint32(12,!0);return void(e.header={magic:r,version:o,byteLength:a,tilesLength:t})}const l=s.getUint32(12,!0),c=s.getUint32(16,!0),h=s.getUint32(20,!0),d=s.getUint32(24,!0);let u=null;"i3dm"===n&&(u=s.getUint32(28,!0)),e.header={magic:r,version:o,byteLength:a,featureTableJSONByteLength:l,featureTableBinaryByteLength:c,batchTableJSONByteLength:h,batchTableBinaryByteLength:d,gltfFormat:u}}}class gt{constructor(e,t,i,s){this.buffer=e,this.binOffset=t+i,this.binLength=s;let r=null;if(0!==i){const s=new Uint8Array(e,t,i);r=JSON.parse(Pe.decodeText(s))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,i=null,s=null){const r=this.header;if(!(e in r))return null;const n=r[e];if(n instanceof Object){if(Array.isArray(n))return n;{const{buffer:r,binOffset:o,binLength:a}=this,l=n.byteOffset||0,c=n.type||s,h=n.componentType||i;if("type"in n&&s&&n.type!==s)throw new Error("FeatureTable: Specified type does not match expected type.");let d,u;switch(c){case"SCALAR":d=1;break;case"VEC2":d=2;break;case"VEC3":d=3;break;case"VEC4":d=4;break;default:throw new Error(`FeatureTable: Feature type not provided for "${e}".`)}const p=o+l,m=t*d;switch(h){case"BYTE":u=new Int8Array(r,p,m);break;case"UNSIGNED_BYTE":u=new Uint8Array(r,p,m);break;case"SHORT":u=new Int16Array(r,p,m);break;case"UNSIGNED_SHORT":u=new Uint16Array(r,p,m);break;case"INT":u=new Int32Array(r,p,m);break;case"UNSIGNED_INT":u=new Uint32Array(r,p,m);break;case"FLOAT":u=new Float32Array(r,p,m);break;case"DOUBLE":u=new Float64Array(r,p,m);break;default:throw new Error(`FeatureTable: Feature component type not provided for "${e}".`)}if(p+m*u.BYTES_PER_ELEMENT>o+a)throw new Error("FeatureTable: Feature data read outside binary body length.");return u}}return n}}class _t extends gt{constructor(e,t,i,s,r){super(e,i,s,r),this.batchSize=t}getData(e,t=null,i=null){return super.getData(e,this.batchSize,t,i)}}class bt{static parse(e,t){const{header:i,options:s}=e,r=s.buffer,n="i3dm"===i.magic?32:28,o=n+i.featureTableJSONByteLength+i.featureTableBinaryByteLength,a=o,l=a+i.batchTableJSONByteLength+i.batchTableBinaryByteLength,c=r.slice(n,o),h=new gt(c,0,i.featureTableJSONByteLength,i.featureTableBinaryByteLength);let d;if("b3dm"===i.magic)d=h.getData("BATCH_LENGTH");else if("i3dm"===i.magic)d=h.getData("INSTANCES_LENGTH");else{if("pnts"!==i.magic)throw`Unrecognized magic: ${i.magic}!`;d=h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH")}const u=r.slice(a,l),p=new _t(u,d,0,i.batchTableJSONByteLength,i.batchTableBinaryByteLength);e.featureTable=h,e.batchTable=p,e.batchTableEnd=l}}class yt{static parse(e,t){const i=new Uint8Array(e.options.buffer,e.batchTableEnd,e.header.byteLength-e.batchTableEnd),s=Pe.parseGLB(i.slice().buffer);e.gltf=s.gltf,e.buffers=s.buffers}}let xt=class{static parse(e,i){const{gltf:s,textures:r}=e;if(!s.materials)return;const n=i.extensions.get("KHR_texture_transform"),o=i.extensions.get("KHR_materials_unlit"),a=i.extensions.get("KHR_materials_pbrSpecularGlossiness"),l=i.extensions.get("KHR_materials_clearcoat"),c=i.extensions.get("KHR_techniques_webgl"),h=[];for(let e=0;e<s.materials.length;e++){const{extensions:i={},pbrMetallicRoughness:d,normalTexture:u,occlusionTexture:p,emissiveTexture:m,emissiveFactor:f,alphaMode:g,alphaCutoff:_,doubleSided:b,name:y=""}=s.materials[e],{KHR_materials_unlit:x,KHR_materials_pbrSpecularGlossiness:M,KHR_materials_clearcoat:v,KHR_techniques_webgl:T}=i;let A=null;if(x&&o?A=o.getMaterial():M&&a?(A=a.getMaterial(),a.parseParams(A,M,r,n)):v&&l?(A=l.getMaterial(),l.parseParams(A,v,r)):T&&c?(A=c.getMaterial(),c.parseParams(A,T,r)):A=new t.PBRMaterial,A.name=y,d){const{baseColorFactor:e,baseColorTexture:i,metallicFactor:s,roughnessFactor:o,metallicRoughnessTexture:a}=d;Array.isArray(e)&&(A.diffuse.fromArray(e),A.opacity=void 0!==e[3]?e[3]:1),i&&(A.diffuseMap=r[i.index],A.diffuseMapCoord=i.texCoord||0,A.diffuseMap&&(A.diffuseMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,n&&n.handleMaterialMap(A,"diffuseMap",i))),x||M||(A.metalness=void 0!==s?s:1,A.roughness=void 0!==o?o:1,a&&(A.metalnessMap=r[a.index],A.roughnessMap=r[a.index]))}f&&A.emissive.fromArray(f),m&&(A.emissiveMap=r[m.index],A.emissiveMapCoord=m.texCoord||0,A.emissiveMap&&(A.emissiveMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,n&&n.handleMaterialMap(A,"emissiveMap",m))),p&&(A.aoMap=r[p.index],A.aoMapCoord=p.texCoord||0,void 0!==p.strength&&(A.aoMapIntensity=p.strength),A.aoMap&&n&&n.handleMaterialMap(A,"aoMap",p)),x||u&&(A.normalMap=r[u.index],A.normalScale.set(1,-1),void 0!==u.scale&&A.normalScale.set(u.scale,-u.scale)),A.side=!0===b?t.DRAW_SIDE.DOUBLE:t.DRAW_SIDE.FRONT,g===Be?A.transparent=!0:(A.transparent=!1,g===Fe&&(A.alphaTest=void 0!==_?_:.5)),h[e]=A}e.materials=h}};class Mt{static parse(e,t){const{root:i,featureTable:s,options:r}=e,n=s.getData("RTC_CENTER");n&&(i.position.x+=n[0],i.position.y+=n[1],i.position.z+=n[2]),r.adjustmentTransform&&(i.matrix.transform(i.position,i.scale,i.quaternion),i.matrix.multiply(r.adjustmentTransform),i.matrix.decompose(i.position,i.quaternion,i.scale))}}class vt{static getMaterial(){return new t.PBRMaterial}static parseParams(e,t,i){const{values:s}=t,{u_diffuse:r}=s;r&&(e.diffuseMap=i[r.index],e.diffuseMapCoord=r.texCoord||0)}}class Tt extends mt{constructor(e){super(e,[ft,bt,yt,Ce,Le,Re,De,Oe,Ze,xt,Qe,We,it,st,rt,ot,Mt]),this.extensions.set("KHR_techniques_webgl",vt)}}class At{static parse(e,t){const i=new Uint8Array(e.options.buffer,e.batchTableEnd,e.header.byteLength-e.batchTableEnd);let s=null;if(1===e.header.gltfFormat)s=Promise.resolve(i);else{const r=Pe.resolveURL(Pe.decodeText(i),e.path);s=t.loadFile(r,"arraybuffer").then((e=>new Uint8Array(e)))}return s.then((t=>{const i=Pe.parseGLB(t.slice().buffer);e.gltf=i.gltf,e.buffers=i.buffers}))}}const wt="\n\t\t#ifdef USE_INSTANCING\n\t\t\t\tattribute mat4 instanceMatrix;\n\t\t#endif\n",Et="\n\t\t#ifdef USE_INSTANCING\n\t\t\t\ttransformed = (instanceMatrix * vec4(transformed, 1.0)).xyz;\n\t\t#endif\n",St="\n\t\t#ifdef USE_INSTANCING\n\t\t\t\t#ifdef USE_INSTANCING\n\t\t\t\t\t\tobjectNormal = (transposeMat4(inverseMat4(instanceMatrix)) * vec4(objectNormal, 0.0)).xyz;\n\t\t\t\t#endif\n\n\t\t\t\t#ifdef USE_TANGENT\n\t\t\t\t\t\tobjectTangent = (transposeMat4(inverseMat4(instanceMatrix)) * vec4(objectTangent, 0.0)).xyz;\n\t\t\t\t#endif\n\t\t#endif\n";class Pt extends t.PBRMaterial{constructor(){super(),this.type=t.MATERIAL_TYPE.SHADER,this.shaderName="TILE_I_PBR",this.vertexShader=Ct,this.fragmentShader=t.ShaderLib.pbr_frag,this.defines.USE_INSTANCING=!0}}Pt.prototype.isInstancedPBRMaterial=!0;let Ct=t.ShaderLib.pbr_vert;Ct=Ct.replace("#include <logdepthbuf_pars_vert>",`\n\t\t#include <logdepthbuf_pars_vert>\n\t\t${wt}\n`),Ct=Ct.replace("#include <pvm_vert>",`\n\t\t${Et}\n\t\t#include <pvm_vert>\n`),Ct=Ct.replace("#include <normal_vert>",`\n\t\t${St}\n\t\t#include <normal_vert>\n`);class Lt{static parse(e,i){const{gltf:s,textures:r}=e;if(!s.materials)return;const n=i.extensions.get("KHR_texture_transform"),o=i.extensions.get("KHR_materials_unlit"),a=i.extensions.get("KHR_materials_pbrSpecularGlossiness"),l=i.extensions.get("KHR_materials_clearcoat"),c=i.extensions.get("KHR_techniques_webgl"),h=[];for(let e=0;e<s.materials.length;e++){const{extensions:i={},pbrMetallicRoughness:d,normalTexture:u,occlusionTexture:p,emissiveTexture:m,emissiveFactor:f,alphaMode:g,alphaCutoff:_,doubleSided:b,name:y=""}=s.materials[e],{KHR_materials_unlit:x,KHR_materials_pbrSpecularGlossiness:M,KHR_materials_clearcoat:v,KHR_techniques_webgl:T}=i;let A=null;if(x&&o?A=o.getMaterial():M&&a?(A=a.getMaterial(),a.parseParams(A,M,r,n)):v&&l?(A=l.getMaterial(),l.parseParams(A,v,r)):T&&c?(A=c.getMaterial(),c.parseParams(A,T,r)):A=new Pt,A.name=y,d){const{baseColorFactor:e,baseColorTexture:i,metallicFactor:s,roughnessFactor:o,metallicRoughnessTexture:a}=d;Array.isArray(e)&&(A.diffuse.fromArray(e),A.opacity=void 0!==e[3]?e[3]:1),i&&(A.diffuseMap=r[i.index],A.diffuseMapCoord=i.texCoord||0,A.diffuseMap&&(A.diffuseMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,n&&n.handleMaterialMap(A,"diffuseMap",i))),x||M||(A.metalness=void 0!==s?s:1,A.roughness=void 0!==o?o:1,a&&(A.metalnessMap=r[a.index],A.roughnessMap=r[a.index]))}f&&A.emissive.fromArray(f),m&&(A.emissiveMap=r[m.index],A.emissiveMapCoord=m.texCoord||0,A.emissiveMap&&(A.emissiveMap.encoding=t.TEXEL_ENCODING_TYPE.SRGB,n&&n.handleMaterialMap(A,"emissiveMap",m))),p&&(A.aoMap=r[p.index],A.aoMapCoord=p.texCoord||0,void 0!==p.strength&&(A.aoMapIntensity=p.strength),A.aoMap&&n&&n.handleMaterialMap(A,"aoMap",p)),x||u&&(A.normalMap=r[u.index],A.normalScale.set(1,-1),void 0!==u.scale&&A.normalScale.set(u.scale,-u.scale)),A.side=!0===b?t.DRAW_SIDE.DOUBLE:t.DRAW_SIDE.FRONT,g===Be?A.transparent=!0:(A.transparent=!1,g===Fe&&(A.alphaTest=void 0!==_?_:.5)),h[e]=A}e.materials=h}}class Rt{static parse(e,i){const{gltf:s,accessors:r,materials:n,bufferViews:o}=e;if(!s.meshes)return;const a=i.extensions.get("KHR_draco_mesh_compression"),l=new Map,c=new Map,h=[];for(let e=0;e<s.meshes.length;e++){const d=s.meshes[e],u=[];for(let e=0;e<d.primitives.length;e++){const h=d.primitives[e],{extensions:p={},mode:m,material:f}=h,{KHR_draco_mesh_compression:g}=p;let _;const b=It(h);c.has(b)?_=c.get(b):(_=g&&a?a.getGeometry(g,o,h.attributes,s.accessors,i.getDRACOLoader()):Promise.resolve(new t.Geometry),_=_.then((e=>(Dt(e,h,s,r),e))),c.set(b,_));const y=_.then((e=>{const t={mode:m,geometry:e,material:void 0===f?new Pt:n[f],weights:Object.keys(e.morphAttributes).length>0&&d.weights?d.weights.slice(0):void 0,skinned:d.isSkinned};return Ot(t,l),t}));u.push(y)}h.push(Promise.all(u))}return l.clear(),c.clear(),Promise.all(h).then((t=>{e.primitives=t}))}}function Dt(e,t,i,s){const{attributes:r,indices:n,targets:o}=t;for(const t in r){const i=r[t],n=void 0===Ue[t]?t:Ue[t];n in e.attributes||e.addAttribute(n,s[i])}void 0===n||e.index||e.setIndex(s[n]);const{boundingBox:a,boundingSphere:l}=e;if(void 0!==r.POSITION){const t=r.POSITION,s=i.accessors[t];if(s.min&&s.max){if(a.min.fromArray(s.min),a.max.fromArray(s.max),s.normalized){const e=Pe.getNormalizedComponentScale(ke[s.componentType]);a.min.multiplyScalar(e),a.max.multiplyScalar(e)}}else e.computeBoundingBox()}else e.computeBoundingBox();if(a.getCenter(l.center),l.radius=a.min.distanceTo(a.max)/2,o){let t=!1,i=!1;for(let e=0,s=o.length;e<s;e++){const s=o[e];if(void 0!==s.POSITION&&(t=!0),void 0!==s.NORMAL&&(i=!0),t&&i)break}if(t||i){const r=[],n=[];for(let a=0,l=o.length;a<l;a++){const l=o[a];t&&r.push(void 0!==l.POSITION?s[l.POSITION]:e.attributes[Ue.POSITION]),i&&n.push(void 0!==l.NORMAL?s[l.NORMAL]:e.attributes[Ue.NORMAL])}t&&(e.morphAttributes.position=r),i&&(e.morphAttributes.normal=n)}}return e}function Ot(e,i){let{geometry:s,material:r,skinned:n,mode:o}=e;const a=void 0!==s.attributes[Ue.TANGENT],l=void 0!==s.attributes[Ue.COLOR_0],c=void 0===s.attributes[Ue.NORMAL],h=n;if(o===He){const e="PointsMaterial:"+r.id;let s=i.get(e);s||(s=new t.PointsMaterial,t.Material.prototype.copy.call(s,r),s.diffuse.copy(r.diffuse),s.diffuseMap=r.map,s.drawMode=o,s.acceptLight=!1,i.set(e,s)),r=s}else if(o===je||o===$e||o===Ke){const e="BasicMaterial:"+r.id;let s=i.get(e);s||(s=new t.BasicMaterial,s.envMap=void 0,s.diffuse.copy(r.diffuse),s.diffuseMap=r.diffuseMap,s.drawMode=o,i.set(e,s)),r=s}else o===Xe?(console.warn("TRIANGLE_STRIP will be removed later."),r.drawMode=Xe):o===qe&&(console.warn("TRIANGLE_FAN will be removed later."),r.drawMode=qe);if(a||l||c||h){let e="ClonedMaterial:"+r.id+":";a&&(e+="vertex-tangents:"),l&&(3===s.attributes[Ue.COLOR_0].size?e+="vertex-colors-rgb:":4===s.attributes[Ue.COLOR_0].size&&(e+="vertex-colors-rgba:")),c&&(e+="flat-shading:");let n=i.get(e);n||(n=r.clone(),a&&(n.vertexTangents=!0,n.normalMap&&(n.normalScale.y*=-1)),l&&(3===s.attributes[Ue.COLOR_0].size?n.vertexColors=t.VERTEX_COLOR.RGB:4===s.attributes[Ue.COLOR_0].size?n.vertexColors=t.VERTEX_COLOR.RGBA:console.warn("Illegal vertex color size: "+s.attributes[Ue.COLOR_0].size)),c&&(n.shading=t.SHADING_TYPE.FLAT_SHADING)),r=n}e.material=r}function It(e){const t=e.extensions&&e.extensions.KHR_draco_mesh_compression;let i;if(i=t?"draco:"+t.bufferView+":"+t.indices+":"+Ut(t.attributes):e.indices+":"+Ut(e.attributes)+":"+e.mode,e.targets)for(let t=0,s=e.targets.length;t<s;t++)i+=":"+Ut(e.targets[t]);return i}function Ut(e){let t="";const i=Object.keys(e).sort();for(let s=0,r=i.length;s<r;s++)t+=i[s]+":"+e[i[s]]+";";return t}class Ft{static parse(e,i){const{featureTable:s,root:r,options:n}=e,o=s.getData("INSTANCES_LENGTH"),a=s.getData("POSITION",o,"FLOAT","VEC3"),l=s.getData("NORMAL_UP",o,"FLOAT","VEC3"),c=s.getData("NORMAL_RIGHT",o,"FLOAT","VEC3"),h=s.getData("SCALE",o,"FLOAT","SCALAR"),d=s.getData("SCALE_NON_UNIFORM",o,"FLOAT","VEC3");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","EAST_NORTH_UP","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in s.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const u=new t.Vector3;for(let e=0;e<o;e++)u.x+=a[3*e+0]/o,u.y+=a[3*e+1]/o,u.z+=a[3*e+2]/o;const p=[];r.traverse((e=>{if(e.isMesh){const{geometry:i}=e;i.instanceCount=o;const s=new t.Attribute(new t.Buffer(new Float32Array(16*o),16),16);s.divisor=1,i.addAttribute("instanceMatrix",s),e.updateMatrix(!0),e.position.copy(u).applyMatrix4(e.worldMatrix),p.push(e)}}));for(let e=0;e<o;e++){kt.fromArray(a,3*e).sub(u),l?(Vt.fromArray(l,3*e),Nt.fromArray(c,3*e),Bt.crossVectors(Nt,Vt).normalize(),Ht.set(Nt.x,Vt.x,Bt.x,0,Nt.y,Vt.y,Bt.y,0,Nt.z,Vt.z,Bt.z,0,0,0,0,1),zt.setFromRotationMatrix(Ht)):zt.set(0,0,0,1),h?Gt.set(h[e],h[e],h[e]):d?Gt.fromArray(d,3*e):Gt.set(1,1,1),Ht.transform(kt,Gt,zt).multiply(n.adjustmentTransform);for(let t=0,i=p.length;t<i;t++){const{geometry:i}=p[t],s=i.getAttribute("instanceMatrix").buffer.array;Ht.toArray(s,16*e),i.version++}}const m=s.getData("RTC_CENTER");m&&(r.position.x+=m[0],r.position.y+=m[1],r.position.z+=m[2])}}const Bt=new t.Vector3,Vt=new t.Vector3,Nt=new t.Vector3,kt=new t.Vector3,zt=new t.Quaternion,Gt=new t.Vector3,Ht=new t.Matrix4;class jt extends vt{static getMaterial(){return new Pt}}class Kt extends t.BasicMaterial{constructor(){super(),this.type=t.MATERIAL_TYPE.SHADER,this.shaderName="TILE_I_BASIC",this.vertexShader=$t,this.fragmentShader=t.ShaderLib.basic_frag,this.defines.USE_INSTANCING=!0}}Kt.prototype.isInstancedBasicMaterial=!0;let $t=t.ShaderLib.basic_vert;$t=$t.replace("#include <logdepthbuf_pars_vert>",`\n\t\t#include <logdepthbuf_pars_vert>\n\t\t${wt}\n`),$t=$t.replace("#include <pvm_vert>",`\n\t\t${Et}\n\t\t#include <pvm_vert>\n`),$t=$t.replace("#include <normal_vert>",`\n\t\t${St}\n\t\t#include <normal_vert>\n`);class Xt{static getMaterial(){return new Kt}}class qt extends dt{static getMaterial(){const e=new Pt;return e.specular=new t.Color3(1118481),e}}class Zt extends ht{static getMaterial(){return new Pt}}class Qt extends mt{constructor(e){super(e,[ft,bt,At,Ce,Le,Re,De,Oe,Ze,Lt,Qe,Rt,it,st,rt,ot,Ft]),this.extensions.set("KHR_techniques_webgl",jt),this.extensions.set("KHR_materials_unlit",Xt),this.extensions.set("KHR_materials_pbrSpecularGlossiness",qt),this.extensions.set("KHR_materials_clearcoat",Zt)}}class Wt{static parse(e,i){const{featureTable:s}=e,r=s.getData("POINTS_LENGTH"),n=s.getData("POSITION",r,"FLOAT","VEC3"),o=s.getData("RGB",r,"UNSIGNED_BYTE","VEC3"),a=s.getData("RGBA",r,"UNSIGNED_BYTE","VEC4");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","CONSTANT_RGBA","BATCH_LENGTH","POSITION_QUANTIZED","RGB565","NORMAL","NORMAL_OCT16P","BATCH_ID"].forEach((e=>{e in s.header&&console.warn(`PNTSLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const l=new t.Geometry;l.addAttribute("a_Position",new t.Attribute(new t.Buffer(n,3),3,0,!0)),l.computeBoundingBox(),l.computeBoundingSphere();const c=new t.PointsMaterial;c.size=2,c.sizeAttenuation=!1,null!==o?(l.addAttribute("a_Color",new t.Attribute(new t.Buffer(o,3),3,0,!0)),c.vertexColors=t.VERTEX_COLOR.RGB):null!==a&&(l.addAttribute("a_Color",new t.Attribute(new t.Buffer(a,4),4,0,!0)),c.vertexColors=t.VERTEX_COLOR.RGBA);const h=new t.Mesh(l,c);e.root=h;const d=s.getData("RTC_CENTER");d&&(h.position.x+=d[0],h.position.y+=d[1],h.position.z+=d[2])}}class Yt extends mt{constructor(e){super(e,[ft,bt,Wt])}}class Jt{static parse(e,t){const i=e.options.buffer,s=e.header.tilesLength,r=[];let n=16;for(let e=0;e<s;e++){const e=new DataView(i,n,12),t=String.fromCharCode(e.getUint8(0))+String.fromCharCode(e.getUint8(1))+String.fromCharCode(e.getUint8(2))+String.fromCharCode(e.getUint8(3)),s=e.getUint32(4,!0),o=e.getUint32(8,!0),a=new Uint8Array(i,n,o);r.push({type:t,buffer:a,version:s}),n+=o}e.tiles=r}}class ei{static parse(e,i){const{tiles:s,options:r,path:n}=e,o=r.adjustmentTransform,a=[];for(const e in s){const{type:t,buffer:l}=s[e],c={fetchOptions:r.fetchOptions,path:n,buffer:l.slice().buffer};"b3dm"!==t&&"i3dm"!==t||(c.adjustmentTransform=o);const h=i._loaders.get(t);h&&a.push(h.load(`${n}/temp.${t}`,c))}return Promise.all(a).then((e=>{const i=new t.Object3D;return e.forEach((e=>{i.add(e.root)})),{tiles:e,root:i}}))}}class ti extends mt{constructor(e){super(e,[ft,Jt,ei]);const t=new Tt(e),i=new Qt(e),s=new Yt(e);this._loaders=new Map([["b3dm",t],["i3dm",i],["pnts",s]])}setDRACOLoader(e){for(const t of this._loaders.values())t.setDRACOLoader(e);return super.setDRACOLoader(e)}setKTX2Loader(e){for(const t of this._loaders.values())t.setKTX2Loader(e);return super.setKTX2Loader(e)}}class ii{static parse(e,t){const{url:i,options:s}=e,r=s.buffer;if(si(i)){const t=Pe.parseGLB(r);e.gltf=t.gltf,e.buffers=t.buffers}else e.gltf=r}}const si=e=>"glb"===e.substring(e.lastIndexOf(".")+1);class ri extends mt{constructor(e){super(e),this.replaceParser(ii,0)}}class ni{constructor(e){const t=new Tt(e),i=new Qt(e),s=new Yt(e),r=new ti(e),n=new ri(e);this._loaders=new Map([["b3dm",t],["i3dm",i],["pnts",s],["cmpt",r],["gltf",n],["glb",n]])}setDRACOLoader(e){this._loaders.get("b3dm").setDRACOLoader(e),this._loaders.get("i3dm").setDRACOLoader(e),this._loaders.get("cmpt").setDRACOLoader(e),this._loaders.get("gltf").setDRACOLoader(e)}setKTX2Loader(e){this._loaders.get("b3dm").setKTX2Loader(e),this._loaders.get("i3dm").setKTX2Loader(e),this._loaders.get("cmpt").setKTX2Loader(e),this._loaders.get("gltf").setKTX2Loader(e)}loadTileContent(e,t,i,s){t._loadIndex=t._loadIndex||0,t._loadIndex++;const r=t.content.uri,n=r.split(/[\\\/]/g);n.pop();const o=n.join("/"),a=s.fetchOptions,l=t._loadIndex;let c=null;const h=s.rootTileSet.asset&&s.rootTileSet.asset.gltfUpAxis||"y",d=t.cached,u=d.transform;switch(h.toLowerCase()){case"x":oi.makeRotationAxis(li,-Math.PI/2);break;case"y":oi.makeRotationAxis(ai,Math.PI/2);break;case"z":oi.identity()}const p=this._loaders.get(i);if(p){const t={fetchOptions:a,path:o,buffer:e};"b3dm"!==i&&"i3dm"!==i&&"cmpt"!==i||(t.adjustmentTransform=oi.clone()),c=p.load(r,t)}else console.warn(`TilesRenderer: Content type "${i}" not supported.`),c=Promise.resolve(null);return c.then((e=>{const s=e.root;if(t._loadIndex!==l||!s)return;s.updateMatrix(),"glb"!==i&&"gltf"!==i||s.matrix.multiply(oi),s.matrix.premultiply(u),s.matrix.decompose(s.position,s.quaternion,s.scale),d.scene=s,d.featureTable=e.featureTable,d.batchTable=e.batchTable;const r=[],n=[],o=[];return s.traverse((e=>{if(e.geometry&&n.push(e.geometry),e.material){const t=e.material;r.push(e.material);for(const e in t){const i=t[e];i&&i.isTexture&&o.push(i)}}})),d.materials=r,d.geometry=n,d.textures=o,s}))}}const oi=new t.Matrix4,ai=new t.Vector3(1,0,0),li=new t.Vector3(0,1,0),ci=(e,t)=>{const i=t.stats,s=t.frameCount,r=t.errorTarget,n=t.maxDepth,o=t.loadSiblings,a=t.$tilesLoader.lruCache,l=t.stopAtEmptyTiles;pi(e,s);if(!1===mi(e,t))return!1;if(e.__used=!0,a.markUsed(e),e.__inFrustum=!0,i.inFrustum++,(l||!e.__contentEmpty)&&!e.__externalTileSet){fi(e,t);if(e.__error<=r)return!0;if(n>0&&e.__depth+1>=n)return!0}let c=!1;const h=e.children;for(let e=0,i=h.length;e<i;e++){const i=h[e],s=ci(i,t);c=c||s}if(c&&o)for(let e=0,t=h.length;e<t;e++){const t=h[e];gi(t,s,a)}return!0},hi=(e,t)=>{const i=t.stats,s=t.frameCount;if(!_i(e,s))return;i.used++;const r=e.children;let n=!1;for(let e=0,t=r.length;e<t;e++){const t=r[e];n=n||_i(t,s)}if(n){let i=!1,n=!0;for(let e=0,o=r.length;e<o;e++){const o=r[e];if(hi(o,t),i=i||o.__wasSetVisible||o.__childrenWereVisible,_i(o,s)){const e=o.__allChildrenLoaded||!o.__contentEmpty&&bi(o.__loadingState)||o.__externalTileSet&&o.__loadingState===de.FAILED;n=n&&e}}e.__childrenWereVisible=i,e.__allChildrenLoaded=n}else e.__isLeaf=!0},di=(e,t)=>{const i=t.stats,s=t.frameCount;if(!_i(e,s))return;const r=e.parent,n=r?r.__depthFromRenderedParent:-1;e.__depthFromRenderedParent=n;const o=t.$tilesLoader.lruCache;if(e.__isLeaf)return e.__depthFromRenderedParent++,void(e.__loadingState===de.LOADED?(e.__inFrustum&&(e.__visible=!0,i.visible++),e.__active=!0,i.active++):o.isFull()||e.__contentEmpty&&!e.__externalTileSet||t.$tilesLoader.requestTileContents(e,t));const a=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=a,c=l||"ADD"===e.refine,h=!e.__contentEmpty,d=h||e.__externalTileSet,u=bi(e.__loadingState)&&d,p=e.__childrenWereVisible,m=e.children,f=e.__allChildrenLoaded;if(c&&h&&e.__depthFromRenderedParent++,c&&!u&&!o.isFull()&&d&&t.$tilesLoader.requestTileContents(e,t),(l&&!f&&!p&&u||"ADD"===e.refine&&u)&&(e.__inFrustum&&(e.__visible=!0,i.visible++),e.__active=!0,i.active++),"ADD"!==e.refine&&l&&!f&&u)for(let i=0,r=m.length;i<r;i++){const r=m[i];_i(r,s)&&!o.isFull()&&(r.__depthFromRenderedParent=e.__depthFromRenderedParent+1,yi(r,r.__depthFromRenderedParent,t))}else for(let e=0,i=m.length;e<i;e++){const i=m[e];_i(i,s)&&di(i,t)}},ui=(e,t)=>{const i=t.frameCount,s=_i(e,i);if(s||e.__usedLastFrame){let i=!1,r=!1;s&&(i=e.__active,r=t.displayActiveTiles&&e.__active||e.__visible),e.__contentEmpty||e.__loadingState!==de.LOADED||(e.__wasSetActive!==i&&t.$setTileActive(e,i),e.__wasSetVisible!==r&&t.invokeOnePlugin((t=>t.setTileVisible&&t.setTileVisible(e,r)))),e.__wasSetActive=i,e.__wasSetVisible=r,e.__usedLastFrame=s;const n=e.children;for(let e=0,i=n.length;e<i;e++){const i=n[e];ui(i,t)}}},pi=(e,t)=>{e.__lastFrameVisited!==t&&(e.__lastFrameVisited=t,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1)},mi=(e,t)=>{const i=t.$cameras.getInfos(),s=e.cached,r=s.boundingVolume,n=s.inFrustum;let o=!1;for(let e=0,t=i.length;e<t;e++){const t=i[e].frustum;r.intersectsFrustum(t)?(o=!0,n[e]=!0):n[e]=!1}return o},fi=(e,t)=>{const i=t.$cameras.getInfos(),s=e.cached,r=s.inFrustum,n=s.boundingVolume;let o=-1/0,a=1/0;for(let e=0,t=i.length;e<t;e++){if(!r[e])continue;const t=i[e],l=t.invScale;let c;if(t.isOrthographic){const e=t.pixelSize;c=s.geometricError/(e*l)}else{const e=n.distanceToPoint(t.position)*l,i=t.sseDenominator;c=s.geometricError/(e*i),a=Math.min(a,e)}o=Math.max(o,c)}e.__distanceFromCamera=a,e.__error=o},gi=(e,t,i)=>{if(pi(e,t),e.__used=!0,i.markUsed(e),e.__contentEmpty){const s=e.children;for(let e=0,r=s.length;e<r;e++)gi(s[e],t,i)}},_i=(e,t)=>e.__lastFrameVisited===t&&e.__used;function bi(e){return e===de.LOADED||e===de.FAILED}const yi=(e,t,i)=>{if(e.__contentEmpty&&(!e.__externalTileSet||bi(e.__loadingState))){const s=e.children;for(let e=0,r=s.length;e<r;e++){const r=s[e];r.__depthFromRenderedParent=t,yi(r,t,i)}}else i.$tilesLoader.requestTileContents(e,i)},xi=6378137,Mi=new b(new t.Vector3(xi,xi,6356752.314245179));Mi.name="WGS84 Earth";class vi extends t.Object3D{constructor(e,i=new t.LoadingManager){super(),this.ellipsoid=Mi.clone(),this.fetchOptions={},this.errorTarget=6,this.errorThreshold=1/0,this.loadSiblings=!0,this.displayActiveTiles=!1,this.maxDepth=1/0,this.stopAtEmptyTiles=!0,this.preprocessURL=null,i.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=i,this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.activeTiles=new Set,this.visibleTiles=new Set,this.rootURL=e,this._rootTileSet=null,this._autoDisableRendererCulling=!0,this.plugins=[],this.$cameras=new me,this.$tilesLoader=new Te,this.$modelLoader=new ni(i),this.$events=new t.EventDispatcher}preprocessTileSet(e,t,i=null){const s=e.asset.version,[r,n]=s.split(".").map((e=>parseInt(e)));console.assert(r<=1,"TilesLoader: asset.version is expected to be a 1.x or a compatible version."),1===r&&n>0&&console.warn("TilesLoader: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let o=t.replace(/\/[^/]*$/,"");o=new URL(o,window.location.href).toString(),ie(e.root,((e,t)=>Li(this.ellipsoid,e,t,o)),null,i,i?i.__depth:0)}loadRootTileSet(){let e=this.rootURL;this.invokeAllPlugins((t=>e=t.preprocessURL?t.preprocessURL(e,null):e));return this.invokeOnePlugin((t=>t.fetchData&&t.fetchData(e,this.fetchOptions))).then((t=>{if(t.ok)return t.json();throw new Error(`Tiles3D: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)})).then((t=>{const{extensions:i={}}=t;if("3DTILES_ellipsoid"in i){const e=i["3DTILES_ellipsoid"],{ellipsoid:t}=this;t.name=e.body,e.radii?t.radius.set(...e.radii):t.radius.set(1,1,1),console.log(i)}return this.preprocessTileSet(t,e),t}))}fetchData(e,t){return fetch(e,t)}get rootTileSet(){const e=this._rootTileSet;return e?e instanceof Promise||e instanceof Error?null:e:(this._rootTileSet=this.invokeOnePlugin((e=>e.loadRootTileSet&&e.loadRootTileSet())).then((e=>{let t=this.rootURL;null!==t&&this.invokeAllPlugins((e=>t=e.preprocessURL?e.preprocessURL(t,null):t)),this._rootTileSet=e,this.dispatchEvent({type:"load-tile-set",tileSet:e,url:t})})).catch((e=>{console.error(e),this._rootTileSet=e})),null)}get root(){const e=this.rootTileSet;return e?e.root:null}get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.traverse((t=>{const i=t.cached.scene;i&&i.traverse((t=>{t.frustumCulled=t[Ei]&&!e}))})))}registerPlugin(e){if(!0===e[wi])throw new Error("Tiles3D: A plugin can only be registered to a single tile set");const t=this.plugins,i=e.priority||0;let s=t.length;for(let e=0;e<t.length;e++){if((t[e].priority||0)>i){s=e;break}}t.splice(s,0,e),e[wi]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if("string"==typeof e&&(e=this.getPluginByName(name)),t.includes(e)){const i=t.indexOf(e);return t.splice(i,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find((t=>t.name===e))||null}setDRACOLoader(e){this.$modelLoader.setDRACOLoader(e)}setKTX2Loader(e){this.$modelLoader.setKTX2Loader(e)}addEventListener(e,t,i){this.$events.addEventListener(e,t,i)}removeEventListener(e,t,i){this.$events.removeEventListener(e,t,i)}dispatchEvent(e){this.$events.dispatchEvent(e)}markTileUsed(e){this.$tilesLoader.lruCache.markUsed(e)}update(){const e=this.root;if(!e)return;this.dispatchEvent(Ti);const{stats:t}=this;var i,s;t.inFrustum=0,t.used=0,t.active=0,t.visible=0,this.frameCount++,this.$cameras.updateInfos(this.worldMatrix),ci(i=e,s=this),hi(i,s),di(i,s),ui(i,s),s.$tilesLoader.lruCache.scheduleUnload(),this.dispatchEvent(Ai)}addCamera(e){const t=this.$cameras.add(e);return t&&this.dispatchEvent({type:"add-camera",camera:e}),t}removeCamera(e){const t=this.$cameras.remove(e);return t&&this.dispatchEvent({type:"delete-camera",camera:e}),t}resize(e,t){this.$cameras.setResolution(e,t)}raycast(e,t){if(!this.root)return null;se(this.root,this,e,t),t.sort(ne)}raycastFirst(e){return this.root?re(this.root,this,e):null}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getBoundingBox(e),!0)}getOrientedBoundingBox(e,t){if(!this.root)return!1;const i=this.root.cached.boundingVolume;return!!i&&(i.getOrientedBoundingBox(e,t),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getBoundingSphere(e),!0)}forEachLoadedModel(e){this.traverse((t=>{const i=t.cached&&t.cached.scene;i&&e(i,t)}),null)}traverse(e,t){const i=this.root;i&&ie(i,e,t)}resetFailedTiles(){const e=this.stats;0!==e.failed&&(this.traverse((e=>{e.__loadingState===de.FAILED&&(e.__loadingState=de.UNLOADED)})),e.failed=0)}dispose(){this.plugins.forEach((e=>{this.unregisterPlugin(e)}));const e=this.$tilesLoader.lruCache;this.traverse((t=>{e.remove(t)})),this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}updateMatrix(e){if((this.matrixAutoUpdate||this.matrixNeedsUpdate)&&(this.matrix.transform(this.position,this.scale,this.quaternion),this.matrixNeedsUpdate=!1,this.worldMatrixNeedsUpdate=!0),(this.worldMatrixNeedsUpdate||e)&&(null===this.parent?Si.copy(this.matrix):Si.multiplyMatrices(this.parent.worldMatrix,this.matrix),this.worldMatrixNeedsUpdate=!1,!Pi(Si,this.worldMatrix))){this.worldMatrix.copy(Si);const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateMatrix()}}getAttributions(e=[]){return this.invokeAllPlugins((t=>t!==this&&t.getAttributions&&t.getAttributions(e))),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let i=0;i<t.length;i++){const s=e(t[i]);if(s)return s}return null}invokeAllPlugins(e){const t=[...this.plugins,this],i=[];for(let s=0;s<t.length;s++){const r=e(t[s]);r&&i.push(r)}return 0===i.length?null:Promise.all(i)}$parseTile(e,t,i){return this.$modelLoader.loadTileContent(e,t,i,this).then((e=>{e.traverse((e=>{e[Ei]=e.frustumCulled,e.frustumCulled=e.frustumCulled&&!this._autoDisableRendererCulling})),this.dispatchEvent({type:"load-model",scene:e,tile:t})}))}setTileVisible(e,t){const i=e.cached.scene;if(!i)return;const s=this.visibleTiles;t?(this.add(i),s.add(e),i.updateMatrix(!0)):(this.remove(i),s.delete(e)),this.dispatchEvent({type:"tile-visibility-change",scene:i,tile:e,visible:t})}$setTileActive(e,t){const i=this.activeTiles;t?i.add(e):i.delete(e)}$disposeTile(e){const t=e.cached;if(t.scene){const i=t.materials,s=t.geometry,r=t.textures;for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=i.length;e<t;e++)i[e].dispose();for(let e=0,t=r.length;e<t;e++){r[e].dispose()}this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null}e._loadIndex++}}const Ti={type:"update-before"},Ai={type:"update-after"},wi=Symbol("PLUGIN_REGISTERED"),Ei=Symbol("INITIAL_FRUSTUM_CULLED"),Si=new t.Matrix4,Pi=(e,t,i=Number.EPSILON)=>{const s=e.elements,r=t.elements;for(let e=0;e<16;e++)if(Math.abs(s[e]-r[e])>i)return!1;return!0},Ci=new t.Vector3,Li=(e,i,s,r)=>{i.contents&&(i.content=i.contents[0]),i.content&&(!("uri"in i.content)&&"url"in i.content&&(i.content.uri=i.content.url,delete i.content.url),i.content.uri&&(i.content.uri=new URL(i.content.uri,r+"/").toString()),i.content.boundingVolume&&!("box"in i.content.boundingVolume||"sphere"in i.content.boundingVolume||"region"in i.content.boundingVolume)&&delete i.content.boundingVolume),i.parent=s,i.children=i.children||[];if(i.content&&i.content.uri){const e=te(i.content.uri),t=Boolean(e&&"json"===e.toLowerCase());i.__externalTileSet=t,i.__contentEmpty=t}else i.__externalTileSet=!1,i.__contentEmpty=!0;i.__distanceFromCamera=1/0,i.__error=1/0,i.__inFrustum=!1,i.__isLeaf=!1,i.__usedLastFrame=!1,i.__used=!1,i.__wasSetVisible=!1,i.__visible=!1,i.__childrenWereVisible=!1,i.__allChildrenLoaded=!1,i.__wasSetActive=!1,i.__active=!1,i.__loadingState=de.UNLOADED,i.__loadIndex=0,i.__loadAbort=null,i.__depthFromRenderedParent=-1,null===s?(i.__depth=0,i.refine=i.refine||"REPLACE"):(i.__depth=s.__depth+1,i.refine=i.refine||s.refine);const n=new t.Matrix4;i.transform&&n.fromArray(i.transform),s&&n.premultiply(s.cached.transform);const o=(new t.Matrix4).copy(n).inverse(),a=Ci.setFromMatrixScale(n),l=Math.max(a.x,a.y,a.z);let c=i.geometricError*l;const h=new Q;"box"in i.boundingVolume&&h.setOBBData(i.boundingVolume.box,n),"sphere"in i.boundingVolume&&h.setSphereData(i.boundingVolume.sphere,n),"region"in i.boundingVolume&&(h.setRegionData(e,...i.boundingVolume.region),c=i.geometricError),i.cached={loadIndex:0,transform:n,transformInverse:o,geometricError:c,boundingVolume:h,active:!1,inFrustum:[],scene:null,geometry:null,material:null,featureTable:null,batchTable:null}};class Ri{constructor(e,i){this.ray=new t.Ray(e,i)}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){-1===t.projectionMatrix.elements[11]?(this.ray.origin.setFromMatrixPosition(t.worldMatrix),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):(this.ray.origin.set(e.x,e.y,t.projectionMatrix.elements[14]).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.worldMatrix))}intersectObject(e,t){const i=[];return Oi(e,this,i,t),i.sort(Di),i}intersectObjects(e,t){const i=[];if(!1===Array.isArray(e))return console.warn("Raycaster.intersectObjects: objects is not an Array."),i;for(let s=0,r=e.length;s<r;s++)Oi(e[s],this,i,t);return i.sort(Di),i}}function Di(e,t){return e.distance-t.distance}function Oi(e,t,i,s){if(e.raycast(t.ray,i),!0===s){const s=e.children;for(let e=0,r=s.length;e<r;e++)Oi(s[e],t,i,!0)}}class Ii extends t.Mesh{constructor(){super(new t.PlaneGeometry(0,0),new Ui),this.renderOrder=1/0}}class Ui extends t.ShaderMaterial{constructor(){super(Fi),this.depthWrite=!1,this.depthTest=!1,this.transparent=!0}}const Fi={name:"PivotPoint",uniforms:{resolution:[512,512],size:15,thickness:2,opacity:1},vertexShader:"\n\t\tattribute vec3 a_Position; \n\t\tattribute vec2 a_Uv;\n\n\t\tuniform mat4 u_ProjectionView;\n\t\tuniform mat4 u_Model;\n\n\t\tuniform float pixelRatio;\n\t\tuniform float size;\n\t\tuniform float thickness;\n\t\tuniform vec2 resolution;\n\n\t\tvarying vec2 v_Uv;\n\n\t\tvoid main() {\n\t\t\tv_Uv = a_Uv;\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\t\t\tvec2 offset = a_Uv * 2.0 - vec2(1.0);\n\t\t\toffset.y *= aspect;\n\n\t\t\tvec4 screenPoint = u_ProjectionView * u_Model * vec4(a_Position, 1.0);\n\t\t\tscreenPoint.xy += offset * (size + thickness) * screenPoint.w / resolution.x;\n\n\t\t\tgl_Position = screenPoint;\n\t\t}\n\t",fragmentShader:"\n\t\tuniform float size;\n\t\tuniform float thickness;\n\t\tuniform float opacity;\n\n\t\tvarying vec2 v_Uv;\n\n\t\tvoid main() {\n\t\t\tfloat ht = 0.5 * thickness;\n\t\t\tfloat planeDim = size + thickness;\n\t\t\tfloat offset = (planeDim - ht - 2.0) / planeDim;\n\t\t\tfloat texelThickness = ht / planeDim;\n\n\t\t\tvec2 vec = v_Uv * 2.0 - vec2(1.0);\n\t\t\tfloat dist = abs(length(vec) - offset);\n\t\t\tfloat fw = fwidth(dist) * 0.5;\n\t\t\tfloat a = smoothstep(texelThickness - fw, texelThickness + fw, dist);\n\n\t\t\tgl_FragColor = vec4(1, 1, 1, opacity * (1.0 - a));\n\t\t}\n\t"},Bi=new t.Vector2,Vi=new t.Vector2;class Ni{constructor(){this.domElement=null,this.buttons=0,this.pointerType=null,this.pointerOrder=[],this.previousPositions={},this.pointerPositions={},this.startPositions={},this.pointerSetThisFrame={},this.hoverPosition=new t.Vector2,this.hoverSet=!1}reset(){this.buttons=0,this.pointerType=null,this.pointerOrder=[],this.previousPositions={},this.pointerPositions={},this.startPositions={},this.pointerSetThisFrame={},this.hoverPosition=new t.Vector2,this.hoverSet=!1}updateFrame(){const{previousPositions:e,pointerPositions:t}=this;for(const i in t)e[i].copy(t[i])}setHoverEvent(e){"mouse"!==e.pointerType&&"wheel"!==e.type||(this.getAdjustedPointer(e,this.hoverPosition),this.hoverSet=!0)}getLatestPoint(e){return null!==this.pointerType?(this.getCenterPoint(e),e):this.hoverSet?(e.copy(this.hoverPosition),e):null}getAdjustedPointer(e,t){const i=(this.domElement?this.domElement:e.target).getBoundingClientRect(),s=e.clientX-i.left,r=e.clientY-i.top;t.set(s,r)}addPointer(e){const i=e.pointerId,s=new t.Vector2;this.getAdjustedPointer(e,s),this.pointerOrder.push(i),this.pointerPositions[i]=s,this.previousPositions[i]=s.clone(),this.startPositions[i]=s.clone(),1===this.getPointerCount()&&(this.pointerType=e.pointerType,this.buttons=e.buttons)}updatePointer(e){const t=e.pointerId;return t in this.pointerPositions&&(this.getAdjustedPointer(e,this.pointerPositions[t]),!0)}deletePointer(e){const t=e.pointerId,i=this.pointerOrder;i.splice(i.indexOf(t),1),delete this.pointerPositions[t],delete this.previousPositions[t],delete this.startPositions[t],0===this.getPointerCount()&&(this.buttons=0,this.pointerType=null)}getPointerCount(){return this.pointerOrder.length}getCenterPoint(e,t=this.pointerPositions){const i=this.pointerOrder;if(1===this.getPointerCount()||"mouse"===this.getPointerType()){const s=i[0];return e.copy(t[s]),e}if(2===this.getPointerCount()){const i=this.pointerOrder[0],s=this.pointerOrder[1],r=t[i],n=t[s];return e.addVectors(r,n).multiplyScalar(.5),e}return null}getPreviousCenterPoint(e){return this.getCenterPoint(e,this.previousPositions)}getStartCenterPoint(e){return this.getCenterPoint(e,this.startPositions)}getMoveDistance(){return this.getCenterPoint(Bi),this.getPreviousCenterPoint(Vi),Bi.sub(Vi).getLength()}getTouchPointerDistance(e=this.pointerPositions){if(this.getPointerCount()<=1||"mouse"===this.getPointerType())return 0;const{pointerOrder:t}=this,i=t[0],s=t[1],r=e[i],n=e[s];return r.distanceTo(n)}getPreviousTouchPointerDistance(){return this.getTouchPointerDistance(this.previousPositions)}getStartTouchPointerDistance(){return this.getTouchPointerDistance(this.startPositions)}getPointerType(){return this.pointerType}isPointerTouch(){return"touch"===this.getPointerType()}getPointerButtons(){return this.buttons}isLeftClicked(){return Boolean(1&this.buttons)}isRightClicked(){return Boolean(2&this.buttons)}}const ki=new t.Matrix4,zi=new t.Ray,Gi=new t.Vector3;function Hi(e,t,i){return i.makeTranslation(-e.x,-e.y,-e.z),ki.makeRotationFromQuaternion(t),i.premultiply(ki),ki.makeTranslation(e.x,e.y,e.z),i.premultiply(ki),i}function ji(e,t,i,s){s.x=(e-i.offsetLeft)/i.clientWidth*2-1,s.y=-(t-i.offsetTop)/i.clientHeight*2+1,s.isVector3&&(s.z=0)}function Ki(e,t,i){return t.intersectRay(e,i)?i:(ki.makeScale(...t.radius).invert(),zi.copy(e).applyMatrix4(ki),Gi.set(0,0,0),zi.closestPointToPoint(Gi,i).normalize(),ki.makeScale(...t.radius),i.applyMatrix4(ki))}function $i(e,i,s){const r=e instanceof t.Ray?e:e.ray,{origin:n,direction:o}=r;n.set(i.x,i.y,-1).unproject(s),o.set(i.x,i.y,1).unproject(s).sub(n),o.normalize()}const Xi=.05,qi=.025,Zi=new t.Matrix4,Qi=new t.Vector3,Wi=new t.Vector3,Yi=new t.Vector3,Ji=new t.Vector3,es=new t.Vector3,ts=new t.Quaternion,is=new t.Plane,ss=new t.Vector3,rs=new t.Vector3,ns=new t.Vector3,os=new t.Quaternion,as=new t.Ray,ls=new t.Vector2,cs=new t.Vector2,hs=new t.Vector2,ds=new t.Vector2,us=new t.Vector2,ps=new t.Vector2,ms={type:"change"},fs={type:"start"},gs={type:"end"};class _s extends t.EventDispatcher{get enabled(){return this._enabled}set enabled(e){e!==this.enabled&&(this._enabled=e,this.resetState(),this.pointerTracker.reset(),this.enabled||(this.dragInertia.set(0,0,0),this.rotationInertia.set(0,0)))}constructor(e=null,i=null,s=null,r=null){super(),this.isEnvironmentControls=!0,this.domElement=null,this.camera=null,this.scene=null,this.tilesRenderer=null,this._enabled=!0,this.cameraRadius=5,this.rotationSpeed=1,this.minAltitude=0,this.maxAltitude=.45*Math.PI,this.minDistance=10,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.zoomSpeed=1,this.adjustHeight=!0,this.enableDamping=!1,this.dampingFactor=.15,this.fallbackPlane=new t.Plane(new t.Vector3(0,1,0),0),this.useFallbackPlane=!0,this.reorientOnDrag=!0,this.scaleZoomOrientationAtEdges=!1,this.state=0,this.pointerTracker=new Ni,this.needsUpdate=!1,this.actionHeightOffset=0,this.pivotPoint=new t.Vector3,this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.zoomDirection=new t.Vector3,this.zoomPoint=new t.Vector3,this.zoomDelta=0,this.rotationInertiaPivot=new t.Vector3,this.rotationInertia=new t.Vector2,this.dragInertia=new t.Vector3,this.inertiaTargetDistance=1/0,this.inertiaStableFrames=0,this.pivotMesh=new Ii,this.pivotMesh.raycast=()=>{},this.pivotMesh.scale.setScalar(.25),this.raycaster=new Ri,this.up=new t.Vector3(0,1,0),this._detachCallback=null,this._upInitialized=!1,this._lastUsedState=0,this._zoomPointWasSet=!1,this._tilesOnChangeCallback=()=>this.zoomPointSet=!1,s&&this.attach(s),i&&this.setCamera(i),e&&this.setScene(e),r&&this.setTilesRenderer(r)}setScene(e){this.scene=e}setCamera(e){this.camera=e,this._upInitialized=!1,this.zoomDirectionSet=!1,this.zoomPointSet=!1,this.needsUpdate=!0,this.raycaster.camera=e,this.resetState()}setTilesRenderer(e){this.tilesRenderer&&this.tilesRenderer.removeEventListener("tile-visibility-change",this._tilesOnChangeCallback),this.tilesRenderer=e,null!==this.tilesRenderer&&(this.tilesRenderer.addEventListener("tile-visibility-change",this._tilesOnChangeCallback),null===this.scene&&this.setScene(this.tilesRenderer))}attach(e){if(this.domElement)throw new Error("EnvironmentControls: Controls already attached to element");this.domElement=e,this.pointerTracker.domElement=e,e.style.touchAction="none";const t=e=>{this.enabled&&e.preventDefault()},i=e=>{if(!this.enabled)return;e.preventDefault();const{camera:t,raycaster:i,domElement:s,up:r,pivotMesh:n,pointerTracker:o,scene:a,pivotPoint:l,enabled:c}=this;if(o.addPointer(e),this.needsUpdate=!0,o.isPointerTouch())if(n.visible=!1,0===o.getPointerCount())s.setPointerCapture(e.pointerId);else if(o.getPointerCount()>2)return void this.resetState();o.getCenterPoint(cs),ji(cs.x,cs.y,s,cs),$i(i,cs,t);const h=Math.abs(i.ray.direction.dot(r));if(h<Xi||h<qi)return;const d=this._raycast(i);d&&(2===o.getPointerCount()||o.isRightClicked()||o.isLeftClicked()&&e.shiftKey?(this.setState(o.isPointerTouch()?4:2),l.copy(d.point),n.position.copy(d.point),n.visible=!o.isPointerTouch()&&c,n.updateMatrix(),a.add(n)):o.isLeftClicked()&&(this.setState(1),l.copy(d.point),n.position.copy(d.point),n.updateMatrix(),a.add(n)))};let s=!1;const r=e=>{if(!this.enabled)return;e.preventDefault();const{pivotMesh:t,enabled:i}=this;this.zoomDirectionSet=!1,this.zoomPointSet=!1,0!==this.state&&(this.needsUpdate=!0);const{pointerTracker:r}=this;r.setHoverEvent(e),r.updatePointer(e)&&(r.isPointerTouch()&&2===r.getPointerCount()&&(s||(s=!0,queueMicrotask((()=>{s=!1,r.getCenterPoint(us);const e=r.getStartTouchPointerDistance(),n=r.getTouchPointerDistance(),o=n-e;if(0===this.state||4===this.state){r.getCenterPoint(us),r.getStartCenterPoint(ps);const e=2*window.devicePixelRatio,t=us.distanceTo(ps);(Math.abs(o)>e||t>e)&&(Math.abs(o)>t?(this.setState(3),this.zoomDirectionSet=!1):this.setState(2))}if(3===this.state){const e=r.getPreviousTouchPointerDistance();this.zoomDelta+=n-e,t.visible=!1}else 2===this.state&&(t.visible=i)})))),this.dispatchEvent(ms))},n=t=>{if(!this.enabled)return;const{pointerTracker:i}=this;i.deletePointer(t),"touch"===i.getPointerType()&&0===i.getPointerCount()&&e.releasePointerCapture(t.pointerId),this.resetState(),this.needsUpdate=!0},o=e=>{if(!this.enabled)return;e.preventDefault();const{pointerTracker:t}=this;let i;switch(t.setHoverEvent(e),t.updatePointer(e),this.dispatchEvent(fs),e.deltaMode){case 2:i=800*e.deltaY;break;case 1:i=40*e.deltaY;break;case 0:i=e.deltaY}const s=Math.sign(i),r=Math.abs(i);this.zoomDelta-=.25*s*r,this.needsUpdate=!0,this._lastUsedState=3,this.dispatchEvent(gs)},a=e=>{if(!this.enabled)return;const{pointerTracker:t}=this;e.buttons!==t.getPointerButtons()&&(t.deletePointer(e),this.resetState())};e.addEventListener("contextmenu",t),e.addEventListener("pointerdown",i),e.addEventListener("pointermove",r),e.addEventListener("pointerup",n),e.addEventListener("wheel",o,{passive:!1}),e.addEventListener("pointerenter",a),this._detachCallback=()=>{e.removeEventListener("contextmenu",t),e.removeEventListener("pointerdown",i),e.removeEventListener("pointermove",r),e.removeEventListener("pointerup",n),e.removeEventListener("wheel",o),e.removeEventListener("pointerenter",a)}}getUpDirection(e,t){t.copy(this.up)}getCameraUpDirection(e){this.getUpDirection(this.camera.position,e)}getPivotPoint(e){let t=null;3===this._lastUsedState?this._zoomPointWasSet&&(t=e.copy(this.zoomPoint)):2!==this._lastUsedState&&1!==this._lastUsedState||(t=e.copy(this.pivotPoint));const{camera:i,raycaster:s}=this;null!==t&&(Wi.copy(t).project(i),(Wi.x<-1||Wi.x>1||Wi.y<-1||Wi.y>1)&&(t=null)),$i(s,{x:0,y:0},i);const r=this._raycast(s);return r&&(null===t||r.distance<t.distanceTo(s.ray.origin))&&(t=e.copy(r.point)),t}detach(){this.domElement=null,this._detachCallback&&(this._detachCallback(),this._detachCallback=null,this.pointerTracker.reset())}resetState(){0!==this.state&&this.dispatchEvent(gs),this.state=0,this.pivotMesh.removeFromParent(),this.pivotMesh.visible=this.enabled,this.actionHeightOffset=0}setState(e=this.state,t=!0){this.state!==e&&(0===this.state&&t&&this.dispatchEvent(fs),this.pivotMesh.visible=this.enabled,this.dragInertia.set(0,0,0),this.rotationInertia.set(0,0),this.inertiaStableFrames=0,this.state=e,0!==e&&4!==e&&(this._lastUsedState=e))}update(e=.064){if(!this.enabled||!this.camera||0===e)return;const{camera:t,cameraRadius:i,pivotPoint:s,up:r,state:n,adjustHeight:o}=this;t.updateMatrix(),this.getCameraUpDirection(ss),this._upInitialized||(this._upInitialized=!0,this.up.copy(ss));const a=this._inertiaNeedsUpdate();if(this.needsUpdate||a){const i=this.zoomDelta;this._updateZoom(),this._updatePosition(e),this._updateRotation(e),1===n||2===n?(Yi.set(0,0,-1).transformDirection(t.worldMatrix),this.inertiaTargetDistance=Wi.copy(this.pivotPoint).sub(t.position).dot(Yi)):0===n&&this._updateInertia(e),(0!==n||0!==i||a)&&this.dispatchEvent(ms),this.needsUpdate=!1}const l=t.isOrthographicCamera?null:o&&this._getPointBelowCamera()||null,c=t.isOrthographicCamera?s:l&&l.point||null;if(this.getCameraUpDirection(ss),this._setFrame(ss,c),(1===this.state||2===this.state)&&0!==this.actionHeightOffset){const{actionHeightOffset:e}=this;t.position.addScaledVector(r,-e),s.addScaledVector(r,-e),l&&(l.distance-=e)}if(this.actionHeightOffset=0,l){const e=l.distance;if(e<i){const n=i-e;t.position.addScaledVector(r,n),s.addScaledVector(r,n),this.actionHeightOffset=n}}this.pointerTracker.updateFrame()}adjustCamera(e){const{adjustHeight:t,cameraRadius:i}=this;if(e.isPerspectiveCamera){this.getUpDirection(e.position,ss);const s=t&&this._getPointBelowCamera(e.position,ss)||null;if(s){const t=s.distance;t<i&&e.position.addScaledVector(ss,i-t)}}}dispose(){this.detach()}_updateInertia(e){const{rotationInertia:t,pivotPoint:i,dragInertia:s,enableDamping:r,dampingFactor:n,camera:o,cameraRadius:a,minDistance:l,inertiaTargetDistance:c}=this;if(!this.enableDamping||this.inertiaStableFrames>1)return s.set(0,0,0),void t.set(0,0,0);const h=Math.pow(2,-e/n),d=Math.max(o.near,a,l,c),u=25e-5;if(t.getLengthSquared()>0){$i(as,Wi.set(0,0,-1),o),as.applyMatrix4(o.viewMatrix),as.direction.normalize(),as.recast(-as.direction.dot(as.origin)).at(d/as.direction.z,Wi),Wi.applyMatrix4(o.worldMatrix),$i(as,Qi.set(u,u,-1),o),as.applyMatrix4(o.viewMatrix),as.direction.normalize(),as.recast(-as.direction.dot(as.origin)).at(d/as.direction.z,Qi),Qi.applyMatrix4(o.worldMatrix),Wi.sub(i).normalize(),Qi.sub(i).normalize();const s=Wi.angleTo(Qi)/e;t.multiplyScalar(h),(t.getLengthSquared()<s**2||!r)&&t.set(0,0)}if(s.getLengthSquared()>0){$i(as,Wi.set(0,0,-1),o),as.applyMatrix4(o.viewMatrix),as.direction.normalize(),as.recast(-as.direction.dot(as.origin)).at(d/as.direction.z,Wi),Wi.applyMatrix4(o.worldMatrix),$i(as,Qi.set(u,u,-1),o),as.applyMatrix4(o.viewMatrix),as.direction.normalize(),as.recast(-as.direction.dot(as.origin)).at(d/as.direction.z,Qi),Qi.applyMatrix4(o.worldMatrix);const t=Wi.distanceTo(Qi)/e;s.multiplyScalar(h),(s.getLengthSquared()<t**2||!r)&&s.set(0,0,0)}t.getLengthSquared()>0&&this._applyRotation(t.x*e,t.y*e,i),s.getLengthSquared()>0&&(o.position.addScaledVector(s,e),o.updateMatrix())}_inertiaNeedsUpdate(){const{rotationInertia:e,dragInertia:t}=this;return 0!==e.getLengthSquared()||0!==t.getLengthSquared()}_updateZoom(){const{zoomPoint:e,zoomDirection:t,camera:i,minDistance:s,maxDistance:r,pointerTracker:n,domElement:o,minZoom:a,maxZoom:l,zoomSpeed:c,state:h}=this;let d=this.zoomDelta;if(this.zoomDelta=0,n.getLatestPoint(cs)&&(0!==d||3===h))if(this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0),i.isOrthographicCamera){this._updateZoomDirection();const e=this.zoomPointSet||this._updateZoomPoint();rs.unproject(i);const t=Math.pow(.95,Math.abs(.05*d));let s=d>0?1/Math.abs(t):t;s*=c,s>1?l<i.zoom*s&&(s=1):a>i.zoom*s&&(s=1),e&&(ji(cs.x,cs.y,o,ns),ns.unproject(i),i.position.sub(ns).add(rs),i.updateMatrix())}else{this._updateZoomDirection();const n=Wi.copy(t);if(this.zoomPointSet||this._updateZoomPoint()){const n=e.distanceTo(i.position);if(d<0){const e=Math.min(0,n-r);d=d*n*c*.0025,d=Math.max(d,e)}else{const e=Math.max(0,n-s);d=d*Math.max(n-s,0)*c*.0025,d=Math.min(d,e)}i.position.addScaledVector(t,d),i.updateMatrix()}else{const e=this._getPointBelowCamera();if(e){const t=e.distance;n.set(0,0,-1).transformDirection(i.worldMatrix),i.position.addScaledVector(n,d*t*.01),i.updateMatrix()}}}}_updateZoomDirection(){if(this.zoomDirectionSet)return;const{domElement:e,raycaster:t,camera:i,zoomDirection:s,pointerTracker:r}=this;r.getLatestPoint(cs),ji(cs.x,cs.y,e,rs),$i(t,rs,i),s.copy(t.ray.direction).normalize(),this.zoomDirectionSet=!0}_updateZoomPoint(){const{camera:e,zoomDirectionSet:t,zoomDirection:i,raycaster:s,zoomPoint:r,pointerTracker:n,domElement:o}=this;if(this._zoomPointWasSet=!1,!t)return!1;e.isOrthographicCamera&&n.getLatestPoint(ls)?(ji(ls.x,ls.y,o,ls),$i(s,ls,e)):(s.ray.origin.copy(e.position),s.ray.direction.copy(i),s.near=0,s.far=1/0);const a=this._raycast(s);return!!a&&(r.copy(a.point),this.zoomPointSet=!0,this._zoomPointWasSet=!0,!0)}_getPointBelowCamera(e=this.camera.position,t=this.up){const{raycaster:i}=this;i.ray.direction.copy(t).multiplyScalar(-1),i.ray.origin.copy(e).addScaledVector(t,1e5),i.near=0,i.far=1/0;const s=this._raycast(i);return s&&(s.distance-=1e5),s}_updatePosition(e){const{raycaster:t,camera:i,pivotPoint:s,up:r,pointerTracker:n,domElement:o,state:a,dragInertia:l}=this;if(1===a){if(n.getCenterPoint(cs),ji(cs.x,cs.y,o,cs),is.setFromNormalAndCoplanarPoint(r,s),$i(t,cs,i),Math.abs(t.ray.direction.dot(r))<Xi){const e=Math.acos(Xi);es.crossVectors(t.ray.direction,r).normalize(),t.ray.direction.copy(r).applyAxisAngle(es,e).multiplyScalar(-1)}if(this.getUpDirection(s,ss),Math.abs(t.ray.direction.dot(ss))<qi){const e=Math.acos(qi);es.crossVectors(t.ray.direction,ss).normalize(),t.ray.direction.copy(ss).applyAxisAngle(es,e).multiplyScalar(-1)}t.ray.intersectPlane(is,Wi)&&(Qi.subVectors(s,Wi),i.position.add(Qi),i.updateMatrix(),Qi.multiplyScalar(1/e),n.getMoveDistance()/e<2*window.devicePixelRatio?this.inertiaStableFrames++:(l.copy(Qi),this.inertiaStableFrames=0))}}_updateRotation(e){const{pivotPoint:t,pointerTracker:i,domElement:s,state:r,rotationInertia:n}=this;2===r&&(i.getCenterPoint(cs),i.getPreviousCenterPoint(hs),ds.subVectors(cs,hs).multiplyScalar(2*Math.PI/s.clientHeight),this._applyRotation(ds.x,ds.y,t),ds.multiplyScalar(1/e),i.getMoveDistance()/e<2*window.devicePixelRatio?this.inertiaStableFrames++:(n.copy(ds),this.inertiaStableFrames=0))}_applyRotation(e,t,i){if(0===e&&0===t)return;const{camera:s,minAltitude:r,maxAltitude:n,rotationSpeed:o}=this,a=-e*o;let l=t*o;Yi.set(0,0,1).transformDirection(s.worldMatrix),this.getUpDirection(i,ss),Wi.crossVectors(ss,Yi).normalize(),Ji.set(1,0,0).transformDirection(s.worldMatrix).normalize();const c=Math.sign(Wi.dot(Ji))*ss.angleTo(Yi);l>0?(l=Math.min(c-r-.01,l),l=Math.max(0,l)):(l=Math.max(c-n,l),l=Math.min(0,l)),ts.setFromAxisAngle(ss,a),Hi(i,ts,Zi),s.worldMatrix.premultiply(Zi),es.set(-1,0,0).transformDirection(s.worldMatrix),ts.setFromAxisAngle(es,l),Hi(i,ts,Zi),s.worldMatrix.premultiply(Zi),s.worldMatrix.decompose(s.position,s.quaternion,Wi)}_setFrame(e,i){const{up:s,camera:r,state:n,zoomPoint:o,zoomDirectionSet:a,zoomPointSet:l,reorientOnDrag:c,scaleZoomOrientationAtEdges:h}=this;r.updateMatrix(),ts.setFromUnitVectors(s,e);const d=n;if(a&&(l||this._updateZoomPoint())){if(this.getUpDirection(o,Wi),h){let e=Math.max(Wi.dot(s)-.6,0)/.4;e=t.MathUtils.mapLinear(e,0,.5,0,1),e=Math.min(e,1),r.isOrthographicCamera&&(e*=.1),ts.slerpQuaternions(ts,os,1-e)}Hi(o,ts,Zi),r.worldMatrix.premultiply(Zi),r.worldMatrix.decompose(r.position,r.quaternion,Wi),this.zoomDirectionSet=!1,this._updateZoomDirection()}else 1===d&&c&&i&&(Hi(i,ts,Zi),r.worldMatrix.premultiply(Zi),r.worldMatrix.decompose(r.position,r.quaternion,Wi));s.copy(e),r.updateMatrix()}_raycast(e){const{scene:t,useFallbackPlane:i,fallbackPlane:s}=this,r=e.intersectObject(t,!0)[0]||null;if(r)return r;if(i){const t=s;if(e.ray.intersectPlane(t,Wi)){return{point:Wi.clone(),distance:e.ray.origin.distanceTo(Wi)}}}return null}}const bs=new t.Matrix4,ys=new t.Matrix4,xs=new t.Vector3,Ms=new t.Vector3,vs=new t.Vector3,Ts=new t.Vector3,As=new t.Vector3,ws=new t.Vector3,Es=new t.Vector3,Ss=new t.Quaternion,Ps=new t.Vector3,Cs=new t.Vector3,Ls=new t.Ray,Rs=new b,Ds={},Os=new t.Vector2;class Is{constructor(){this.duration=250,this.fadeCount=0,this._lastTick=-1,this._fadeState=new Map,this.onFadeComplete=null,this.onFadeStart=null,this.onFadeSetComplete=null,this.onFadeSetStart=null}deleteObject(e){e&&this.completeFade(e)}guaranteeState(e){const t=this._fadeState;if(t.has(e))return!1;return t.set(e,{fadeInTarget:0,fadeOutTarget:0,fadeIn:0,fadeOut:0}),!0}completeFade(e){const t=this._fadeState;if(!t.has(e))return;const i=0===t.get(e).fadeOutTarget;t.delete(e),this.fadeCount--,this.onFadeComplete&&this.onFadeComplete(e,i),0===this.fadeCount&&this.onFadeSetComplete&&this.onFadeSetComplete()}completeAllFades(){this._fadeState.forEach(((e,t)=>{this.completeFade(t)}))}forEachObject(e){this._fadeState.forEach(((t,i)=>{e(i,t)}))}fadeIn(e){const t=this.guaranteeState(e),i=this._fadeState.get(e);i.fadeInTarget=1,i.fadeOutTarget=0,i.fadeOut=0,t&&(this.fadeCount++,1===this.fadeCount&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(e))}fadeOut(e){const t=this.guaranteeState(e),i=this._fadeState.get(e);i.fadeOutTarget=1,t&&(i.fadeInTarget=1,i.fadeIn=1,this.fadeCount++,1===this.fadeCount&&this.onFadeSetStart&&this.onFadeSetStart(),this.onFadeStart&&this.onFadeStart(e))}isFading(e){return this._fadeState.has(e)}isFadingOut(e){const t=this._fadeState.get(e);return t&&1===t.fadeOutTarget}update(){const e=window.performance.now();-1===this._lastTick&&(this._lastTick=e);const i=t.MathUtils.clamp((e-this._lastTick)/this.duration,0,1);this._lastTick=e;this._fadeState.forEach(((e,s)=>{const{fadeOutTarget:r,fadeInTarget:n}=e;let{fadeOut:o,fadeIn:a}=e;const l=Math.sign(n-a);a=t.MathUtils.clamp(a+l*i,0,1);const c=Math.sign(r-o);o=t.MathUtils.clamp(o+c*i,0,1),e.fadeIn=a,e.fadeOut=o;((1===o||0===o)&&(1===a||0===a)||o>=a)&&this.completeFade(s)}))}}class Us{constructor(){this._fadeParams=new WeakMap,this.fading=0}setFade(e,t,i){if(!e)return;const s=this._fadeParams;e.traverse((e=>{const r=e.material;if(r){const e=s.get(r);e.fadeIn=t,e.fadeOut=i;const n=Number(!(0===t||1===t)||!(0===i||1===i));r.defines.FEATURE_FADE!==n&&(this.fading+=1===n?1:-1,r.defines.FEATURE_FADE=n,r.needsUpdate=!0)}}))}prepareScene(e){e.traverse((e=>{e.material&&this.prepareMaterial(e.material)}))}deleteScene(e){if(!e)return;const t=this._fadeParams;e.traverse((e=>{const i=e.material;i&&(t.delete(i),i.defines.FEATURE_FADE=!1,i.needsUpdate=!0)}))}prepareMaterial(e){const i=this._fadeParams;i.has(e)||i.set(e,function(e){e.shaderName=`${e.shaderName||e.type}_fade`,e.defines.FEATURE_FADE=0,e.uniforms.fadeIn=0,e.uniforms.fadeOut=0;const i=e.fragmentShader||(e.type===t.MATERIAL_TYPE.BASIC?t.ShaderLib.basic_frag:t.ShaderLib.pbr_frag);return e.type=t.MATERIAL_TYPE.SHADER,e.vertexShader=e.type===t.MATERIAL_TYPE.BASIC?t.ShaderLib.basic_vert:t.ShaderLib.pbr_vert,e.fragmentShader=i.replace(/void main\(/,(e=>`\n\t\t\t#if FEATURE_FADE\n\n\t\t\t// adapted from https://www.shadertoy.com/view/Mlt3z8\n\t\t\tfloat bayerDither2x2(vec2 v) {\n\t\t\t\treturn mod(3.0 * v.y + 2.0 * v.x, 4.0);\n\t\t\t}\n\n\t\t\tfloat bayerDither4x4(vec2 v) {\n\t\t\t\tvec2 P1 = mod(v, 2.0);\n\t\t\t\tvec2 P2 = floor(0.5 * mod(v, 4.0));\n\t\t\t\treturn 4.0 * bayerDither2x2(P1) + bayerDither2x2(P2);\n\t\t\t}\n\n\t\t\tuniform float fadeIn;\n\t\t\tuniform float fadeOut;\n\n\t\t\t#endif\n\n\t\t\t${e}\n\t\t`)).replace(/#include <end_frag>/,(e=>`\n\t\t\t${e}\n\n\t\t\t#if FEATURE_FADE\n\n\t\t\tfloat bayerValue = bayerDither4x4(floor(mod(gl_FragCoord.xy, 4.0)));\n\t\t\tfloat bayerBins = 16.0;\n\t\t\tfloat dither = (0.5 + bayerValue) / bayerBins;\n\t\t\tif (dither >= fadeIn) {\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tif (dither < fadeOut) {\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\t#endif\n\t\t`)),e.uniforms}(e))}}const Fs=Symbol("HAS_POPPED_IN"),Bs=new t.Vector3,Vs=new t.Vector3,Ns=new t.Quaternion,ks=new t.Quaternion,zs=new t.Vector3;function Gs(){const e=this._fadeManager,t=this.tiles;this._fadingBefore=e.fadeCount,this._displayActiveTiles=t.displayActiveTiles,t.displayActiveTiles=!0}function Hs(){const e=this._fadeManager,t=this._fadeMaterialManager,i=this._displayActiveTiles,s=this._fadingBefore,r=this._prevCameraTransforms,{tiles:n,maximumFadeOutTiles:o}=this,a=n.$cameras._cameras;n.displayActiveTiles=i,e.update();const l=e.fadeCount;if(0!==s&&0!==l&&(n.dispatchEvent({type:"fade-change"}),n.dispatchEvent({type:"needs-render"})),i||n.visibleTiles.forEach((e=>{const t=e.cached.scene;t&&(t.visible=e.__inFrustum)})),o<this._fadingOutCount){let t=!0;a.forEach((e=>{if(!r.has(e))return;const i=e.worldMatrix,s=r.get(e);i.decompose(Vs,ks,zs),s.decompose(Bs,Ns,zs);const n=ks.angleTo(Ns),o=Vs.distanceTo(Bs);t=t&&(n>.25||o>.1)})),t&&e.completeAllFades()}a.forEach((e=>{r.get(e).copy(e.worldMatrix)})),e.forEachObject(((i,{fadeIn:s,fadeOut:r})=>{const o=i.cached.scene,a=e.isFadingOut(i);n.markTileUsed(i),o&&(t.setFade(o,s,r),a&&(o.visible=!0))}))}class js{constructor(){this.creditsCount={}}_adjustAttributions(e,t){const i=this.creditsCount,s=e.split(/;/g);for(let e=0,r=s.length;e<r;e++){const r=s[e];r in i||(i[r]=0),i[r]+=t?1:-1,i[r]<=0&&delete i[r]}}addAttributions(e){this._adjustAttributions(e,!0)}removeAttributions(e){this._adjustAttributions(e,!1)}toString(){const e=Object.entries(this.creditsCount).sort(((e,t)=>{const i=e[1];return t[1]-i}));return e.map((e=>e[0])).join("; ")}}class Ks{constructor({apiToken:e,autoRefreshToken:t=!1,logoUrl:i=null,useRecommendedSettings:s=!0}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=e,this.autoRefreshToken=t,this.useRecommendedSettings=s,this.logoUrl=i,this.sessionToken=null,this.tiles=null,this._onLoadCallback=null,this._visibilityChangeCallback=null,this._tokenRefreshPromise=null,this._attributionsManager=new js,this._logoAttribution={value:"",type:"image",collapsible:!1},this._attribution={value:"",type:"string",collapsible:!0}}init(e){null!=e&&(e.resetFailedTiles(),null==e.rootURL&&(e.rootURL="https://tile.googleapis.com/v1/3dtiles/root.json"),this.useRecommendedSettings&&(e.$tilesLoader.parseQueue.maxJobs=10,e.$tilesLoader.downloadQueue.maxJobs=30,e.errorTarget=20),this.tiles=e,this._onLoadCallback=({tileSet:t})=>{this.sessionToken=$s(t.root),e.removeEventListener("load-tile-set",this._onLoadCallback)},this._visibilityChangeCallback=({tile:e,visible:t})=>{},e.addEventListener("load-tile-set",this._onLoadCallback),e.addEventListener("tile-visibility-change",this._visibilityChangeCallback))}getAttributions(e){this.tiles.visibleTiles.size>0&&(this.logoUrl&&(this._logoAttribution.value=this.logoUrl,e.push(this._logoAttribution)),this._attribution.value=this._attributionsManager.toString(),e.push(this._attribution))}preprocessURL(e){return e=new URL(e),/^http/.test(e.protocol)&&(e.searchParams.append("key",this.apiToken),null!==this.sessionToken&&e.searchParams.append("session",this.sessionToken)),e.toString()}dispose(){const{tiles:e}=this;e.removeEventListener("load-tile-set",this._onLoadCallback),e.removeEventListener("tile-visibility-change",this._visibilityChangeCallback)}async fetchData(e,t){null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,e=this.preprocessURL(e));const i=await fetch(e,t);return i.status>=400&&i.status<=499&&this.autoRefreshToken?(await this._refreshToken(t),fetch(this.preprocessURL(e),t)):i}_refreshToken(e){if(null===this._tokenRefreshPromise){const t=new URL(this.tiles.rootURL);t.searchParams.append("key",this.apiToken),this._tokenRefreshPromise=fetch(t,e).then((e=>e.json())).then((e=>{this.sessionToken=$s(e.root),this._tokenRefreshPromise=null})),this._tokenRefreshPromise.catch((e=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:e,url:t})}))}return this._tokenRefreshPromise}}function $s(e){let t=null;return ie(e,(e=>{if(e.content&&e.content.uri){const[,i]=e.content.uri.split("?");return t=new URLSearchParams(i).get("session"),!0}return!1})),t}class Xs extends t.Mesh{constructor(e,i=16776960){const s=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new t.Geometry;r.setIndex(new t.Attribute(new t.Buffer(s,1))),r.addAttribute("a_Position",new t.Attribute(new t.Buffer(new Float32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),3))),r.computeBoundingSphere();const n=new t.LineMaterial;n.diffuse.setHex(i),super(r,n),this.box=e}updateMatrix(e){const t=this.box;t.getCenter(this.position),t.isEmpty()?this.scale.multiplyScalar(0):(t.getSize(this.scale),this.scale.multiplyScalar(.5)),super.updateMatrix(e)}}Xs.prototype.isBox3Helper=!0;class qs extends t.Mesh{constructor(e,i=16776960,s=40){const r=[];for(let e=0;e<3;e++){const t=Qs[e],i=Qs[(e+1)%3];Zs.set(0,0,0);for(let e=0;e<s;e++){let n;n=2*Math.PI*e/(s-1),Zs[t]=Math.sin(n),Zs[i]=Math.cos(n),r.push(Zs.x,Zs.y,Zs.z),n=2*Math.PI*(e+1)/(s-1),Zs[t]=Math.sin(n),Zs[i]=Math.cos(n),r.push(Zs.x,Zs.y,Zs.z)}}const n=new t.Geometry;n.addAttribute("a_Position",new t.Attribute(new t.Buffer(new Float32Array(r),3))),n.computeBoundingSphere();const o=new t.LineMaterial;o.diffuse.setHex(i),super(n,o),this.sphere=e}updateMatrix(e){const t=this.sphere;this.position.copy(t.center),t.isEmpty()?this.scale.setScalar(0):this.scale.setScalar(t.radius),super.updateMatrix(e)}}qs.prototype.isSphereHelper=!0;const Zs=new t.Vector3,Qs=["x","y","z"];const Ws=Symbol("ORIGINAL_MATERIAL"),Ys=Symbol("HAS_RANDOM_COLOR"),Js=Symbol("HAS_RANDOM_NODE_COLOR"),er=Symbol("LOAD_TIME"),tr=Symbol("PARENT_BOUND_REF_COUNT"),ir=new t.Sphere,sr=()=>{},rr={};function nr(e){if(!rr[e]){const i=Math.random(),s=.5+.5*Math.random(),r=.375+.25*Math.random();rr[e]=(new t.Color3).setHSL(i,s,r)}return rr[e]}const or=0,ar=1,lr=2,cr=3,hr=4,dr=5,ur=6,pr=7,mr=8,fr=9,gr=10,_r=Object.freeze({NONE:or,SCREEN_ERROR:ar,GEOMETRIC_ERROR:lr,DISTANCE:cr,DEPTH:hr,RELATIVE_DEPTH:dr,IS_LEAF:ur,RANDOM_COLOR:pr,RANDOM_NODE_COLOR:mr,CUSTOM_COLOR:fr,LOAD_ORDER:gr});const br=new t.Sphere,yr=new t.Vector3;const xr=new t.Quaternion,Mr=new t.Vector3;let vr;t.Matrix4.prototype.makeScale||(t.Matrix4.prototype.makeScale=function(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1)}),t.Matrix4.prototype.makeBasis=function(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this},t.Matrix4.prototype.setPosition=function(e,t,i){const s=this.elements;return e.isVector3?(s[12]=e.x,s[13]=e.y,s[14]=e.z):(s[12]=e,s[13]=t,s[14]=i),this},t.Matrix4.prototype.makeRotationFromEuler=function(e){const t=this.elements,i=e.x,s=e.y,r=e.z,n=Math.cos(i),o=Math.sin(i),a=Math.cos(s),l=Math.sin(s),c=Math.cos(r),h=Math.sin(r);if("XYZ"===e.order){const e=n*c,i=n*h,s=o*c,r=o*h;t[0]=a*c,t[4]=-a*h,t[8]=l,t[1]=i+s*l,t[5]=e-r*l,t[9]=-o*a,t[2]=r-e*l,t[6]=s+i*l,t[10]=n*a}else if("YXZ"===e.order){const e=a*c,i=a*h,s=l*c,r=l*h;t[0]=e+r*o,t[4]=s*o-i,t[8]=n*l,t[1]=n*h,t[5]=n*c,t[9]=-o,t[2]=i*o-s,t[6]=r+e*o,t[10]=n*a}else if("ZXY"===e.order){const e=a*c,i=a*h,s=l*c,r=l*h;t[0]=e-r*o,t[4]=-n*h,t[8]=s+i*o,t[1]=i+s*o,t[5]=n*c,t[9]=r-e*o,t[2]=-n*l,t[6]=o,t[10]=n*a}else if("ZYX"===e.order){const e=n*c,i=n*h,s=o*c,r=o*h;t[0]=a*c,t[4]=s*l-i,t[8]=e*l+r,t[1]=a*h,t[5]=r*l+e,t[9]=i*l-s,t[2]=-l,t[6]=o*a,t[10]=n*a}else if("YZX"===e.order){const e=n*a,i=n*l,s=o*a,r=o*l;t[0]=a*c,t[4]=r-e*h,t[8]=s*h+i,t[1]=h,t[5]=n*c,t[9]=-o*c,t[2]=-l*c,t[6]=i*h+s,t[10]=e-r*h}else if("XZY"===e.order){const e=n*a,i=n*l,s=o*a,r=o*l;t[0]=a*c,t[4]=-h,t[8]=l*c,t[1]=e*h+r,t[5]=n*c,t[9]=i*h-s,t[2]=s*h-i,t[6]=o*c,t[10]=r*h+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},t.Matrix4.prototype.invert=function(){return this.getInverse(this)},t.Vector3.prototype.applyEuler=function(e){return this.applyQuaternion(xr.setFromEuler(e))},t.Vector3.prototype.applyAxisAngle=function(e,t){return this.applyQuaternion(xr.setFromAxisAngle(e,t))},t.Vector3.prototype.angleTo=function(e){const i=Math.sqrt(this.getLengthSquared()*e.getLengthSquared());if(0===i)return Math.PI/2;const s=this.dot(e)/i;return Math.acos(t.MathUtils.clamp(s,-1,1))},t.Vector3.prototype.isVector3=!0,t.Quaternion.prototype.angleTo=function(e){return 2*Math.acos(Math.abs(t.MathUtils.clamp(this.dot(e),-1,1)))},t.Quaternion.prototype.identity=function(){return this.set(0,0,0,1)},t.Quaternion.prototype.slerp||(t.Quaternion.prototype.slerp=function(e,t){return this.slerpQuaternions(this,e,t),this}),t.Object3D.prototype.removeFromParent=function(){const e=this.parent;return null!==e&&e.remove(this),this},t.Ray.prototype.closestPointToPoint=function(e,t){t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,i)},t.Ray.prototype.recast=function(e){return this.origin.copy(this.at(e,Mr)),this},t.MathUtils.mapLinear=function(e,t,i,s,r){return s+(e-t)*(r-s)/(i-t)},t.MathUtils.DEG2RAD=Math.PI/180,t.MathUtils.lerp=function(e,t,i){return e+(t-e)*i},vr=t.Camera.prototype.setOrtho,t.Camera.prototype.setOrtho=function(e,t,i,s,r,n){this.left=e,this.right=t,this.bottom=i,this.top=s,this.near=r,this.far=n,this.zoom=1,this.isPerspectiveCamera=!1,this.isOrthographicCamera=!0,vr.call(this,e,t,i,s,r,n)},vr=t.Camera.prototype.setPerspective,t.Camera.prototype.setPerspective=function(e,t,i,s){this.fov=e,this.aspect=t,this.near=i,this.far=s,this.isPerspectiveCamera=!0,this.isOrthographicCamera=!1,vr.call(this,e,t,i,s)},t.Camera.prototype.updateProjectionMatrix=function(){return this.isOrthographicCamera?this.setOrtho(this.left,this.right,this.bottom,this.top,this.near,this.far):this.isPerspectiveCamera&&this.setPerspective(this.fov,this.aspect,this.near,this.far),this},e.B3DMLoader=Tt,e.CMPTLoader=ti,e.CesiumIonAuthPlugin=class{constructor({apiToken:e,assetId:t=null,autoRefreshToken:i=!1,useRecommendedSettings:s=!0}){this.name="CESIUM_ION_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=e,this.assetId=t,this.autoRefreshToken=i,this.useRecommendedSettings=s,this.tiles=null,this.endpointURL=null,this._bearerToken=null,this._tileSetVersion=-1,this._tokenRefreshPromise=null,this._attributions=[],this._disposed=!1}init(e){null!==this.assetId&&(e.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=e,this.endpointURL=e.rootURL,e.resetFailedTiles()}loadRootTileSet(){return this._refreshToken().then((()=>this.tiles.invokeOnePlugin((e=>e!==this&&e.loadRootTileSet&&e.loadRootTileSet()))))}preprocessURL(e){return e=new URL(e),/^http/.test(e.protocol)&&-1!=this._tileSetVersion&&e.searchParams.append("v",this._tileSetVersion),e.toString()}fetchData(e,t){return null!==this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")?null:Promise.resolve().then((async()=>{null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,e=this.preprocessURL(e));const i=await fetch(e,t);return i.status>=400&&i.status<=499&&this.autoRefreshToken?(await this._refreshToken(t),fetch(this.preprocessURL(e),t)):i}))}getAttributions(e){this.tiles.visibleTiles.size>0&&e.push(...this._attributions)}_refreshToken(e){if(null===this._tokenRefreshPromise){const t=new URL(this.endpointURL);t.searchParams.append("access_token",this.apiToken),this._tokenRefreshPromise=fetch(t,e).then((e=>{if(this._disposed)return null;if(!e.ok)throw new Error(`CesiumIonAuthPlugin: Failed to load data with error code ${e.status}`);return e.json()})).then((e=>{if(this._disposed)return null;const i=this.tiles;if("externalType"in e){const t=new URL(e.options.url);i.rootURL=e.options.url,i.registerPlugin(new Ks({apiToken:t.searchParams.get("key"),autoRefreshToken:this.autoRefreshToken,useRecommendedSettings:this.useRecommendedSettings}))}else{if("TERRAIN"===e.type&&null===i.getPluginByName("QUANTIZED_MESH_PLUGIN")||"IMAGERY"===e.type&&i.getPluginByName("TMS_TILES_PLUGIN"),i.rootURL=e.url,i.fetchOptions.headers=i.fetchOptions.headers||{},i.fetchOptions.headers.Authorization=`Bearer ${e.accessToken}`,t.searchParams.has("v")&&-1===this._tileSetVersion){const t=new URL(e.url);this._tileSetVersion=t.searchParams.get("v")}this._bearerToken=e.accessToken,e.attributions&&(this._attributions=e.attributions.map((e=>({value:e.html,type:"html",collapsible:e.collapsible}))))}return this._tokenRefreshPromise=null,e})),this._tokenRefreshPromise.catch((e=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:e,url:t})}))}return this._tokenRefreshPromise}dispose(){this._disposed=!0}},e.DebugLoadParser=class{static parse(e,t){let i=null;return i="gltf"===te(e.url)?t.loadFile(e.url).then((t=>{e.options.buffer=t})):t.loadFile(e.url,"arraybuffer").then((t=>{e.options.buffer=t})),i}},e.DebugTilesPlugin=class{static get ColorModes(){return _r}constructor(e){e={displayParentBounds:!1,displayBoxBounds:!1,displaySphereBounds:!1,displayRegionBounds:!1,colorMode:or,maxDebugDepth:-1,maxDebugDistance:-1,maxDebugError:-1,customColorCallback:null,...e},this.name="DEBUG_TILES_PLUGIN",this.tiles=null,this._enabled=!0,this.extremeDebugDepth=-1,this.extremeDebugError=-1,this.boxGroup=null,this.sphereGroup=null,this.regionGroup=null,this._displayParentBounds=e.displayParentBounds,this.displayBoxBounds=e.displayBoxBounds,this.displaySphereBounds=e.displaySphereBounds,this.displayRegionBounds=e.displayRegionBounds,this.colorMode=e.colorMode,this.maxDebugDepth=e.maxDebugDepth,this.maxDebugDistance=e.maxDebugDistance,this.maxDebugError=e.maxDebugError,this.customColorCallback=e.customColorCallback,this.getDebugColor=(e,t)=>{t.setRGB(e,e,e)}}get enabled(){return this._enabled}set enabled(e){e!==this._enabled&&(this._enabled=e,this._enabled?this.tiles&&this.init(this.tiles):this.dispose())}get displayParentBounds(){return this._displayParentBounds}set displayParentBounds(e){this._displayParentBounds!==e&&(this._displayParentBounds=e,e?this.tiles.traverse((e=>{e.__visible&&this._onTileVisibilityChange(e,!0)})):ie(this.tiles.root,null,(e=>{e[tr]=null,this._onTileVisibilityChange(e,e.__visible)})))}init(e){this.tiles=e,this.boxGroup=new t.Object3D,this.boxGroup.name="DebugTilesPlugin.boxGroup",e.add(this.boxGroup),this.boxGroup.updateMatrix(),this.sphereGroup=new t.Object3D,this.sphereGroup.name="DebugTilesPlugin.sphereGroup",e.add(this.sphereGroup),this.sphereGroup.updateMatrix(),this.regionGroup=new t.Object3D,this.regionGroup.name="DebugTilesPlugin.regionGroup",e.add(this.regionGroup),this.regionGroup.updateMatrix(),this._onLoadTileSetCB=()=>{this._initExtremes()},this._onLoadModelCB=({scene:e,tile:t})=>{this._onLoadModel(e,t)},this._onDisposeModelCB=({tile:e})=>{this._onDisposeModel(e)},this._onUpdateAfterCB=()=>{this._onUpdateAfter()},this._onTileVisibilityChangeCB=({scene:e,tile:t,visible:i})=>{this._onTileVisibilityChange(t,i)},e.addEventListener("load-tile-set",this._onLoadTileSetCB),e.addEventListener("load-model",this._onLoadModelCB),e.addEventListener("dispose-model",this._onDisposeModelCB),e.addEventListener("update-after",this._onUpdateAfterCB),e.addEventListener("tile-visibility-change",this._onTileVisibilityChangeCB),this._initExtremes(),e.traverse((e=>{e.cached.scene&&this._onLoadModel(e.cached.scene,e)})),e.visibleTiles.forEach((e=>{this._onTileVisibilityChange(e,!0)}))}getTileInformationFromActiveObject(e){let t=null;return this.tiles.activeTiles.forEach((i=>{if(t)return!0;const s=i.cached.scene;s&&s.traverse((s=>{s===e&&(t=i)}))})),t?{distanceToCamera:t.__distanceFromCamera,geometricError:t.geometricError,screenSpaceError:t.__error,depth:t.__depth,isLeaf:t.__isLeaf}:null}_initExtremes(){if(!this.tiles||!this.tiles.root)return;let e=-1,t=-1;ie(this.tiles.root,null,((i,s,r)=>{e=Math.max(e,r),t=Math.max(t,i.geometricError)})),this.extremeDebugDepth=e,this.extremeDebugError=t}_onUpdateAfter(){const e=this.tiles;if(!e.root)return;this.boxGroup.visible=this.displayBoxBounds,this.sphereGroup.visible=this.displaySphereBounds,this.regionGroup.visible=this.displayRegionBounds;let i=-1;i=-1===this.maxDebugDepth?this.extremeDebugDepth:this.maxDebugDepth;let s=-1;s=-1===this.maxDebugError?this.extremeDebugError:this.maxDebugError;let r=-1;-1===this.maxDebugDistance?(e.getBoundingSphere(ir),r=ir.radius):r=this.maxDebugDistance;const n=e.errorTarget,o=this.colorMode,a=e.visibleTiles;let l;o===gr&&(l=Array.from(a).sort(((e,t)=>e[er]-t[er]))),a.forEach((e=>{const a=e.cached.scene;let c,h,d;o===pr&&(c=Math.random(),h=.5+.5*Math.random(),d=.375+.25*Math.random()),a.traverse((a=>{o===mr&&(c=Math.random(),h=.5+.5*Math.random(),d=.375+.25*Math.random());const u=a.material;if(u){const p=a[Ws];if(o===or&&u!==p)a.material.dispose(),a.material=a[Ws];else if(o!==or&&u===p)if(a.material.drawMode===t.DRAW_MODE.POINTS){const e=new t.PointsMaterial;e.size=p.size,e.sizeAttenuation=p.sizeAttenuation,a.material=e}else a.material.isInstancedPBRMaterial?(a.material=new Pt,a.material.metalness=0,a.material.roughness=1):a.material.isInstancedBasicMaterial?a.material=new Kt:(a.material=new t.PBRMaterial,a.material.metalness=0,a.material.roughness=1),a.material.shading=t.SHADING_TYPE.FLAT_SHADING,a.material.envMap=void 0;switch(o!==pr&&delete a.material[Ys],o!==mr&&delete a.material[Js],o){case hr:{const t=e.__depth/i;this.getDebugColor(t,a.material.diffuse);break}case dr:{const t=e.__depthFromRenderedParent/i;this.getDebugColor(t,a.material.diffuse);break}case ar:{const t=e.__error/n;t>1?a.material.diffuse.setRGB(1,0,0):this.getDebugColor(t,a.material.diffuse);break}case lr:{const t=Math.min(e.cached.geometricError/s,1);this.getDebugColor(t,a.material.diffuse);break}case cr:{const t=Math.min(e.__distanceFromCamera/r,1);this.getDebugColor(t,a.material.diffuse);break}case ur:e.children&&0!==e.children.length?this.getDebugColor(0,a.material.diffuse):this.getDebugColor(1,a.material.diffuse);break;case mr:a.material[Js]||(a.material.diffuse.setHSL(c,h,d),a.material[Js]=!0);break;case pr:a.material[Ys]||(a.material.diffuse.setHSL(c,h,d),a.material[Ys]=!0);break;case fr:this.customColorCallback?this.customColorCallback(e,a):console.warn("DebugTilesPlugin: customColorCallback not defined");break;case gr:{const t=l.indexOf(e);this.getDebugColor(t/(l.length-1),a.material.diffuse);break}}}}))}))}_onTileVisibilityChange(e,t){this.displayParentBounds?function(e,t=null){let i=e;for(;i;){const e=i.__depth,s=i.parent;t&&t(i,s,e),i=s}}(e,(i=>{null==i[tr]&&(i[tr]=0),t?i[tr]++:i[tr]>0&&i[tr]--;const s=i===e&&t||this.displayParentBounds&&i[tr]>0;this._updateBoundHelper(i,s)})):this._updateBoundHelper(e,t)}_createBoundHelper(e){const i=this.tiles,s=e.cached,{sphere:r,obb:n,region:o}=s.boundingVolume;if(n){const r=new t.Object3D;r.name="DebugTilesPlugin.boxHelperGroup",r.matrix.copy(n._originBoxTransform),r.matrixAutoUpdate=!1,r.matrixNeedsUpdate=!1;const o=new Xs(n._originBox,nr(e.__depth).getHex());o.raycast=sr,r.add(o),s.boxHelperGroup=r,i.visibleTiles.has(e)&&this.displayBoxBounds&&(this.boxGroup.add(r),r.updateMatrix(!0))}if(r){const t=new qs(r,nr(e.__depth).getHex());t.raycast=sr,s.sphereHelper=t,i.visibleTiles.has(e)&&this.displaySphereBounds&&(this.sphereGroup.add(t),t.updateMatrix(!0))}}_updateHelperMaterial(e,t){e.__visible||!this.displayParentBounds?t.opacity=1:t.opacity=.2,t.transparent=t.opacity<1}_updateBoundHelper(e,t){const i=e.cached;if(!i)return;const s=this.sphereGroup,r=this.boxGroup,n=this.regionGroup;t&&null==i.boxHelperGroup&&null==i.sphereHelper&&null==i.regionHelper&&this._createBoundHelper(e);const o=i.boxHelperGroup,a=i.sphereHelper,l=i.regionHelper;t?(o&&(r.add(o),o.updateMatrix(!0),this._updateHelperMaterial(e,o.children[0].material)),a&&(s.add(a),a.updateMatrix(!0),this._updateHelperMaterial(e,a.material)),l&&(n.add(l),l.updateMatrix(!0),this._updateHelperMaterial(e,l.material))):(o&&r.remove(o),a&&s.remove(a),l&&n.remove(l))}_onLoadModel(e,t){t[er]=performance.now(),e.traverse((e=>{const t=e.material;t&&(e[Ws]=t)}))}_onDisposeModel(e){const t=e.cached;t.boxHelperGroup&&(t.boxHelperGroup.children[0].geometry.dispose(),delete t.boxHelperGroup),t.sphereHelper&&(t.sphereHelper.geometry.dispose(),delete t.sphereHelper),t.regionHelper&&(t.regionHelper.geometry.dispose(),delete t.regionHelper)}dispose(){const e=this.tiles;e&&(e.removeEventListener("load-tile-set",this._onLoadTileSetCB),e.removeEventListener("load-model",this._onLoadModelCB),e.removeEventListener("dispose-model",this._onDisposeModelCB),e.removeEventListener("update-after",this._onUpdateAfterCB),e.removeEventListener("tile-visibility-change",this._onTileVisibilityChangeCB),this.colorMode=or,this._onUpdateAfter(),e.traverse((e=>{this._onDisposeModel(e)}))),this.boxGroup?.removeFromParent(),this.sphereGroup?.removeFromParent(),this.regionGroup?.removeFromParent()}},e.EnvironmentControls=_s,e.GlobeControls=class extends _s{get ellipsoid(){return this.tilesRenderer?this.tilesRenderer.ellipsoid:null}get tilesGroup(){return this.tilesRenderer?this.tilesRenderer:null}constructor(e=null,i=null,s=null,r=null){super(e,i,s),this.isGlobeControls=!0,this._dragMode=0,this._rotationMode=0,this.maxZoom=.01,this.nearMargin=.25,this.farMargin=0,this.useFallbackPlane=!1,this.reorientOnDrag=!1,this.globeInertia=new t.Quaternion,this.globeInertiaFactor=0,this.setTilesRenderer(r)}setScene(e){null===e&&null!==this.tilesRenderer?super.setScene(this.tilesRenderer):super.setScene(e)}getPivotPoint(e){const{camera:t,tilesGroup:i,ellipsoid:s}=this;return Ts.set(0,0,-1).transformDirection(t.worldMatrix),Ls.origin.copy(t.position),Ls.direction.copy(Ts),bs.copy(i.worldMatrix).invert(),Ls.applyMatrix4(bs),Ki(Ls,s,Ms),Ms.applyMatrix4(i.worldMatrix),(null===super.getPivotPoint(e)||e.distanceTo(Ls.origin)>Ms.distanceTo(Ls.origin))&&e.copy(Ms),e}getVectorToCenter(e){const{tilesGroup:t,camera:i}=this;return e.setFromMatrixPosition(t.worldMatrix).sub(i.position)}getDistanceToCenter(){return this.getVectorToCenter(Ms).getLength()}getUpDirection(e,t){const{tilesGroup:i,ellipsoid:s}=this;bs.copy(i.worldMatrix).invert(),Ms.copy(e).applyMatrix4(bs),s.getPositionToNormal(Ms,t),t.transformDirection(i.worldMatrix)}getCameraUpDirection(e){const{tilesGroup:t,ellipsoid:i,camera:s}=this;s.isOrthographicCamera?(this._getVirtualOrthoCameraPosition(Ms),bs.copy(t.worldMatrix).invert(),Ms.applyMatrix4(bs),i.getPositionToNormal(Ms,e),e.transformDirection(t.worldMatrix)):this.getUpDirection(s.position,e)}update(e=.064){if(!this.enabled||!this.tilesGroup||!this.camera||0===e)return;const{camera:t,pivotMesh:i}=this;this._isNearControls()?this.scaleZoomOrientationAtEdges=this.zoomDelta<0:(0!==this.state&&1!==this._dragMode&&1!==this._rotationMode&&(i.visible=!1),this.scaleZoomOrientationAtEdges=!1),super.update(e),this.adjustCamera(t)}adjustCamera(e){super.adjustCamera(e);const{tilesGroup:i,ellipsoid:s,nearMargin:r,farMargin:n}=this,o=Math.max(s.radius.x,s.radius.y,s.radius.z);if(e.isPerspectiveCamera){const a=Ms.setFromMatrixPosition(i.worldMatrix).sub(e.position).getLength(),l=r*o,c=t.MathUtils.clamp((a-o)/l,0,1),h=t.MathUtils.lerp(1,1e3,c);e.near=Math.max(h,a-o-l),bs.copy(i.worldMatrix).invert(),xs.copy(e.position).applyMatrix4(bs),s.getPositionToCartographic(xs,Ds);const d=Math.max(s.getPositionElevation(xs),400),u=s.calculateHorizonDistance(Ds.lat,d);e.far=2.5*u+.1+o*n,e.updateProjectionMatrix()}else{this._getVirtualOrthoCameraPosition(e.position,e),e.updateMatrix(),bs.copy(e.worldMatrix).invert(),Ms.setFromMatrixPosition(i.worldMatrix).applyMatrix4(bs);const t=-Ms.z;e.near=t-o*(1+r),e.far=t+.1+o*n,e.position.addScaledVector(Ts,e.near),e.far-=e.near,e.near=0,e.updateProjectionMatrix(),e.updateMatrix()}}resetState(){super.resetState(),this._dragMode=0,this._rotationMode=0}_updateInertia(e){super._updateInertia(e);const{globeInertia:t,enableDamping:i,dampingFactor:s,camera:r,cameraRadius:n,minDistance:o,inertiaTargetDistance:a,tilesGroup:l}=this;if(!this.enableDamping||this.inertiaStableFrames>1)return this.globeInertiaFactor=0,void this.globeInertia.identity();const c=Math.pow(2,-e/s),h=Math.max(r.near,n,o,a),d=25e-5;if(vs.setFromMatrixPosition(l.worldMatrix),0!==this.globeInertiaFactor){$i(Ls,Ms.set(0,0,-1),r),Ls.applyMatrix4(r.viewMatrix),Ls.direction.normalize(),Ls.recast(-Ls.direction.dot(Ls.origin)).at(h/Ls.direction.z,Ms),Ms.applyMatrix4(r.worldMatrix),$i(Ls,xs.set(d,d,-1),r),Ls.applyMatrix4(r.viewMatrix),Ls.direction.normalize(),Ls.recast(-Ls.direction.dot(Ls.origin)).at(h/Ls.direction.z,xs),xs.applyMatrix4(r.worldMatrix),Ms.sub(vs).normalize(),xs.sub(vs).normalize(),this.globeInertiaFactor*=c;const s=Ms.angleTo(xs)/e;(2*Math.acos(t.w)*this.globeInertiaFactor<s||!i)&&(this.globeInertiaFactor=0,t.identity())}0!==this.globeInertiaFactor&&(1!==t.w||0===t.x&&0===t.y&&0===t.z||(t.w=Math.min(t.w,1-1e-9)),vs.setFromMatrixPosition(l.worldMatrix),Ss.identity().slerp(t,this.globeInertiaFactor*e),Hi(vs,Ss,ys),r.worldMatrix.premultiply(ys),r.worldMatrix.decompose(r.position,r.quaternion,Ms))}_inertiaNeedsUpdate(){return super._inertiaNeedsUpdate()||0!==this.globeInertiaFactor}_updatePosition(e){if(1===this.state){0===this._dragMode&&(this._dragMode=this._isNearControls()?1:-1);const{raycaster:t,camera:i,pivotPoint:s,pointerTracker:r,domElement:n,tilesGroup:o}=this,a=xs,l=ws;r.getCenterPoint(Os),ji(Os.x,Os.y,n,Os),$i(t,Os,i),bs.copy(o.worldMatrix).invert(),t.ray.applyMatrix4(bs);const c=Ms.copy(s).applyMatrix4(bs).getLength();Rs.radius.setScalar(c),i.isPerspectiveCamera?Rs.intersectRay(t.ray,Ms)||function(e,t,i){const s=e.origin.getLength(),r=Math.acos(t/s);i.copy(e.origin).multiplyScalar(-1).normalize();const n=Gi.crossVectors(i,e.direction).normalize();i.multiplyScalar(-1).applyAxisAngle(n,-r).normalize().multiplyScalar(t)}(t.ray,c,Ms):Ki(t.ray,Rs,Ms),Ms.applyMatrix4(o.worldMatrix),vs.setFromMatrixPosition(o.worldMatrix),a.subVectors(s,vs).normalize(),l.subVectors(Ms,vs).normalize(),Ss.setFromUnitVectors(l,a),Hi(vs,Ss,ys),i.worldMatrix.premultiply(ys),i.worldMatrix.decompose(i.position,i.quaternion,Ms),r.getMoveDistance()/e<2*window.devicePixelRatio?this.inertiaStableFrames++:(this.globeInertia.copy(Ss),this.globeInertiaFactor=1/e,this.inertiaStableFrames=0)}this._alignCameraUp(this.up)}_updateRotation(...e){1===this._rotationMode||this._isNearControls()?(this._rotationMode=1,super._updateRotation(...e)):(this.pivotMesh.visible=!1,this._rotationMode=-1),this._alignCameraUp(this.up)}_updateZoom(){const{zoomDelta:e,ellipsoid:i,zoomSpeed:s,zoomPoint:r,camera:n,maxZoom:o,state:a}=this;if(3!==a&&0===e)return;this.rotationInertia.set(0,0),this.dragInertia.set(0,0,0),this.globeInertia.identity(),this.globeInertiaFactor=0;const l=t.MathUtils.clamp(t.MathUtils.mapLinear(Math.abs(e),0,20,0,1),0,1);if(this._isNearControls()||e>0){if(this._updateZoomDirection(),e<0&&(this.zoomPointSet||this._updateZoomPoint())){Ts.set(0,0,-1).transformDirection(n.worldMatrix).normalize(),Cs.copy(this.up).multiplyScalar(-1),this.getUpDirection(r,Ps);const e=t.MathUtils.clamp(t.MathUtils.mapLinear(-Ps.dot(Cs),1,.95,0,1),0,1),i=1-Ts.dot(Cs),s=n.isOrthographicCamera?.05:1,o=t.MathUtils.clamp(3*l,0,1),a=Math.min(e*i*s*o,.1);Cs.lerpVectors(Ts,Cs,a).normalize(),Ss.setFromUnitVectors(Ts,Cs),Hi(r,Ss,ys),n.worldMatrix.premultiply(ys),n.worldMatrix.decompose(n.position,n.quaternion,Cs),this.zoomDirection.subVectors(r,n.position).normalize()}super._updateZoom()}else if(n.isPerspectiveCamera){const r=this._getPerspectiveTransitionDistance(),n=this._getMaxPerspectiveDistance(),o=t.MathUtils.mapLinear(this.getDistanceToCenter(),r,n,0,1);this._tiltTowardsCenter(t.MathUtils.lerp(0,.4,o*l)),this._alignCameraUpToNorth(t.MathUtils.lerp(0,.2,o*l));const a=e*(this.getDistanceToCenter()-i.radius.x)*s*.0025,c=Math.max(a,Math.min(this.getDistanceToCenter()-n,0));this.getVectorToCenter(Ms).normalize(),this.camera.position.addScaledVector(Ms,c),this.camera.updateMatrix(),this.zoomDelta=0}else{const e=this._getOrthographicTransitionZoom(),i=this._getMinOrthographicZoom(),r=t.MathUtils.mapLinear(n.zoom,e,i,0,1);this._tiltTowardsCenter(t.MathUtils.lerp(0,.4,r*l)),this._alignCameraUpToNorth(t.MathUtils.lerp(0,.2,r*l));const a=this.zoomDelta,c=Math.pow(.95,Math.abs(.05*a)),h=a>0?1/Math.abs(c):c,d=i/n.zoom,u=Math.max(h*s,Math.min(d,1));n.zoom=Math.min(o,n.zoom*u),n.updateProjectionMatrix(),this.zoomDelta=0,this.zoomDirectionSet=!1}}_alignCameraUpToNorth(e){const{tilesGroup:t}=this;Es.set(0,0,1).transformDirection(t.worldMatrix),this._alignCameraUp(Es,e)}_alignCameraUp(e,i=null){const{camera:s}=this;Ts.set(0,0,-1).transformDirection(s.worldMatrix),As.set(-1,0,0).transformDirection(s.worldMatrix),ws.crossVectors(e,Ts),null===i&&(i=1-Math.abs(Ts.dot(e)),i=t.MathUtils.mapLinear(i,0,1,-.01,1),i=t.MathUtils.clamp(i,0,1)**2),ws.lerp(As,1-i).normalize(),Ss.setFromUnitVectors(As,ws),s.quaternion.premultiply(Ss),s.updateMatrix()}_tiltTowardsCenter(e){const{camera:t,tilesGroup:i}=this;Ts.set(0,0,-1).transformDirection(t.worldMatrix).normalize(),Ms.setFromMatrixPosition(i.worldMatrix).sub(t.position).normalize(),Ms.lerp(Ts,1-e).normalize(),Ss.setFromUnitVectors(Ts,Ms),t.quaternion.premultiply(Ss),t.updateMatrix()}_getPerspectiveTransitionDistance(){const{camera:e,ellipsoid:i}=this;if(!e.isPerspectiveCamera)throw new Error;const s=Math.max(i.radius.x,i.radius.y,i.radius.z),r=2*Math.atan(Math.tan(t.MathUtils.DEG2RAD*e.fov*.5)*e.aspect),n=s/Math.tan(t.MathUtils.DEG2RAD*e.fov*.5),o=s/Math.tan(.5*r);return Math.max(n,o)}_getMaxPerspectiveDistance(){const{camera:e,ellipsoid:i}=this;if(!e.isPerspectiveCamera)throw new Error;const s=Math.max(i.radius.x,i.radius.y,i.radius.z),r=2*Math.atan(Math.tan(t.MathUtils.DEG2RAD*e.fov*.5)*e.aspect),n=s/Math.tan(t.MathUtils.DEG2RAD*e.fov*.5),o=s/Math.tan(.5*r);return 2*Math.max(n,o)}_getOrthographicTransitionZoom(){const{camera:e,ellipsoid:t}=this;if(!e.isOrthographicCamera)throw new Error;const i=e.top-e.bottom,s=e.right-e.left;return 2*Math.max(i,s)/(2*Math.max(t.radius.x,t.radius.y,t.radius.z))}_getMinOrthographicZoom(){const{camera:e,ellipsoid:t}=this;if(!e.isOrthographicCamera)throw new Error;const i=e.top-e.bottom,s=e.right-e.left;return.7*Math.min(i,s)/(2*Math.max(t.radius.x,t.radius.y,t.radius.z))}_getVirtualOrthoCameraPosition(e,t=this.camera){const{tilesGroup:i,ellipsoid:s}=this;if(!t.isOrthographicCamera)throw new Error;Ls.origin.copy(t.position),Ls.direction.set(0,0,-1).transformDirection(t.worldMatrix),bs.copy(i.worldMatrix).invert(),Ls.applyMatrix4(bs),Ki(Ls,s,xs),xs.applyMatrix4(i.worldMatrix);const r=t.top-t.bottom,n=t.right-t.left,o=Math.max(r,n)/t.zoom;Ts.set(0,0,-1).transformDirection(t.worldMatrix);const a=xs.sub(t.position).dot(Ts);e.copy(t.position).addScaledVector(Ts,a-4*o)}_isNearControls(){const{camera:e}=this;return e.isPerspectiveCamera?this.getDistanceToCenter()<this._getPerspectiveTransitionDistance():e.zoom>this._getOrthographicTransitionZoom()}_raycast(e){const t=super._raycast(e);if(null===t){const{ellipsoid:t,tilesGroup:i}=this;bs.copy(i.worldMatrix).invert(),Ls.copy(e.ray).applyMatrix4(bs);const s=t.intersectRay(Ls,Ms);return null!==s?{point:s.clone().applyMatrix4(i.worldMatrix)}:null}return t}},e.I3DMLoader=Qt,e.InstancedBasicMaterial=Kt,e.InstancedPBRMaterial=Pt,e.OBB=i,e.PNTSLoader=Yt,e.ReorientationPlugin=class{constructor(e){e={up:"+z",recenter:!0,lat:null,lon:null,height:0,...e},this.tiles=null,this.up=e.up.toLowerCase().replace(/\s+/,""),this.lat=e.lat,this.lon=e.lon,this.height=e.height,this.recenter=e.recenter,this._callback=null}init(e){this.tiles=e,this._callback=()=>{const{up:t,lat:i,lon:s,height:r,recenter:n}=this;if(null!==i&&null!==s)this.transformLatLonHeightToOrigin(i,s,r);else{const{ellipsoid:i}=e,s=Math.min(i.radius.x,i.radius.y,i.radius.z);if(e.getBoundingSphere(br),br.center.getLength()>.5*s){const e={};i.getPositionToCartographic(br.center,e),this.transformLatLonHeightToOrigin(e.lat,e.lon,e.height)}else{switch(e.euler.set(0,0,0),t){case"x":case"+x":e.euler.z=Math.PI/2;break;case"-x":e.euler.z=-Math.PI/2;break;case"y":case"+y":break;case"-y":e.euler.z=Math.PI;break;case"z":case"+z":e.euler.x=-Math.PI/2;break;case"-z":e.euler.x=Math.PI/2}e.position.copy(br.center).applyEuler(e.euler).multiplyScalar(-1)}}n||e.position.setScalar(0),e.removeEventListener("load-tile-set",this._callback)},e.addEventListener("load-tile-set",this._callback)}transformLatLonHeightToOrigin(e,t,i=0){const s=this.tiles,{ellipsoid:r}=s;r.getRotationMatrixFromAzElRoll(e,t,0,0,0,s.matrix,F),r.getCartographicToPosition(e,t,i,yr),s.matrix.setPosition(yr).invert().decompose(s.position,s.quaternion,s.scale),s.updateMatrix()}dispose(){const e=this.tiles;e.position.setScalar(0),e.quaternion.identity(),e.scale.set(1,1,1),e.addEventListener("load-tile-set",this._callback)}},e.TileGLTFLoader=ri,e.Tiles3D=vi,e.TilesFadePlugin=class{get fadeDuration(){return this._fadeManager.duration}set fadeDuration(e){this._fadeManager.duration=Number(e)}get fadingTiles(){return this._fadeManager.fadeCount}constructor(e){e={maximumFadeOutTiles:50,fadeRootTiles:!1,fadeDuration:250,...e},this.name="FADE_TILES_PLUGIN",this.priority=-2,this.tiles=null,this.batchedMesh=null,this._fadeManager=new Is,this._fadeMaterialManager=new Us,this._prevCameraTransforms=null,this._fadingOutCount=0,this.maximumFadeOutTiles=e.maximumFadeOutTiles,this.fadeRootTiles=e.fadeRootTiles,this.fadeDuration=e.fadeDuration}init(e){this._onLoadModel=({scene:e})=>{this._fadeMaterialManager.prepareScene(e)},this._onDisposeModel=({tile:e,scene:t})=>{this._fadeManager.deleteObject(e),this._fadeMaterialManager.deleteScene(t)},this._onAddCamera=({camera:e})=>{this._prevCameraTransforms.set(e,new t.Matrix4)},this._onDeleteCamera=({camera:e})=>{this._prevCameraTransforms.delete(e)},this._onTileVisibilityChange=({tile:e,visible:t})=>{const i=e.cached.scene;i&&(i.visible=!0)},this._onUpdateBefore=()=>{Gs.call(this)},this._onUpdateAfter=()=>{Hs.call(this)},e.addEventListener("load-model",this._onLoadModel),e.addEventListener("dispose-model",this._onDisposeModel),e.addEventListener("add-camera",this._onAddCamera),e.addEventListener("delete-camera",this._onDeleteCamera),e.addEventListener("update-before",this._onUpdateBefore),e.addEventListener("update-after",this._onUpdateAfter),e.addEventListener("tile-visibility-change",this._onTileVisibilityChange);const i=this._fadeManager;i.onFadeSetStart=()=>{e.dispatchEvent({type:"fade-start"}),e.dispatchEvent({type:"needs-render"})},i.onFadeSetComplete=()=>{e.dispatchEvent({type:"fade-end"}),e.dispatchEvent({type:"needs-render"})},i.onFadeComplete=(t,i)=>{this._fadeMaterialManager.setFade(t.cached.scene,0,0),i||(e.invokeOnePlugin((e=>e!==this&&e.setTileVisible&&e.setTileVisible(t,!1))),this._fadingOutCount--)};const s=new Map;e.$cameras._cameras.forEach((e=>{s.set(e,new t.Matrix4)})),e.forEachLoadedModel(((e,t)=>{this._onLoadModel({scene:e})})),this.tiles=e,this._fadeManager=i,this._prevCameraTransforms=s}setTileVisible(e,t){const i=this._fadeManager,s=i.isFading(e);if(i.isFadingOut(e)&&this._fadingOutCount--,t){1===e.__depthFromRenderedParent?((e[Fs]||this.fadeRootTiles)&&this._fadeManager.fadeIn(e),e[Fs]=!0):this._fadeManager.fadeIn(e)}else this._fadingOutCount++,i.fadeOut(e);if(s)return!0;const r=this._fadeManager.isFading(e);return!(t||!r)}dispose(){const e=this.tiles;this._fadeManager.completeAllFades(),null!==this.batchedMesh&&this._onBatchedMeshDispose(),e.removeEventListener("load-model",this._onLoadModel),e.removeEventListener("dispose-model",this._onDisposeModel),e.removeEventListener("add-camera",this._onAddCamera),e.removeEventListener("delete-camera",this._onDeleteCamera),e.removeEventListener("update-before",this._onUpdateBefore),e.removeEventListener("update-after",this._onUpdateAfter),e.removeEventListener("tile-visibility-change",this._onTileVisibilityChange),e.forEachLoadedModel(((e,t)=>{this._fadeManager.deleteObject(t),e&&(e.visible=!0)}))}}}));
